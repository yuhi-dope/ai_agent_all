<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="page_title">Develop Agent - ダッシュボード</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: sans-serif; margin: 0; padding: 0; color: #333; }
    h1 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    h2 { font-size: 1rem; margin-top: 1.5rem; border-bottom: 1px solid #ccc; padding-bottom: 0.25rem; }
    h3 { font-size: 0.95rem; margin-top: 1.2rem; }
    section { margin: 1rem 0; }

    /* Auth */
    .auth-bar { display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem; color: #666; }
    .auth-bar button { padding: 0.3rem 0.75rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; font-size: 0.8rem; }
    .auth-bar button:hover { background: #f5f5f5; }
    #login-screen { max-width: 400px; margin: 4rem auto; text-align: center; padding: 0 1rem; }
    #login-screen h2 { border: none; }
    #login-screen input { width: 100%; padding: 0.6rem; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem; }
    #login-screen button { padding: 0.6rem 1.5rem; background: #2196f3; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95rem; }
    #login-screen button:disabled { background: #90caf9; cursor: not-allowed; }
    #login-screen .login-msg { margin-top: 0.75rem; font-size: 0.85rem; min-height: 1.2em; }
    #login-screen .login-msg.error { color: #c62828; }
    #login-screen .login-msg.success { color: #2e7d32; }

    /* Settings */
    .setting-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: #f8f9fa; border-radius: 6px; }
    .toggle { position: relative; width: 48px; height: 26px; cursor: pointer; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle .slider { position: absolute; inset: 0; background: #ccc; border-radius: 26px; transition: 0.3s; }
    .toggle .slider::before { content: ''; position: absolute; width: 20px; height: 20px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; }
    .toggle input:checked + .slider { background: #2196f3; }
    .toggle input:checked + .slider::before { transform: translateX(22px); }
    .toggle-label { font-size: 0.9rem; }

    /* Status filter */
    .status-filters { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .status-filter { padding: 0.3rem 0.75rem; border: 1px solid #ddd; border-radius: 16px; font-size: 0.8rem; cursor: pointer; background: #fff; }
    .status-filter.active { background: #2196f3; color: #fff; border-color: #2196f3; }

    /* Runs list */
    .runs-list { list-style: none; padding: 0; }
    .runs-list li { padding: 0.6rem 0.75rem; border: 1px solid #eee; margin: 0.25rem 0; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; }
    .runs-list li:hover { background: #f5f5f5; }
    .runs-list li.selected { background: #e3f2fd; border-color: #2196f3; }
    .runs-list li.status-spec_review { border-left: 4px solid #ff9800; }
    .runs-list li.status-published { border-left: 4px solid #4caf50; }
    .runs-list li.status-failed, .runs-list li.status-timeout { border-left: 4px solid #c62828; }
    .runs-list li.status-coding, .runs-list li.status-review_ok, .runs-list li.status-review_ng { border-left: 4px solid #2196f3; }
    .run-info { flex: 1; min-width: 0; }
    .run-info .run-title { font-weight: bold; font-size: 0.9rem; }
    .run-info .run-desc { font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Status badge */
    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; color: #fff; font-weight: bold; white-space: nowrap; }
    .badge-started { background: #90a4ae; }
    .badge-spec_review { background: #ff9800; }
    .badge-coding, .badge-review_ok, .badge-review_ng { background: #2196f3; }
    .badge-published { background: #4caf50; }
    .badge-failed, .badge-timeout { background: #c62828; }

    /* Detail */
    .detail { background: #fafafa; padding: 1rem; border-radius: 6px; font-size: 0.9rem; }
    .spec-preview { white-space: pre-wrap; background: #f8f8f8; padding: 1rem; border-radius: 4px; max-height: 450px; overflow-y: auto; font-size: 0.85rem; line-height: 1.5; border: 1px solid #e0e0e0; }
    .btn-implement { margin: 1rem 0; padding: 0.7rem 2rem; background: #ff9800; color: #fff; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; }
    .btn-implement:hover { background: #f57c00; }
    .btn-implement:disabled { background: #bbb; cursor: not-allowed; }

    /* Suggestion */
    .suggestion { background: #f0f7ff; padding: 1rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.9rem; }
    .meta { color: #666; font-size: 0.8rem; }
    .error { color: #c62828; }
    .empty-msg { color: #999; font-style: italic; }

    /* Language switcher */
    .lang-switcher { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; }
    .lang-switcher select { padding: 0.2rem 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }

    /* Company setup */
    #company-setup { max-width: 480px; margin: 4rem auto; text-align: center; padding: 0 1rem; }
    #company-setup h2 { border: none; font-size: 1.2rem; }
    #company-setup .setup-tabs { display: flex; gap: 0.5rem; justify-content: center; margin: 1rem 0; }
    #company-setup .setup-tab { padding: 0.4rem 1rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem; background: #fff; }
    #company-setup .setup-tab.active { background: #2196f3; color: #fff; border-color: #2196f3; }
    #company-setup input { width: 100%; padding: 0.6rem; margin: 0.4rem 0; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem; }
    #company-setup button.setup-btn { padding: 0.6rem 1.5rem; background: #2196f3; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95rem; margin-top: 0.5rem; }
    #company-setup button.setup-btn:disabled { background: #90caf9; cursor: not-allowed; }
    #company-setup .setup-msg { margin-top: 0.75rem; font-size: 0.85rem; min-height: 1.2em; }
    #company-setup .setup-msg.error { color: #c62828; }
    #company-setup .setup-msg.success { color: #2e7d32; }

    /* Autocomplete */
    .ac-wrapper { position: relative; }
    .ac-list { position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background: #fff; border: 1px solid #ddd; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
    .ac-list.show { display: block; }
    .ac-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:hover, .ac-item.active { background: #e3f2fd; }
    .ac-item .ac-name { font-weight: 600; }
    .ac-item .ac-addr { font-size: 0.75rem; color: #888; display: block; margin-top: 2px; }
    .ac-item .ac-slug { font-size: 0.75rem; color: #888; margin-left: 0.5rem; }
    .selected-addr { font-size: 0.75rem; color: #999; margin-top: 0.2rem; padding-left: 0.2rem; min-height: 1rem; }

    /* Select fields in company setup */
    #company-setup select { width: 100%; padding: 0.6rem; margin: 0.4rem 0; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem; background: #fff; }
    #company-setup .field-group { text-align: left; margin-top: 0.6rem; }
    #company-setup .field-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 0.2rem; }

    /* Onboarding */
    .onboarding { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; }
    .onboarding-progress { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
    .onboarding-progress .progress-bar { flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .onboarding-progress .progress-fill { height: 100%; background: #4caf50; border-radius: 4px; transition: width 0.3s; }
    .onboarding-progress .progress-text { font-size: 0.8rem; color: #666; white-space: nowrap; }
    .ob-step { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.6rem 0; border-bottom: 1px solid #f0f0f0; }
    .ob-step:last-child { border-bottom: none; }
    .ob-step input[type="checkbox"] { margin-top: 3px; width: 18px; height: 18px; cursor: pointer; accent-color: #4caf50; }
    .ob-step .ob-info { flex: 1; }
    .ob-step .ob-title { font-size: 0.9rem; font-weight: 600; color: #333; }
    .ob-step .ob-desc { font-size: 0.8rem; color: #888; margin-top: 2px; }
    .ob-step .ob-cmd { font-size: 0.75rem; font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; margin-top: 4px; display: inline-block; color: #555; }
    .ob-step.done .ob-title { color: #999; text-decoration: line-through; }
    .ob-complete { text-align: center; padding: 1.5rem; color: #4caf50; font-weight: bold; font-size: 1rem; }

    /* Company profile step */
    .ob-profile { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .ob-profile h3 { font-size: 0.95rem; margin: 0 0 0.75rem 0; color: #333; }
    .ob-profile .profile-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .ob-profile .profile-row label { font-size: 0.85rem; font-weight: 600; min-width: 80px; }
    .ob-profile select { flex: 1; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; background: #fff; }
    .ob-profile .profile-save { margin-top: 0.5rem; padding: 0.4rem 1.2rem; background: #2196f3; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .ob-profile .profile-save:disabled { background: #90caf9; cursor: not-allowed; }
    .ob-profile .profile-msg { font-size: 0.8rem; margin-top: 0.3rem; min-height: 1em; }
    .ob-profile.done { border-color: #4caf50; background: #f0faf0; }
    .ob-profile.done h3 { color: #4caf50; }

    /* Infra settings */
    .ob-infra { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    .ob-infra h3 { font-size: 0.95rem; margin: 0 0 0.25rem 0; color: #333; }
    .ob-infra .infra-desc { font-size: 0.8rem; color: #888; margin-bottom: 0.75rem; }
    .ob-infra .infra-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .ob-infra .infra-row label { font-size: 0.85rem; font-weight: 600; min-width: 160px; white-space: nowrap; }
    .ob-infra .infra-row .infra-val { flex: 1; padding: 0.4rem 0.5rem; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.85rem; font-family: monospace; background: #f0f0f0; color: #333; min-height: 1.8em; }
    .ob-infra .infra-row .infra-val.empty { color: #bbb; font-style: italic; font-family: sans-serif; }
    .ob-infra .infra-row .infra-val.set { border-color: #4caf50; background: #f0faf0; }

    /* ===== Sidebar Layout ===== */
    .sidebar {
      width: 220px; min-height: 100vh; background: #1a1a2e; color: #e0e0e0;
      display: flex; flex-direction: column; position: fixed; top: 0; left: 0; z-index: 1000;
      transition: transform 0.3s ease;
    }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-title { font-size: 1rem; margin: 0; color: #fff; font-weight: bold; }
    .sidebar-close { display: none; background: none; border: none; color: #e0e0e0; font-size: 1.5rem; cursor: pointer; }
    .sidebar-nav { list-style: none; padding: 0; margin: 0; }
    .sidebar-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.85rem 1rem; cursor: pointer; transition: background 0.2s; border-left: 3px solid transparent; }
    .sidebar-item:hover { background: rgba(255,255,255,0.08); }
    .sidebar-item.active { background: rgba(33,150,243,0.15); border-left-color: #2196f3; color: #fff; }
    .sidebar-icon { font-size: 1.1rem; width: 24px; text-align: center; }
    .sidebar-label { font-size: 0.9rem; }

    .main-content { margin-left: 220px; flex: 1; padding: 0 1.5rem 2rem 1.5rem; max-width: 900px; }
    .topbar { display: flex; align-items: center; justify-content: flex-end; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid #eee; margin-bottom: 1rem; }
    .hamburger { display: none; background: none; border: 1px solid #ccc; border-radius: 4px; font-size: 1.2rem; padding: 0.3rem 0.6rem; cursor: pointer; margin-right: auto; }
    .content-panel { display: none; }
    .content-panel.active { display: block; }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999; }

    /* Company info (settings panel) */
    .company-info-card { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; }
    .company-info-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .company-info-row label { font-weight: 600; min-width: 100px; font-size: 0.85rem; color: #555; }
    .company-info-row .ci-val { font-size: 0.9rem; }
    .company-info-row .ci-val.mono { font-family: monospace; }

    /* Member list */
    .member-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid #f0f0f0; }
    .member-row .member-id { flex: 1; font-size: 0.85rem; font-family: monospace; color: #555; }
    .member-row .member-role { font-size: 0.8rem; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; }
    .member-row .member-remove { font-size: 0.8rem; color: #c62828; background: none; border: 1px solid #c62828; border-radius: 4px; padding: 2px 8px; cursor: pointer; }
    .member-row .member-remove:hover { background: #c62828; color: #fff; }

    /* Invite */
    .invite-box { margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0; }
    .invite-url { font-family: monospace; font-size: 0.8rem; background: #fff; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; word-break: break-all; margin: 0.5rem 0; user-select: all; }
    .invite-box button { padding: 0.5rem 1rem; background: #2196f3; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .invite-box button:hover { background: #1976d2; }
    .invite-box button:disabled { background: #90caf9; cursor: not-allowed; }
    .invite-box .invite-msg { font-size: 0.8rem; margin-top: 0.5rem; min-height: 1em; }

    /* Onboarding connection cards */
    .ob-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #fff; }
    .ob-card.connected { border-color: #4caf50; background: #f1f8e9; }
    .ob-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .ob-card-header h4 { margin: 0; font-size: 0.95rem; }
    .ob-card-status { font-size: 0.8rem; font-weight: bold; }
    .ob-card-status.done { color: #4caf50; }
    .ob-card-status.pending { color: #999; }
    .ob-card-steps { font-size: 0.85rem; color: #666; margin: 0.25rem 0; }
    .ob-card-steps .step-done { color: #4caf50; }
    .ob-card-steps .step-pending { color: #bbb; }
    .ob-card-result { font-size: 0.8rem; font-family: monospace; background: #f0faf0; padding: 0.4rem 0.6rem; border-radius: 4px; margin-top: 0.5rem; color: #2e7d32; word-break: break-all; }
    .ob-result-link { color: #1976d2; text-decoration: none; }
    .ob-result-link:hover { text-decoration: underline; }
    .ob-token-input { display: flex; gap: 0.5rem; margin: 0.5rem 0; align-items: center; }
    .ob-token-input input { flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; font-family: monospace; }
    .ob-card-btn { padding: 0.5rem 1.2rem; background: #2196f3; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; white-space: nowrap; }
    .ob-card-btn:hover { background: #1976d2; }
    .ob-card-btn:disabled { background: #90caf9; cursor: not-allowed; }
    .ob-card-btn.github-btn { background: #24292e; }
    .ob-card-btn.github-btn:hover { background: #1b1f23; }
    .ob-card-btn.supabase-btn { background: #3ecf8e; color: #1a1a2e; }
    .ob-card-btn.supabase-btn:hover { background: #30b577; }
    .ob-card-btn.vercel-btn { background: #000; }
    .ob-card-btn.vercel-btn:hover { background: #333; }
    .ob-card-msg { font-size: 0.8rem; margin-top: 0.4rem; min-height: 1.2em; }
    .ob-card-msg.error { color: #c62828; }
    .ob-card-msg.success { color: #2e7d32; }
    .ob-card-help { font-size: 0.75rem; color: #888; margin-top: 0.3rem; }
    .ob-card-help a { color: #2196f3; text-decoration: none; }
    .ob-card-help a:hover { text-decoration: underline; }
    .ob-spinner-inline { display: inline-block; width: 16px; height: 16px; border: 2px solid #ccc; border-top-color: #2196f3; border-radius: 50%; animation: ob-spin 0.8s linear infinite; vertical-align: middle; margin-right: 0.4rem; }
    @keyframes ob-spin { to { transform: rotate(360deg); } }

    /* Setup accordion sections */
    .setup-section { border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 0.75rem; background: #fff; overflow: hidden; }
    .setup-section-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; cursor: pointer; user-select: none; background: #f8f9fa; transition: background 0.2s; }
    .setup-section-header:hover { background: #eef1f5; }
    .setup-section-title { font-size: 0.95rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
    .setup-section-title .section-icon { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 6px; font-size: 0.9rem; color: #fff; }
    .section-icon.icon-infra { background: #5c6bc0; }
    .section-icon.icon-saas { background: #26a69a; }
    .section-icon.icon-settings { background: #78909c; }
    .setup-section-badge { font-size: 0.75rem; padding: 0.15rem 0.5rem; border-radius: 10px; background: #e0e0e0; color: #666; }
    .setup-section-badge.ok { background: #e8f5e9; color: #2e7d32; }
    .setup-section-chevron { font-size: 0.8rem; color: #999; transition: transform 0.25s ease; }
    .setup-section.open .setup-section-chevron { transform: rotate(180deg); }
    .setup-section-body { max-height: 0; overflow: hidden; transition: max-height 0.35s ease; }
    .setup-section.open .setup-section-body { max-height: 5000px; }
    .setup-section-inner { padding: 0 1rem 1rem 1rem; }

    /* Integrations panel */
    .int-section { margin-bottom: 2rem; }
    .int-section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.4rem; border-bottom: 2px solid #e0e0e0; }
    .int-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
    .int-card.connected { border-left: 4px solid #4caf50; }
    .int-card.disconnected { border-left: 4px solid #ccc; }
    .int-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .int-card-title { font-weight: 600; font-size: 1rem; }
    .int-badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
    .int-badge.ok { background: #e8f5e9; color: #2e7d32; }
    .int-badge.ng { background: #f5f5f5; color: #999; }
    .int-badge.env-ok { background: #e3f2fd; color: #1565c0; }
    .int-url { display: block; font-family: monospace; font-size: 0.8rem; margin: 0.3rem 0; word-break: break-all; }
    .int-url a { color: #1976d2; text-decoration: none; }
    .int-url a:hover { text-decoration: underline; }
    .int-steps { margin-top: 0.5rem; font-size: 0.85rem; color: #555; }
    .int-steps-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 0.3rem; color: #333; }
    .int-steps ol { margin: 0.3rem 0 0 1.2rem; padding: 0; }
    .int-steps li { margin-bottom: 0.3rem; line-height: 1.5; }
    .int-steps code { background: #f5f5f5; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.8rem; }
    .int-steps a, .int-card a { color: #1976d2; text-decoration: none; }
    .int-steps a:hover, .int-card a:hover { text-decoration: underline; }
    .int-connect-btn { padding: 0.4rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #fff; background: #1976d2; margin-top: 0.5rem; }
    .int-connect-btn.notion { background: #000; }
    .int-connect-btn.slack { background: #4a154b; }
    .int-connect-btn.gdrive { background: #1a73e8; }
    .int-connect-btn.chatwork { background: #e23636; }
    .int-connect-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .int-token-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; align-items: center; }
    .int-token-row input { flex: 1; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; font-family: monospace; }
    .int-env-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .int-env-table th { text-align: left; padding: 0.5rem 0.6rem; background: #f5f5f5; border-bottom: 2px solid #ddd; }
    .int-env-table td { padding: 0.4rem 0.6rem; border-bottom: 1px solid #eee; }
    .int-env-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.4rem; }
    .int-env-dot.set { background: #4caf50; }
    .int-env-dot.unset { background: #ccc; }

    /* SaaS connection cards */
    .saas-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
    .saas-card.connected { border-left: 4px solid #4caf50; }
    .saas-card.disconnected { border-left: 4px solid #ccc; }
    .saas-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .saas-card-title { font-weight: 600; font-size: 1rem; }
    .saas-card-genre { font-size: 0.75rem; color: #888; margin-left: 0.5rem; }
    .saas-config-form { margin-top: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; }
    .saas-config-form input { width: 100%; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; font-family: monospace; margin: 0.25rem 0; }
    .saas-config-form label { font-size: 0.8rem; font-weight: 600; display: block; margin-top: 0.4rem; }
    .saas-config-form .saas-btn { padding: 0.4rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #fff; margin-top: 0.5rem; margin-right: 0.5rem; }
    .saas-config-form .saas-btn.save { background: #2196f3; }
    .saas-config-form .saas-btn.save:hover { background: #1976d2; }
    .saas-config-form .saas-btn.connect { background: #ff9800; }
    .saas-config-form .saas-btn.connect:hover { background: #f57c00; }
    .saas-config-form .saas-btn:disabled { background: #bbb; cursor: not-allowed; }
    .saas-card .saas-btn.disconnect { padding: 0.3rem 0.8rem; background: none; border: 1px solid #c62828; color: #c62828; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    .saas-card .saas-btn.disconnect:hover { background: #c62828; color: #fff; }
    .saas-card-msg { font-size: 0.8rem; margin-top: 0.4rem; min-height: 1.2em; }
    .saas-guide-toggle { display: inline-flex; align-items: center; gap: 0.3rem; background: none; border: 1px solid #ddd; border-radius: 4px; padding: 0.25rem 0.6rem; font-size: 0.8rem; color: #1976d2; cursor: pointer; margin-top: 0.5rem; }
    .saas-guide-toggle:hover { background: #e3f2fd; border-color: #90caf9; }
    .saas-guide-toggle .chevron { font-size: 0.65rem; transition: transform 0.2s; }
    .saas-guide-toggle.open .chevron { transform: rotate(180deg); }
    .saas-guide-body { max-height: 0; overflow: hidden; transition: max-height 0.35s ease; }
    .saas-guide-body.open { max-height: 2000px; }
    .saas-guide-content { margin-top: 0.5rem; padding: 0.75rem; background: #f8fafe; border: 1px solid #e3ecf6; border-radius: 6px; font-size: 0.82rem; line-height: 1.7; color: #444; }
    .saas-guide-content ol { margin: 0; padding-left: 1.4rem; }
    .saas-guide-content li { margin-bottom: 0.4rem; }
    .saas-guide-content code { background: #eef2f7; padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.78rem; word-break: break-all; }
    .saas-guide-content a { color: #1976d2; text-decoration: none; }
    .saas-guide-content a:hover { text-decoration: underline; }

    /* BPO AI Employee */
    .bpo-input-area { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .bpo-input-row { display: flex; gap: 0.5rem; align-items: flex-start; flex-wrap: wrap; }
    .bpo-input-row select { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; min-width: 140px; }
    .bpo-input-row textarea { flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; resize: vertical; min-height: 80px; font-family: inherit; line-height: 1.5; }
    .bpo-input-row .bpo-submit { padding: 0.5rem 1.2rem; background: #2196f3; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; }
    .bpo-input-row .bpo-submit:hover { background: #1976d2; }
    .bpo-input-row .bpo-submit:disabled { background: #90caf9; cursor: not-allowed; }
    .bpo-dryrun-row { margin-top: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.4rem; }
    .bpo-status-filters { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .bpo-status-filters button { padding: 0.3rem 0.75rem; border: 1px solid #ddd; border-radius: 16px; font-size: 0.8rem; cursor: pointer; background: #fff; }
    .bpo-status-filters button.active { background: #2196f3; color: #fff; border-color: #2196f3; }
    .bpo-task-list { list-style: none; padding: 0; }
    .bpo-task-list li { padding: 0.6rem 0.75rem; border: 1px solid #eee; margin: 0.25rem 0; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; }
    .bpo-task-list li:hover { background: #f5f5f5; }
    .bpo-task-list li.selected { background: #e3f2fd; border-color: #2196f3; }
    .bpo-task-list li.bpo-planning { border-left: 4px solid #90a4ae; }
    .bpo-task-list li.bpo-awaiting_approval { border-left: 4px solid #ff9800; }
    .bpo-task-list li.bpo-executing { border-left: 4px solid #2196f3; }
    .bpo-task-list li.bpo-completed { border-left: 4px solid #4caf50; }
    .bpo-task-list li.bpo-failed { border-left: 4px solid #c62828; }
    .bpo-task-list li.bpo-rejected { border-left: 4px solid #9e9e9e; }
    .bpo-task-info { flex: 1; min-width: 0; }
    .bpo-task-info .bpo-task-title { font-weight: bold; font-size: 0.9rem; }
    .bpo-task-info .bpo-task-desc { font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .bpo-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; color: #fff; font-weight: bold; white-space: nowrap; }
    .bpo-badge-planning { background: #90a4ae; }
    .bpo-badge-awaiting_approval { background: #ff9800; }
    .bpo-badge-executing { background: #2196f3; }
    .bpo-badge-completed { background: #4caf50; }
    .bpo-badge-failed { background: #c62828; }
    .bpo-badge-rejected { background: #9e9e9e; }
    .bpo-detail { background: #fafafa; padding: 1rem; border-radius: 6px; font-size: 0.9rem; }
    .bpo-plan-preview { white-space: pre-wrap; background: #f8f8f8; padding: 1rem; border-radius: 4px; max-height: 400px; overflow-y: auto; font-size: 0.85rem; line-height: 1.5; border: 1px solid #e0e0e0; }
    .bpo-actions { display: flex; gap: 0.75rem; margin: 1rem 0; }
    .bpo-btn-approve { padding: 0.6rem 1.5rem; background: #ff9800; color: #fff; border: none; border-radius: 6px; font-size: 0.95rem; cursor: pointer; font-weight: bold; }
    .bpo-btn-approve:hover { background: #f57c00; }
    .bpo-btn-approve:disabled { background: #bbb; cursor: not-allowed; }
    .bpo-btn-reject { padding: 0.6rem 1.5rem; background: #fff; color: #c62828; border: 1px solid #c62828; border-radius: 6px; font-size: 0.95rem; cursor: pointer; }
    .bpo-btn-reject:hover { background: #ffebee; }
    .bpo-btn-reject:disabled { background: #eee; cursor: not-allowed; color: #999; border-color: #ccc; }
    .bpo-result-summary { background: #f0f7ff; padding: 1rem; border-radius: 6px; margin-top: 0.5rem; }
    .bpo-summary-stat { display: flex; gap: 1rem; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .bpo-summary-stat .success { color: #2e7d32; font-weight: bold; }
    .bpo-summary-stat .failure { color: #c62828; font-weight: bold; }
    .bpo-dashboard-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
    .bpo-summary-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 0.75rem; text-align: center; }
    .bpo-summary-card .num { font-size: 1.5rem; font-weight: bold; color: #333; }
    .bpo-summary-card .label { font-size: 0.75rem; color: #888; margin-top: 0.25rem; }

    /* Responsive: Mobile */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .sidebar-close { display: block; }
      .sidebar-overlay.active { display: block; }
      .main-content { margin-left: 0; padding: 0 1rem 2rem 1rem; }
      .hamburger { display: block; }
    }
  </style>
</head>
<body>

  <!-- ===== Login Screen ===== -->
  <div id="login-screen" style="display:none;">
    <div style="text-align:right;padding:0.5rem 0;">
      <span class="lang-switcher">
        <select id="login-lang-select"></select>
      </span>
    </div>
    <h2 data-i18n="login_title">Develop Agent</h2>
    <p data-i18n="login_prompt">メールアドレスとパスワードでログイン、またはマジックリンクを送信。</p>
    <input type="email" id="login-email" data-i18n-placeholder="login_placeholder" placeholder="you@example.com">
    <input type="password" id="login-password-input" data-i18n-placeholder="login_password_placeholder" placeholder="パスワード" style="margin-top:0.3rem;">
    <br>
    <div style="display:flex;gap:0.5rem;justify-content:center;">
      <button id="login-btn" data-i18n="login_btn_password">ログイン</button>
      <button id="login-magic-btn" style="background:#78909c;" data-i18n="login_btn_magic">マジックリンク送信</button>
    </div>
    <div id="login-msg" class="login-msg"></div>
  </div>

  <!-- ===== Company Setup ===== -->
  <div id="company-setup" style="display:none;">
    <div style="text-align:right;padding:0.5rem 0;">
      <span class="lang-switcher">
        <select id="setup-lang-select"></select>
      </span>
    </div>
    <h2 data-i18n="company_setup">Company Setup</h2>
    <p data-i18n="company_setup_desc">Create a new company or join an existing one to get started.</p>
    <div class="setup-tabs">
      <button class="setup-tab active" id="tab-create" data-i18n="company_create">Create New Company</button>
      <button class="setup-tab" id="tab-join" data-i18n="company_login">ログイン</button>
    </div>
    <div id="setup-create">
      <div class="ac-wrapper">
        <input type="text" id="create-name" data-i18n-placeholder="company_name_placeholder" placeholder="Company Name" autocomplete="off">
        <div class="ac-list" id="ac-dropdown"></div>
        <div id="selected-addr" class="selected-addr"></div>
      </div>
      <input type="password" id="create-password" data-i18n-placeholder="password_placeholder" placeholder="企業用パスワード（ログインに使用）">
      <input type="password" id="create-password-confirm" data-i18n-placeholder="password_confirm_placeholder" placeholder="企業用パスワード（確認）">
      <div id="password-hint" style="font-size:0.75rem;color:#888;text-align:left;margin:0.2rem 0 0.4rem;" data-i18n="password_hint">英大文字・英小文字・数字を含む8文字以上</div>
      <button class="setup-btn" id="create-btn" data-i18n="company_create_btn">Create</button>
    </div>
    <div id="setup-join" style="display:none;">
      <div style="margin-top:0.3rem;text-align:left;">
        <label style="font-size:0.85rem;font-weight:600;" data-i18n="company_id_label">Company ID</label>
        <div style="font-size:0.75rem;color:#888;margin-bottom:0.2rem;" data-i18n="company_login_hint">会社作成時に発行されたIDとパスワードを入力してください。</div>
      </div>
      <input type="text" id="join-slug" data-i18n-placeholder="company_join_placeholder" placeholder="my-company" style="font-family:monospace;">
      <input type="password" id="login-password" data-i18n-placeholder="password_placeholder" placeholder="企業用パスワード">
      <button class="setup-btn" id="join-btn" data-i18n="company_login_btn">ログイン</button>
    </div>
    <div id="setup-msg" class="setup-msg"></div>
  </div>

  <!-- ===== Main Dashboard ===== -->
  <div id="main-app" style="display:none;">

    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">Develop Agent</span>
        <button id="sidebar-close" class="sidebar-close">&times;</button>
      </div>
      <ul class="sidebar-nav">
        <li class="sidebar-item active" data-panel="panel-setup">
          <span class="sidebar-icon">&#128268;</span>
          <span class="sidebar-label" data-i18n="nav_setup">セットアップ</span>
        </li>
        <li class="sidebar-item" data-panel="panel-bpo">
          <span class="sidebar-icon">&#128188;</span>
          <span class="sidebar-label" data-i18n="nav_bpo">AI社員</span>
        </li>
        <li class="sidebar-item" data-panel="panel-develop">
          <span class="sidebar-icon">&#128187;</span>
          <span class="sidebar-label" data-i18n="nav_develop">開発エージェント</span>
        </li>
        <li class="sidebar-item" data-panel="panel-settings">
          <span class="sidebar-icon">&#9881;</span>
          <span class="sidebar-label" data-i18n="nav_settings">設定</span>
        </li>
      </ul>
    </nav>

    <!-- Sidebar overlay (mobile) -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Main content -->
    <div id="main-content" class="main-content">
      <!-- Top bar -->
      <div class="topbar">
        <button id="hamburger" class="hamburger">&#9776;</button>
        <div class="auth-bar" id="auth-bar" style="display:none;">
          <span id="auth-email"></span>
          <button id="logout-btn" data-i18n="logout">Logout</button>
        </div>
        <span class="lang-switcher">
          <select id="lang-select"></select>
        </span>
      </div>

      <!-- Panel: Setup (Onboarding + Integrations merged) -->
      <div id="panel-setup" class="content-panel active">
        <h2 data-i18n="setup_title">セットアップ</h2>

        <!-- Section 1: インフラ接続 -->
        <div class="setup-section open" id="setup-section-infra">
          <div class="setup-section-header" onclick="toggleSetupSection('setup-section-infra')">
            <h3 class="setup-section-title"><span class="section-icon icon-infra">&#9889;</span> <span data-i18n="setup_infra_title">インフラ接続</span></h3>
            <div style="display:flex;align-items:center;gap:0.5rem;">
              <span class="setup-section-badge" id="infra-section-badge">0 / 9</span>
              <span class="setup-section-chevron">&#9660;</span>
            </div>
          </div>
          <div class="setup-section-body">
            <div class="setup-section-inner">
              <div class="onboarding" id="onboarding-section" style="border:none;padding:0;">
                <div class="onboarding-progress">
                  <div class="progress-bar"><div class="progress-fill" id="ob-progress-fill" style="width:0%"></div></div>
                  <span class="progress-text" id="ob-progress-text">0 / 9</span>
                </div>
                <div id="ob-steps"></div>
                <div id="ob-infra"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: SaaS 接続 -->
        <div class="setup-section" id="setup-section-saas">
          <div class="setup-section-header" onclick="toggleSetupSection('setup-section-saas')">
            <h3 class="setup-section-title"><span class="section-icon icon-saas">&#9729;</span> <span data-i18n="setup_saas_title">SaaS 接続（AI社員用）</span></h3>
            <div style="display:flex;align-items:center;gap:0.5rem;">
              <span class="setup-section-badge" id="saas-section-badge"></span>
              <span class="setup-section-chevron">&#9660;</span>
            </div>
          </div>
          <div class="setup-section-body">
            <div class="setup-section-inner">
              <div id="saas-connections-container"><span class="empty-msg" data-i18n="loading">Loading...</span></div>
            </div>
          </div>
        </div>



      </div>

      <!-- Panel: BPO AI Employee -->
      <div id="panel-bpo" class="content-panel">
        <h2 data-i18n="bpo_title">AI社員</h2>
        <div id="bpo-dashboard-summary" class="bpo-dashboard-summary"></div>
        <section>
          <h3 data-i18n="bpo_task_input">タスク指示</h3>
          <div class="bpo-input-area">
            <div class="bpo-input-row">
              <select id="bpo-saas-select">
                <option value="" data-i18n="bpo_select_saas">-- SaaS選択 --</option>
              </select>
              <textarea id="bpo-task-input" data-i18n-placeholder="bpo_task_placeholder" placeholder="例: freeeで今月の未払い請求書を発行して" rows="4"></textarea>
              <button class="bpo-submit" id="bpo-submit-btn" data-i18n="bpo_submit">実行</button>
            </div>
            <div class="bpo-dryrun-row">
              <input type="checkbox" id="bpo-dryrun">
              <label for="bpo-dryrun" data-i18n="bpo_dryrun_label">ドライラン（実際のSaaS操作を行わない）</label>
            </div>
          </div>
        </section>
        <section>
          <h3 data-i18n="bpo_task_list">タスク一覧</h3>
          <div class="bpo-status-filters" id="bpo-status-filters">
            <button class="active" data-filter="all" data-i18n="filter_all">すべて</button>
            <button data-filter="planning" data-i18n="bpo_filter_planning">計画中</button>
            <button data-filter="awaiting_approval" data-i18n="bpo_filter_awaiting">承認待ち</button>
            <button data-filter="executing" data-i18n="bpo_filter_executing">実行中</button>
            <button data-filter="completed" data-i18n="bpo_filter_completed">完了</button>
            <button data-filter="failed" data-i18n="bpo_filter_failed">失敗</button>
          </div>
          <ul id="bpo-tasks" class="bpo-task-list"><li class="empty-msg" data-i18n="bpo_no_tasks">タスクはまだありません。</li></ul>
        </section>
        <section>
          <h3 data-i18n="bpo_task_detail">タスク詳細</h3>
          <div id="bpo-detail" class="bpo-detail"><span class="empty-msg" data-i18n="bpo_select_task">一覧からタスクを選択してください。</span></div>
        </section>
      </div>

      <!-- Panel: Develop Agent -->
      <div id="panel-develop" class="content-panel">
        <section>
          <h2 data-i18n="next_proposal">次のシステム提案</h2>
          <div id="suggestion" class="suggestion" data-i18n="loading">Loading...</div>
          <p id="suggestion-meta" class="meta"></p>
        </section>
        <section>
          <h2 data-i18n="run_list">Run 一覧</h2>
          <div class="status-filters" id="status-filters">
            <button class="status-filter active" data-filter="all" data-i18n="filter_all">すべて</button>
            <button class="status-filter" data-filter="spec_review" data-i18n="filter_spec_review">Spec レビュー</button>
            <button class="status-filter" data-filter="coding" data-i18n="filter_in_progress">実行中</button>
            <button class="status-filter" data-filter="published" data-i18n="filter_published">完了</button>
            <button class="status-filter" data-filter="failed" data-i18n="filter_failed">失敗</button>
          </div>
          <ul id="runs" class="runs-list"><li class="empty-msg" data-i18n="loading">Loading...</li></ul>
        </section>
        <section>
          <h2 data-i18n="detail">詳細</h2>
          <div id="detail" class="detail"><span class="empty-msg" data-i18n="select_run">一覧から Run を選択してください。</span></div>
        </section>
      </div>

      <!-- Panel: Settings -->
      <div id="panel-settings" class="content-panel">
        <h2 data-i18n="settings">設定</h2>

        <section>
          <h3 data-i18n="auto_execute_title">自動実行</h3>
          <div class="setting-row">
            <label class="toggle">
              <input type="checkbox" id="auto-execute-toggle">
              <span class="slider"></span>
            </label>
            <span class="toggle-label" id="auto-execute-label">...</span>
          </div>
        </section>

        <section>
          <h3 data-i18n="company_info_title">会社情報</h3>
          <div id="settings-company-info"><span class="empty-msg" data-i18n="loading">Loading...</span></div>
        </section>

        <section id="members-section">
          <h3 data-i18n="members_title">メンバー</h3>
          <div id="member-list"></div>
          <div id="invite-section"></div>
        </section>

        <section>
          <h3 data-i18n="set_password_title">個人用パスワード再設定</h3>
          <p style="font-size:0.85rem;color:#666;" data-i18n="set_password_desc">個人用パスワードを再設定できます。メール＋パスワードでログインできます。</p>
          <input type="password" id="set-password-input" data-i18n-placeholder="set_password_new" placeholder="新しいパスワード" style="margin-bottom:0.3rem;">
          <input type="password" id="set-password-confirm" data-i18n-placeholder="set_password_confirm_placeholder" placeholder="パスワード（確認）" style="margin-bottom:0.5rem;">
          <button id="set-password-btn" style="padding:0.5rem 1.2rem;" data-i18n="set_password_btn">パスワードを再設定</button>
          <div id="set-password-msg" class="login-msg" style="margin-top:0.5rem;"></div>
        </section>

        <section style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid #eee;">
          <button id="settings-logout-btn" style="padding:0.6rem 1.5rem;background:#c62828;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.9rem;" data-i18n="logout_btn">ログアウト</button>
        </section>
      </div>

      <!-- panel-integrations merged into panel-setup -->

    </div>
  </div>

  <script>
    // ===== Setup section accordion toggle (global for onclick) =====
    var _toggleStoreKey = 'dashboard_toggle_states';
    function _loadToggleStates() {
      try { return JSON.parse(localStorage.getItem(_toggleStoreKey)) || {}; } catch(e) { return {}; }
    }
    function _saveToggleState(id, isOpen) {
      var states = _loadToggleStates();
      states[id] = isOpen;
      localStorage.setItem(_toggleStoreKey, JSON.stringify(states));
    }
    function toggleSetupSection(id) {
      var el = document.getElementById(id);
      if (el) {
        el.classList.toggle('open');
        _saveToggleState(id, el.classList.contains('open'));
      }
    }
    function toggleSaasGuide(id, btn) {
      var el = document.getElementById(id);
      if (el) { el.classList.toggle('open'); _saveToggleState(id, el.classList.contains('open')); }
      if (btn) { btn.classList.toggle('open'); }
    }
    function restoreToggleStates() {
      var states = _loadToggleStates();
      Object.keys(states).forEach(function(id) {
        var el = document.getElementById(id);
        if (!el) return;
        if (states[id]) { el.classList.add('open'); } else { el.classList.remove('open'); }
        // saas-guide のトグルボタンの open クラスも同期
        if (id.indexOf('saas-guide-') === 0) {
          var toggleBtn = el.previousElementSibling;
          if (toggleBtn && toggleBtn.classList.contains('saas-guide-toggle')) {
            if (states[id]) { toggleBtn.classList.add('open'); } else { toggleBtn.classList.remove('open'); }
          }
        }
      });
    }

    (function () {
      // ===== i18n =====
      const I18N = {
        ja: {
          page_title: 'Develop Agent - ダッシュボード',
          app_title: 'Develop Agent Dashboard',
          login_title: 'Develop Agent',
          login_prompt: 'メールアドレスとパスワードでログイン、またはマジックリンクを送信。',
          login_placeholder: 'you@example.com',
          login_password_placeholder: 'パスワード',
          login_btn_password: 'ログイン',
          login_btn_magic: 'マジックリンク送信',
          login_btn: 'ログインリンクを送信',
          login_sending: '送信中...',
          login_sent: 'ログインリンクをメールに送信しました。メールを確認してください。',
          login_email_required: 'メールアドレスを入力してください。',
          login_password_required: 'パスワードを入力してください。未設定の場合はマジックリンクをご利用ください。',
          login_authenticating: '認証中...',
          login_error: 'エラーが発生しました。',
          set_password_title: '個人用パスワード再設定',
          set_password_desc: '個人用パスワードを再設定できます。メール＋パスワードでログインできます。',
          set_password_btn: 'パスワードを再設定',
          set_password_new: '新しいパスワード',
          set_password_confirm_placeholder: 'パスワード（確認）',
          set_password_saving: '保存中...',
          set_password_success: 'パスワードを設定しました。次回からメール＋パスワードでログインできます。',
          set_password_mismatch: 'パスワードが一致しません。',
          set_password_weak: 'パスワードは8文字以上で、英大小文字・数字を含めてください。',
          login_config_missing: 'サーバーの認証設定がありません。',
          login_init_failed: '認証の初期化に失敗しました。',
          logout: 'ログアウト',
          nav_setup: 'セットアップ',
          nav_bpo: 'AI社員',
          nav_develop: '開発エージェント',
          nav_settings: '設定',
          setup_title: 'セットアップ',
          setup_infra_title: 'インフラ接続',
          setup_saas_title: 'SaaS 接続（AI社員用）',
          setup_integrations_title: 'インフラ設定',
          integrations_title: '連携設定',
          saas_not_configured: 'Client ID / Secret を入力して保存してください',
          saas_connect_oauth: 'OAuth で接続',
          saas_connecting: '接続中...',
          saas_connected: '接続済み',
          saas_disconnected: '未接続',
          saas_disconnect: '切断',
          saas_config_save: '設定を保存',
          saas_config_saved: '保存しました',
          saas_instance_url: 'インスタンスURL',
          saas_instance_url_hint: '例: https://xxx.cybozu.com',
          saas_no_supported: '対応SaaSがありません。',
          saas_setup_guide: '接続手順',
          saas_guide_salesforce_title: 'Salesforce Connected App の作成手順',
          saas_guide_salesforce: '<ol><li><a href="https://login.salesforce.com/" target="_blank" rel="noopener">Salesforce ↗</a> に管理者アカウントでログイン</li><li>右上の歯車アイコン → 「設定」を開く</li><li>左メニュー「プラットフォームツール」→「アプリケーション」→「アプリケーションマネージャ」を開く</li><li>右上「新規接続アプリケーション」をクリック</li><li>基本情報を入力：<br>・接続アプリケーション名: 任意（例: AI Agent）<br>・API参照名: 自動入力<br>・取引先責任者メール: 管理者メール</li><li>「OAuth 設定の有効化」にチェック</li><li>コールバックURL に以下を入力：<br><code>{サーバーURL}/api/oauth/saas/salesforce/callback</code></li><li>「選択した OAuth 範囲」で以下を追加：<br>・「APIを使用してユーザデータを管理 (api)」<br>・「いつでも要求を実行 (refresh_token, offline_access)」</li><li>「保存」をクリック → 「コンシューマ鍵」と「コンシューマの秘密」が発行される（※秘密の表示には10分程度かかる場合あり）</li><li>「コンシューマ鍵」→ Client ID、「コンシューマの秘密」→ Client Secret として下の欄に入力</li></ol>',
          saas_guide_freee_title: 'freee アプリの作成手順',
          saas_guide_freee: '<ol><li><a href="https://app.secure.freee.co.jp/developers/applications" target="_blank" rel="noopener">freee Developers ↗</a> にログイン</li><li>「新しいアプリケーションを作成」をクリック</li><li>アプリ情報を入力：<br>・アプリ名: 任意（例: AI Agent）<br>・概要: 任意</li><li>「作成」をクリック</li><li>作成後の画面で「コールバックURL」に以下を追加：<br><code>{サーバーURL}/api/oauth/saas/freee/callback</code></li><li>「Client ID」と「Client Secret」が表示される</li><li>権限設定で「会計」の読み取り・書き込みを有効化</li><li>「Client ID」「Client Secret」を下の欄にコピー＆ペースト</li></ol>',
          saas_guide_slack_title: 'Slack App の作成手順',
          saas_guide_slack: '<ol><li><a href="https://api.slack.com/apps" target="_blank" rel="noopener">Slack API ↗</a> にログイン</li><li>「Create New App」→「From scratch」を選択</li><li>App Name（例: AI Agent）とワークスペースを選択して「Create App」</li><li>左メニュー「OAuth & Permissions」を開く</li><li>「Redirect URLs」に以下を追加：<br><code>{サーバーURL}/api/oauth/saas/slack/callback</code></li><li>「Scopes」→「Bot Token Scopes」で以下を追加：<br>・<code>chat:write</code>（メッセージ送信）<br>・<code>channels:read</code>（チャンネル一覧取得）<br>・<code>channels:history</code>（メッセージ履歴取得）<br>・<code>users:read</code>（ユーザー情報取得）<br>・<code>reactions:write</code>（リアクション追加）<br>・<code>files:write</code>（ファイルアップロード）</li><li>左メニュー「Basic Information」で「Client ID」「Client Secret」を確認</li><li>下の欄にコピー＆ペースト</li></ol>',
          saas_guide_google_workspace_title: 'Google Cloud OAuth の設定手順',
          saas_guide_google_workspace: '<ol><li><a href="https://console.cloud.google.com/" target="_blank" rel="noopener">Google Cloud Console ↗</a> にログイン</li><li>プロジェクトを選択（または新規作成）</li><li>左メニュー「APIとサービス」→「有効なAPIとサービス」を開く</li><li>以下のAPIを有効化：<br>・Gmail API<br>・Google Calendar API<br>・Google Drive API<br>・Google Sheets API</li><li>左メニュー「APIとサービス」→「OAuth 同意画面」を開く</li><li>「外部」を選択して「作成」（社内利用なら「内部」も可）</li><li>アプリ情報を入力（アプリ名、サポートメール等）→「保存して次へ」</li><li>「スコープを追加または削除」で以下を追加：<br>・<code>https://www.googleapis.com/auth/gmail.modify</code><br>・<code>https://www.googleapis.com/auth/calendar</code><br>・<code>https://www.googleapis.com/auth/drive</code><br>・<code>https://www.googleapis.com/auth/spreadsheets</code></li><li>左メニュー「認証情報」→「認証情報を作成」→「OAuthクライアントID」</li><li>アプリケーションの種類:「ウェブアプリケーション」を選択</li><li>名前: 任意（例: AI Agent）</li><li>「承認済みのリダイレクトURI」に以下を追加：<br><code>{サーバーURL}/api/oauth/saas/google_workspace/callback</code></li><li>「作成」→「クライアントID」「クライアントシークレット」が表示される</li><li>下の欄にコピー＆ペースト</li></ol>',
          saas_guide_kintone_title: 'kintone OAuth クライアントの作成手順',
          saas_guide_kintone: '<ol><li><a href="https://store.cybozu.com/" target="_blank" rel="noopener">cybozu.com 共通管理 ↗</a> にログイン</li><li>「cybozu.com共通管理」→「外部連携」→「OAuthクライアント」を開く</li><li>「OAuthクライアントの追加」をクリック</li><li>以下を入力：<br>・クライアント名: 任意（例: AI Agent）<br>・リダイレクトエンドポイント: <code>{サーバーURL}/api/oauth/saas/kintone/callback</code></li><li>「保存」→「クライアントID」「クライアントシークレット」が発行される</li><li>左メニュー「外部連携」→「OAuthスコープ」で以下を追加：<br>・<code>k:app_record:read</code>（レコード読み取り）<br>・<code>k:app_record:write</code>（レコード書き込み）</li><li>下の欄に「インスタンスURL」として <code>https://あなたのサブドメイン.cybozu.com</code> を入力</li><li>「Client ID」「Client Secret」をコピー＆ペースト</li></ol>',
          saas_guide_smarthr_title: 'SmartHR OAuth アプリの作成手順',
          saas_guide_smarthr: '<ol><li><a href="https://app.smarthr.jp/" target="_blank" rel="noopener">SmartHR ↗</a> に管理者アカウントでログイン</li><li>右上メニュー →「共通設定」→「外部システム連携」を開く</li><li>「OAuthアプリケーション」タブ →「新規作成」</li><li>以下を入力：<br>・アプリケーション名: 任意（例: AI Agent）<br>・リダイレクトURI: <code>{サーバーURL}/api/oauth/saas/smarthr/callback</code></li><li>必要なスコープを選択：<br>・<code>read</code>（従業員情報読み取り）<br>・<code>write</code>（従業員情報書き込み）</li><li>「保存」→「クライアントID」「クライアントシークレット」が発行される</li><li>下の欄に「インスタンスURL」として <code>https://あなたのサブドメイン.smarthr.jp</code> を入力</li><li>「Client ID」「Client Secret」をコピー＆ペースト</li></ol>',
          int_infra_title: 'インフラ接続状況',
          int_channels_title: 'チャネル連携',
          int_env_title: '環境変数の設定状態',
          int_connected: '接続済み',
          int_disconnected: '未接続',
          int_env_set: '設定済み',
          int_env_unset: '未設定',
          int_github_title: 'GitHub',
          int_supabase_title: 'Supabase',
          int_vercel_title: 'Vercel',
          int_notion_title: 'Notion',
          int_slack_title: 'Slack',
          int_gdrive_title: 'Google Drive',
          int_chatwork_title: 'Chatwork',
          int_connect_oauth: 'OAuth で接続',
          int_save_token: '保存',
          int_setup_steps: '設定手順',
          int_notion_step1: '<a href="https://www.notion.so/profile/integrations" target="_blank" rel="noopener">Notion Integrations ページ ↗</a> で新しい Integration を作成',
          int_notion_step2: '下の「アプリ設定」に Client ID と Secret を入力',
          int_notion_step3: '下の「OAuth で接続」ボタンをクリックして認証',
          int_slack_step1: '<a href="https://api.slack.com/apps" target="_blank" rel="noopener">Slack API の Your Apps ↗</a> で新しい App を作成',
          int_slack_step2: 'OAuth & Permissions で Bot Token Scopes を設定（channels:history, chat:write, files:read）',
          int_slack_step3: '下の「アプリ設定」に Client ID と Client Secret を入力',
          int_slack_step4: '下の「OAuth で接続」ボタンをクリックして認証',
          int_gdrive_step1: '<a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener">GCP Console ↗</a> で OAuth 同意画面を設定',
          int_gdrive_step2: '認証情報で OAuth クライアント ID を作成（種類: 「ウェブ アプリケーション」を選択）し、下の「アプリ設定」に Client ID と Secret を入力',
          int_gdrive_step3: '下の「OAuth で接続」ボタンをクリックして認証',
          int_chatwork_step1: '<a href="https://www.chatwork.com/service/packages/chatwork/subpackages/api/token.php" target="_blank" rel="noopener">Chatwork API トークン発行ページ ↗</a> で新しいトークンを発行',
          int_chatwork_step2: '下の入力欄にトークンを貼り付けて「保存」をクリック',
          int_chatwork_saved: 'Chatwork トークンを保存しました',
          int_chatwork_placeholder: 'Chatwork API Token を貼り付け',
          int_no_url: '未設定',
          int_updated_at: '最終更新',
          int_scopes: 'スコープ',
          int_env_not_configured: 'アプリ設定が未登録のため接続できません。先にダッシュボードで設定してください。',
          int_token_saved: 'トークン保存済み',
          int_token_not_saved: 'トークン未保存（管理者に依頼してください）',
          int_token_not_saved: 'トークン未保存',
          int_token_save_hint_sb: '以下のリンクからトークンを発行して保存してください（再操作に必要） <a href="https://supabase.com/dashboard/account/tokens" target="_blank" rel="noopener">Supabase でトークンを発行する ↗</a>',
          int_token_save_hint_vc: '以下のリンクからトークンを発行して保存してください（再操作に必要） <a href="https://vercel.com/account/tokens" target="_blank" rel="noopener">Vercel でトークンを発行する ↗</a>',
          int_token_placeholder_sb: 'Supabase Access Token を貼り付け',
          int_token_placeholder_vc: 'Vercel API Token を貼り付け',
          int_infra_token_saved: 'トークンを保存しました',
          int_expires_at: '有効期限',
          int_expires_at_placeholder: '有効期限（任意）',
          int_expires_none: '期限なし',
          int_expires_edit: '変更',
          int_expires_save: '保存',
          int_expires_saved: '有効期限を更新しました',
          int_expires_days_left: '日後',
          int_expires_days_unit: '日',
          int_expires_expired: '期限切れ',
          int_expires_today: '本日期限切れ',
          int_reissue: 'トークンを再発行',
          int_reconnect: '再接続',
          int_reconnect_revoke_failed: 'GitHub 側の認可解除に失敗しました。別アカウントで接続するには、先に GitHub.com でログアウトしてから再接続してください。このまま続行しますか？',
          int_reconnect_provisioning_sb: 'Supabase を再構築中...',
          int_reconnect_provisioning_vc: 'Vercel を再構築中...',
          int_reconnect_success: '再接続が完了しました',
          int_vercel_deploy_hint: 'デプロイ中です。1〜2分後にアクセスしてください。',
          int_vercel_deploy_ready: 'デプロイが完了しました。',
          int_vercel_deploy_error: 'デプロイに失敗しました。Vercel ダッシュボードでログを確認してください。',
          int_reconnect_failed: '再接続に失敗しました: ',
          int_connect: '接続',
          int_vc_anon_key_hint: '任意 — 入力すると Vercel 環境変数 NEXT_PUBLIC_SUPABASE_ANON_KEY に自動設定されます。未入力でも接続可能です。',
          int_vc_github_login_hint: 'Vercel で GitHub リポを連携するには、事前に以下の2つが必要です: ① Vercel アカウントに GitHub Login Connection を追加 ② GitHub に Vercel App をインストール',
          int_disconnect: '接続を解除',
          int_disconnect_confirm: 'の接続を解除しますか？インフラ設定・トークン・オンボーディング状態がリセットされます。',
          int_disconnected: '接続を解除しました',
          int_ch_config_title: 'アプリ設定',
          int_ch_config_save: '設定を保存',
          int_ch_config_saved: '設定を保存しました',
          int_ch_config_delete: '設定を削除',
          int_ch_config_deleted: '設定を削除しました',
          int_ch_webhook_url: 'Webhook URL',
          int_ch_redirect_uri: 'リダイレクト URI（OAuth プロバイダーに登録）',
          int_ch_webhook_copy: 'コピー',
          int_ch_webhook_copied: 'コピーしました',
          int_ch_or_env: 'ダッシュボードのアプリ設定に入力してください',
          int_ch_config_hint: '自社の OAuth App の認証情報をここに入力してください。接続するには必須です。',
          settings: '設定',
          auto_execute_title: '自動実行',
          auto_exec_on: '自動実行: ON（即座にフルパイプラインを実行）',
          auto_exec_off: '自動実行: OFF（Spec 後に一時停止してレビュー）',
          settings_error: '設定の読み込みに失敗しました',
          settings_save_error: '設定の保存に失敗しました',
          company_info_title: '会社情報',
          members_title: 'メンバー',
          no_company: '会社が設定されていません。',
          no_members: 'メンバーはいません。',
          member_remove: '削除',
          member_remove_confirm: 'このメンバーを削除しますか？',
          invite_generate: '招待リンクを生成',
          invite_expires: '有効期限: 7日間（1回限り使用可）',
          invite_copied: 'コピーしました',
          invite_invalid: '招待リンクが無効または期限切れです。',
          invite_consumed: '招待リンクから参加しました。',
          company_login: '既存企業に参加',
          company_login_btn: '参加する',
          company_login_hint: '参加する企業のIDとパスワードを入力してください。',
          password_placeholder: '企業用パスワード',
          password_confirm_placeholder: '企業用パスワード（確認）',
          password_hint: '英大文字・英小文字・数字を含む8文字以上',
          password_required: 'パスワードを入力してください。',
          password_mismatch: 'パスワードが一致しません。',
          password_weak: '英大文字・英小文字・数字を含む8文字以上で入力してください。',
          login_failed: '会社IDまたはパスワードが正しくありません。',
          logout_btn: 'ログアウト',
          next_proposal: '次のシステム提案',
          no_proposal: '提案はまだありません。エージェントを実行してデータを蓄積してください。',
          load_failed: '読み込みに失敗しました。',
          run_list: 'Run 一覧',
          filter_all: 'すべて',
          filter_spec_review: 'Spec レビュー',
          filter_in_progress: '実行中',
          filter_published: '完了',
          filter_failed: '失敗',
          no_runs: 'Run が見つかりません。',
          runs_load_failed: 'Run の読み込みに失敗しました。',
          detail: '詳細',
          select_run: '一覧から Run を選択してください。',
          loading: '読み込み中...',
          spec_document: 'Spec ドキュメント',
          start_impl: '実装を開始',
          implementing: '実装中...',
          summary: 'サマリー',
          generated_files: '生成ファイル',
          detail_load_failed: '詳細の読み込みに失敗しました。',
          no_detail: 'この Run の詳細はありません。',
          updated: '更新日時',
          status_processing: '処理中',
          status_spec_review: 'Spec レビュー',
          status_implementing: '実装中',
          status_published: '完了',
          status_failed: '失敗',
          company_setup: '会社設定',
          company_setup_desc: '新しい会社を作成するか、既存の会社に参加してください。',
          company_create: '新しい会社を作成',
          company_join: '既存の会社に参加',
          company_name_placeholder: '会社名（例: 株式会社ABC）',
          company_id_label: '会社ID',
          company_id_hint: '半角英数字とハイフンのみ。チームの識別に使います。後から変更できません。',
          company_slug_placeholder: 'my-company',
          company_join_hint: 'チーム管理者から共有された会社IDを入力してください。',
          company_join_placeholder: '例: my-company',
          company_create_btn: '作成',
          company_join_btn: '参加',
          company_created: '会社を作成しました。',
          company_joined: '会社に参加しました。',
          company_slug_taken: 'この会社IDは既に使用されています。',
          company_not_found: 'この会社IDは見つかりません。管理者に確認してください。',
          company_error: 'エラーが発生しました。',
          company_confirm_create: '以下の内容で会社を作成しますか？会社IDは自動で発行されます。',
          company_confirm_join: '以下の会社に参加します。よろしいですか？',
          company_confirm_name: '会社名',
          company_confirm_id: '会社ID',
          employee_count_label: '従業員数',
          annual_revenue_label: '年商',
          industry_label: '業種',
          founded_date_label: '設立日',
          select_placeholder: '-- 選択してください --',
          rev_under1: '〜1億円',
          rev_1_10: '1〜10億円',
          rev_10_50: '10〜50億円',
          rev_50_100: '50〜100億円',
          rev_over100: '100億円以上',
          ind_manufacturing: '製造業',
          ind_it: 'IT・通信',
          ind_retail: '小売・卸売',
          ind_construction: '建設・不動産',
          ind_healthcare: '医療・福祉',
          ind_food: '飲食・外食',
          ind_finance: '金融・保険',
          ind_education: '教育',
          ind_logistics: '物流・運輸',
          ind_agriculture: '農林水産業',
          ind_energy: 'エネルギー・インフラ',
          ind_staffing: '人材・派遣',
          ind_media: '広告・メディア',
          ind_consulting: 'コンサルティング',
          ind_beauty: '美容・エステ',
          ind_travel: '旅行・観光',
          ind_service: 'サービス業',
          ind_other: 'その他',
          company_confirm_employees: '従業員数',
          company_confirm_revenue: '年商',
          company_confirm_industry: '業種',
          company_confirm_corp_num: '法人番号',
          ac_join_hint: '※ この会社は既に登録されています。「既存の会社に参加」タブから参加できます。',
          ob_profile_title: '企業情報を入力してください',
          ob_profile_desc: 'AI社員が御社に最適な提案を行うために必要です。',
          ob_profile_save: '保存',
          ob_profile_saved: '保存しました',
          ob_profile_done: '企業情報 登録済み',
          onboarding_title: 'オンボーディング',
          ob_github_repo: 'GitHub リポジトリ作成',
          ob_github_repo_desc: 'クライアント用のプライベートリポジトリを作成',
          ob_github_repo_cmd: 'gh repo create {org}/{company}-dashboard --private',
          ob_github_initial_commit: 'Next.js ボイラープレート初期コミット',
          ob_github_initial_commit_desc: 'Sidebar・GenreCard・Supabase 接続の初期コードを push',
          ob_github_initial_commit_cmd: 'bash scripts/onboarding.sh --company {slug} --org {org}',
          ob_vercel_project: 'Vercel プロジェクト作成',
          ob_vercel_project_desc: 'GitHub リポと連携し main push で自動デプロイ',
          ob_vercel_env: 'Vercel 環境変数設定',
          ob_vercel_env_desc: 'NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY 等',
          ob_supabase_project: 'クライアント用 Supabase 作成',
          ob_supabase_project_desc: '業務データ用の新規 Supabase プロジェクト',
          ob_supabase_tables: '共通テーブル作成（SQL 実行）',
          ob_supabase_tables_desc: 'agent_outputs テーブル等を SQL Editor で実行',
          ob_secret_manager_token: 'GCP Secret Manager にトークン格納',
          ob_secret_manager_token_desc: 'GitHub トークンを Secret Manager に保存（DB に平文保存しない）',
          ob_secret_manager_token_cmd: 'gcloud secrets create github-token-{slug} --data-file=<token>',
          ob_env_github_repository: '開発側 GITHUB_REPOSITORY 設定',
          ob_env_github_repository_desc: '.env.local の GITHUB_REPOSITORY をクライアントリポに変更',
          ob_all_done: 'オンボーディング完了！ AI社員が稼働可能です。',
          infra_github_repo: 'GitHub リポジトリ',
          infra_github_repo_ph: 'org/company-dashboard',
          infra_github_token: 'Secret Manager シークレット名',
          infra_github_token_ph: 'github-token-company-a',
          infra_supabase_url: 'クライアント Supabase URL',
          infra_supabase_url_ph: 'https://xxxxx.supabase.co',
          infra_vercel_url: 'Vercel デプロイ URL',
          infra_vercel_url_ph: 'https://company-dashboard.vercel.app',
          infra_section_title: 'インフラ設定',
          infra_section_desc: 'CLIスクリプト (onboarding.sh) で設定された接続情報です。変更するにはCLIから再実行してください。',
          infra_not_set: '未設定',
          ob_card_github_title: 'Step 1: GitHub 連携',
          ob_card_github_connect: 'GitHub で認証',
          ob_card_github_connecting: 'GitHub に接続中...',
          ob_card_github_provisioning: 'リポジトリを作成中...',
          ob_card_github_done: '接続済み',
          ob_card_github_step_repo: 'リポジトリ作成',
          ob_card_github_step_commit: '初回コミット',
          ob_card_supabase_title: 'Step 2: Supabase 連携',
          ob_card_supabase_connect: '接続',
          ob_card_supabase_pat_help: '以下のリンクからトークンを発行して、上の欄に貼り付けてください。',
          ob_card_supabase_pat_link: 'Supabase でトークンを発行する',
          ob_card_supabase_provisioning: 'プロジェクトを作成中（数十秒かかります）...',
          ob_card_supabase_done: '接続済み',
          ob_card_supabase_step_project: 'プロジェクト作成',
          ob_card_supabase_step_tables: 'テーブル初期化',
          ob_card_supabase_tables_retry: 'プロジェクトは作成済みですが、テーブル初期化に失敗しました。',
          ob_card_supabase_retry: 'テーブル初期化をリトライ',
          ob_card_supabase_retrying: 'テーブルを初期化中...',
          ob_card_vercel_title: 'Step 3: Vercel 連携',
          ob_card_vercel_connect: '接続',
          ob_card_vercel_token_help: '以下のリンクからトークンを発行して、上の欄に貼り付けてください。',
          ob_card_vercel_token_link: 'Vercel でトークンを発行する',
          ob_card_vercel_provisioning: 'プロジェクトを作成中...',
          ob_card_vercel_done: '接続済み',
          ob_card_vercel_step_project: 'プロジェクト作成',
          ob_card_vercel_step_env: '環境変数設定',
          ob_card_vercel_requires_github: 'GitHub 連携を先に完了してください',
          ob_card_supabase_anon_key: 'Supabase Anon Key（任意）',
          ob_provision_failed: 'エラーが発生しました: ',
          bpo_title: 'AI社員',
          bpo_task_input: 'タスク指示',
          bpo_select_saas: '-- SaaS選択 --',
          bpo_task_placeholder: '例: freeeで今月の未払い請求書を発行して',
          bpo_submit: '実行',
          bpo_dryrun_label: 'ドライラン（実際のSaaS操作を行わない）',
          bpo_task_list: 'タスク一覧',
          bpo_filter_planning: '計画中',
          bpo_filter_awaiting: '承認待ち',
          bpo_filter_executing: '実行中',
          bpo_filter_completed: '完了',
          bpo_filter_failed: '失敗',
          bpo_no_tasks: 'タスクはまだありません。',
          bpo_task_detail: 'タスク詳細',
          bpo_select_task: '一覧からタスクを選択してください。',
          bpo_status_planning: '計画中',
          bpo_status_awaiting: '承認待ち',
          bpo_status_executing: '実行中',
          bpo_status_completed: '完了',
          bpo_status_failed: '失敗',
          bpo_status_rejected: '却下',
          bpo_plan_title: '実行計画',
          bpo_failure_reason: 'エラー原因',
          bpo_failure_detail: '詳細',
          bpo_approve: '承認して実行',
          bpo_reject: '却下',
          bpo_approving: '実行開始中...',
          bpo_result_title: '実行結果',
          bpo_success_count: '成功',
          bpo_failure_count: '失敗',
          bpo_total_ops: '合計操作数',
          bpo_errors_title: 'エラー詳細',
          bpo_task_creating: 'タスク作成中...',
          bpo_task_created: 'タスクを作成しました。計画を生成中です。',
          bpo_task_create_failed: 'タスクの作成に失敗しました。',
          bpo_no_connection: 'SaaS接続を選択してください。',
          bpo_no_description: 'タスク内容を入力してください。',
          bpo_summary_total: '合計',
          bpo_summary_awaiting: '承認待ち',
          bpo_summary_success_rate: '成功率',
          bpo_summary_running: '実行中',
          bpo_report_title: '結果レポート',
          bpo_created_at: '作成日時',
          bpo_saas: 'SaaS',
        },
        en: {
          page_title: 'Develop Agent - Dashboard',
          app_title: 'Develop Agent Dashboard',
          login_title: 'Develop Agent',
          login_prompt: 'Log in with email and password, or send a magic link.',
          login_placeholder: 'you@example.com',
          login_password_placeholder: 'Password',
          login_btn_password: 'Log In',
          login_btn_magic: 'Send Magic Link',
          login_btn: 'Send Login Link',
          login_sending: 'Sending...',
          login_sent: 'Login link sent to your email. Please check your inbox.',
          login_email_required: 'Please enter your email address.',
          login_password_required: 'Please enter your password. If not set, use Magic Link.',
          login_authenticating: 'Authenticating...',
          login_error: 'An error occurred.',
          set_password_title: 'Personal Password Reset',
          set_password_desc: 'Reset your personal password to log in with email + password instead of a magic link.',
          set_password_btn: 'Reset Password',
          set_password_new: 'New password',
          set_password_confirm_placeholder: 'Confirm password',
          set_password_saving: 'Saving...',
          set_password_success: 'Password set. You can now log in with email + password.',
          set_password_mismatch: 'Passwords do not match.',
          set_password_weak: 'Password must be at least 8 characters with uppercase, lowercase, and a number.',
          login_config_missing: 'Auth configuration missing on server.',
          login_init_failed: 'Failed to initialize authentication.',
          logout: 'Logout',
          nav_setup: 'Setup',
          nav_bpo: 'AI Employee',
          nav_develop: 'Develop Agent',
          nav_settings: 'Settings',
          setup_title: 'Setup',
          setup_infra_title: 'Infrastructure',
          setup_saas_title: 'SaaS Connections (AI Employee)',
          setup_integrations_title: 'Infrastructure Settings',
          integrations_title: 'Integrations',
          saas_not_configured: 'Enter Client ID / Secret and save to connect',
          saas_connect_oauth: 'Connect with OAuth',
          saas_connecting: 'Connecting...',
          saas_connected: 'Connected',
          saas_disconnected: 'Not Connected',
          saas_disconnect: 'Disconnect',
          saas_config_save: 'Save Settings',
          saas_config_saved: 'Saved',
          saas_instance_url: 'Instance URL',
          saas_instance_url_hint: 'e.g. https://xxx.cybozu.com',
          saas_no_supported: 'No supported SaaS available.',
          saas_setup_guide: 'Setup Guide',
          saas_guide_salesforce_title: 'How to create a Salesforce Connected App',
          saas_guide_salesforce: '<ol><li>Log in to <a href="https://login.salesforce.com/" target="_blank" rel="noopener">Salesforce ↗</a> with an admin account</li><li>Click the gear icon (top right) → "Setup"</li><li>Navigate to "Platform Tools" → "Apps" → "App Manager"</li><li>Click "New Connected App" (top right)</li><li>Fill in basic info:<br>• Connected App Name: e.g. AI Agent<br>• API Name: auto-filled<br>• Contact Email: your admin email</li><li>Check "Enable OAuth Settings"</li><li>Set Callback URL to:<br><code>{server URL}/api/oauth/saas/salesforce/callback</code></li><li>Add these OAuth Scopes:<br>• "Manage user data via APIs (api)"<br>• "Perform requests at any time (refresh_token, offline_access)"</li><li>Click "Save" → Consumer Key and Consumer Secret will be generated (secret may take ~10 min to appear)</li><li>Copy Consumer Key → Client ID, Consumer Secret → Client Secret into the fields below</li></ol>',
          saas_guide_freee_title: 'How to create a freee App',
          saas_guide_freee: '<ol><li>Log in to <a href="https://app.secure.freee.co.jp/developers/applications" target="_blank" rel="noopener">freee Developers ↗</a></li><li>Click "Create New Application"</li><li>Enter app info:<br>• App Name: e.g. AI Agent<br>• Description: optional</li><li>Click "Create"</li><li>Add Callback URL:<br><code>{server URL}/api/oauth/saas/freee/callback</code></li><li>Client ID and Client Secret will be displayed</li><li>Enable read/write permissions for "Accounting"</li><li>Copy Client ID and Client Secret into the fields below</li></ol>',
          saas_guide_slack_title: 'How to create a Slack App',
          saas_guide_slack: '<ol><li>Log in to <a href="https://api.slack.com/apps" target="_blank" rel="noopener">Slack API ↗</a></li><li>Click "Create New App" → "From scratch"</li><li>Enter App Name (e.g. AI Agent), select workspace, click "Create App"</li><li>Go to "OAuth & Permissions" in the left menu</li><li>Under "Redirect URLs", add:<br><code>{server URL}/api/oauth/saas/slack/callback</code></li><li>Under "Scopes" → "Bot Token Scopes", add:<br>• <code>chat:write</code> (send messages)<br>• <code>channels:read</code> (list channels)<br>• <code>channels:history</code> (read message history)<br>• <code>users:read</code> (read user info)<br>• <code>reactions:write</code> (add reactions)<br>• <code>files:write</code> (upload files)</li><li>Go to "Basic Information" → find Client ID and Client Secret</li><li>Copy into the fields below</li></ol>',
          saas_guide_google_workspace_title: 'How to set up Google Cloud OAuth',
          saas_guide_google_workspace: '<ol><li>Log in to <a href="https://console.cloud.google.com/" target="_blank" rel="noopener">Google Cloud Console ↗</a></li><li>Select a project (or create a new one)</li><li>Navigate to "APIs & Services" → "Enabled APIs & Services"</li><li>Enable these APIs:<br>• Gmail API<br>• Google Calendar API<br>• Google Drive API<br>• Google Sheets API</li><li>Go to "APIs & Services" → "OAuth consent screen"</li><li>Select "External" and click "Create" (or "Internal" for org-only use)</li><li>Enter app info (App name, Support email, etc.) → "Save and Continue"</li><li>Click "Add or Remove Scopes" and add:<br>• <code>https://www.googleapis.com/auth/gmail.modify</code><br>• <code>https://www.googleapis.com/auth/calendar</code><br>• <code>https://www.googleapis.com/auth/drive</code><br>• <code>https://www.googleapis.com/auth/spreadsheets</code></li><li>Go to "Credentials" → "Create Credentials" → "OAuth client ID"</li><li>Application type: "Web application"</li><li>Name: e.g. AI Agent</li><li>Under "Authorized redirect URIs", add:<br><code>{server URL}/api/oauth/saas/google_workspace/callback</code></li><li>Click "Create" → Client ID and Client Secret will be shown</li><li>Copy into the fields below</li></ol>',
          saas_guide_kintone_title: 'How to create a kintone OAuth Client',
          saas_guide_kintone: '<ol><li>Log in to <a href="https://store.cybozu.com/" target="_blank" rel="noopener">cybozu.com Admin ↗</a></li><li>Navigate to "cybozu.com Admin" → "External Integration" → "OAuth Clients"</li><li>Click "Add OAuth Client"</li><li>Fill in:<br>• Client Name: e.g. AI Agent<br>• Redirect Endpoint: <code>{server URL}/api/oauth/saas/kintone/callback</code></li><li>Click "Save" → Client ID and Client Secret will be generated</li><li>Under "External Integration" → "OAuth Scopes", add:<br>• <code>k:app_record:read</code> (read records)<br>• <code>k:app_record:write</code> (write records)</li><li>Enter your Instance URL below: <code>https://your-subdomain.cybozu.com</code></li><li>Copy Client ID and Client Secret into the fields below</li></ol>',
          saas_guide_smarthr_title: 'How to create a SmartHR OAuth App',
          saas_guide_smarthr: '<ol><li>Log in to <a href="https://app.smarthr.jp/" target="_blank" rel="noopener">SmartHR ↗</a> with an admin account</li><li>Click the top-right menu → "Common Settings" → "External Integrations"</li><li>Go to "OAuth Applications" tab → "Create New"</li><li>Fill in:<br>• Application Name: e.g. AI Agent<br>• Redirect URI: <code>{server URL}/api/oauth/saas/smarthr/callback</code></li><li>Select required scopes:<br>• <code>read</code> (read employee info)<br>• <code>write</code> (write employee info)</li><li>Click "Save" → Client ID and Client Secret will be generated</li><li>Enter your Instance URL below: <code>https://your-subdomain.smarthr.jp</code></li><li>Copy Client ID and Client Secret into the fields below</li></ol>',
          int_infra_title: 'Infrastructure Status',
          int_channels_title: 'Channel Integrations',
          int_env_title: 'Environment Variable Status',
          int_connected: 'Connected',
          int_disconnected: 'Not Connected',
          int_env_set: 'Configured',
          int_env_unset: 'Not Set',
          int_github_title: 'GitHub',
          int_supabase_title: 'Supabase',
          int_vercel_title: 'Vercel',
          int_notion_title: 'Notion',
          int_slack_title: 'Slack',
          int_gdrive_title: 'Google Drive',
          int_chatwork_title: 'Chatwork',
          int_connect_oauth: 'Connect with OAuth',
          int_save_token: 'Save',
          int_setup_steps: 'Setup Steps',
          int_notion_step1: 'Create a new Integration on the <a href="https://www.notion.so/profile/integrations" target="_blank" rel="noopener">Notion Integrations page ↗</a>',
          int_notion_step2: 'Enter Client ID and Secret in "App Settings" below',
          int_notion_step3: 'Click the "Connect with OAuth" button below to authorize',
          int_slack_step1: 'Create a new App on <a href="https://api.slack.com/apps" target="_blank" rel="noopener">Slack API Your Apps ↗</a>',
          int_slack_step2: 'Set Bot Token Scopes in OAuth & Permissions (channels:history, chat:write, files:read)',
          int_slack_step3: 'Enter Client ID and Client Secret in "App Settings" below',
          int_slack_step4: 'Click the "Connect with OAuth" button below to authorize',
          int_gdrive_step1: 'Configure the OAuth consent screen in <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener">GCP Console ↗</a>',
          int_gdrive_step2: 'Create an OAuth Client ID in Credentials (type: "Web application") and enter Client ID and Secret in "App Settings" below',
          int_gdrive_step3: 'Click the "Connect with OAuth" button below to authorize',
          int_chatwork_step1: 'Generate a new token on the <a href="https://www.chatwork.com/service/packages/chatwork/subpackages/api/token.php" target="_blank" rel="noopener">Chatwork API Token page ↗</a>',
          int_chatwork_step2: 'Paste the token in the field below and click "Save"',
          int_chatwork_saved: 'Chatwork token saved',
          int_chatwork_placeholder: 'Paste Chatwork API Token',
          int_no_url: 'Not configured',
          int_updated_at: 'Last updated',
          int_scopes: 'Scopes',
          int_env_not_configured: 'App credentials not configured. Set them in the dashboard first.',
          int_token_saved: 'Token saved',
          int_token_not_saved: 'Token not saved (ask your admin)',
          int_token_not_saved: 'Token not saved',
          int_token_save_hint_sb: 'Generate a token and save it below (required for future operations). <a href="https://supabase.com/dashboard/account/tokens" target="_blank" rel="noopener">Generate token on Supabase ↗</a>',
          int_token_save_hint_vc: 'Generate a token and save it below (required for future operations). <a href="https://vercel.com/account/tokens" target="_blank" rel="noopener">Generate token on Vercel ↗</a>',
          int_token_placeholder_sb: 'Paste Supabase Access Token',
          int_token_placeholder_vc: 'Paste Vercel API Token',
          int_infra_token_saved: 'Token saved successfully',
          int_expires_at: 'Expires',
          int_expires_at_placeholder: 'Expiration date (optional)',
          int_expires_none: 'No expiration',
          int_expires_edit: 'Edit',
          int_expires_save: 'Save',
          int_expires_saved: 'Expiration updated',
          int_expires_days_left: ' days left',
          int_expires_days_unit: ' days',
          int_expires_expired: 'Expired',
          int_expires_today: 'Expires today',
          int_reissue: 'Re-issue token',
          int_reconnect: 'Reconnect',
          int_reconnect_revoke_failed: 'Failed to revoke GitHub authorization. To connect a different account, log out of GitHub.com first, then reconnect. Continue anyway?',
          int_reconnect_provisioning_sb: 'Rebuilding Supabase...',
          int_reconnect_provisioning_vc: 'Rebuilding Vercel...',
          int_reconnect_success: 'Reconnect successful',
          int_vercel_deploy_hint: 'Deploying now. Please wait 1-2 minutes before accessing.',
          int_vercel_deploy_ready: 'Deployment complete.',
          int_vercel_deploy_error: 'Deployment failed. Check the Vercel dashboard for logs.',
          int_reconnect_failed: 'Reconnect failed: ',
          int_connect: 'Connect',
          int_vc_anon_key_hint: 'Optional — auto-sets the NEXT_PUBLIC_SUPABASE_ANON_KEY env var in Vercel. You can connect without it.',
          int_vc_github_login_hint: 'To link a GitHub repo in Vercel, two things are required: 1) Add a GitHub Login Connection to your Vercel account 2) Install the Vercel App on GitHub',
          int_disconnect: 'Disconnect',
          int_disconnect_confirm: ' will be disconnected. Infra settings, tokens, and onboarding status will be reset.',
          int_disconnected: 'Disconnected successfully',
          int_ch_config_title: 'App Settings',
          int_ch_config_save: 'Save Settings',
          int_ch_config_saved: 'Settings saved',
          int_ch_config_delete: 'Delete Settings',
          int_ch_config_deleted: 'Settings deleted',
          int_ch_webhook_url: 'Webhook URL',
          int_ch_redirect_uri: 'Redirect URI (register in OAuth provider)',
          int_ch_webhook_copy: 'Copy',
          int_ch_webhook_copied: 'Copied',
          int_ch_or_env: 'Configure in App Settings in the dashboard',
          int_ch_config_hint: 'Enter your OAuth App credentials here. Required to connect.',
          settings: 'Settings',
          auto_execute_title: 'Auto Execute',
          auto_exec_on: 'Auto Execute: ON (runs full pipeline immediately)',
          auto_exec_off: 'Auto Execute: OFF (pauses after spec for review)',
          settings_error: 'Error loading settings',
          settings_save_error: 'Error saving settings',
          company_info_title: 'Company Information',
          members_title: 'Members',
          no_company: 'No company configured.',
          no_members: 'No members yet.',
          member_remove: 'Remove',
          member_remove_confirm: 'Remove this member?',
          invite_generate: 'Generate Invite Link',
          invite_expires: 'Valid for 7 days (single use)',
          invite_copied: 'Copied',
          invite_invalid: 'This invite link is invalid or expired.',
          invite_consumed: 'Successfully joined via invite link.',
          company_login: 'Join Existing Company',
          company_login_btn: 'Join',
          company_login_hint: 'Enter the company ID and password to join.',
          password_placeholder: 'Corporate Password',
          password_confirm_placeholder: 'Corporate Password (confirm)',
          password_hint: 'At least 8 characters with uppercase, lowercase, and digits',
          password_required: 'Please enter a password.',
          password_mismatch: 'Passwords do not match.',
          password_weak: 'Password must be at least 8 characters with uppercase, lowercase, and digits.',
          login_failed: 'Invalid company ID or password.',
          logout_btn: 'Logout',
          next_proposal: 'Next System Proposal',
          no_proposal: 'No proposals yet. Run an agent to accumulate data.',
          load_failed: 'Failed to load.',
          run_list: 'Run List',
          filter_all: 'All',
          filter_spec_review: 'Spec Review',
          filter_in_progress: 'In Progress',
          filter_published: 'Published',
          filter_failed: 'Failed',
          no_runs: 'No runs found.',
          runs_load_failed: 'Failed to load runs.',
          detail: 'Detail',
          select_run: 'Select a run from the list.',
          loading: 'Loading...',
          spec_document: 'Spec Document',
          start_impl: 'Start Implementation',
          implementing: 'Implementing...',
          summary: 'Summary',
          generated_files: 'Generated Files',
          detail_load_failed: 'Failed to load details.',
          no_detail: 'No details available for this run.',
          updated: 'Updated',
          status_processing: 'Processing',
          status_spec_review: 'Spec Review',
          status_implementing: 'Implementing',
          status_published: 'Published',
          status_failed: 'Failed',
          company_setup: 'Company Setup',
          company_setup_desc: 'Create a new company or join an existing one to get started.',
          company_create: 'Create New Company',
          company_join: 'Join Company',
          company_name_placeholder: 'Company Name (e.g. ABC Corp)',
          company_id_label: 'Company ID',
          company_id_hint: 'Alphanumeric and hyphens only. Used to identify your company. Cannot be changed later.',
          company_slug_placeholder: 'my-company',
          company_join_hint: 'Enter the company ID shared by your team admin.',
          company_join_placeholder: 'e.g. my-company',
          company_create_btn: 'Create',
          company_join_btn: 'Join',
          company_created: 'Company created successfully.',
          company_joined: 'Joined company successfully.',
          company_slug_taken: 'This company ID is already taken.',
          company_not_found: 'Company ID not found. Please check with your admin.',
          company_error: 'An error occurred.',
          company_confirm_create: 'Create a company with the following details? A company ID will be auto-generated.',
          company_confirm_join: 'Join the following company?',
          company_confirm_name: 'Company Name',
          company_confirm_id: 'Company ID',
          employee_count_label: 'Employee Count',
          annual_revenue_label: 'Annual Revenue',
          industry_label: 'Industry',
          founded_date_label: 'Founded Date',
          select_placeholder: '-- Select --',
          rev_under1: 'Under 100M JPY',
          rev_1_10: '100M - 1B JPY',
          rev_10_50: '1B - 5B JPY',
          rev_50_100: '5B - 10B JPY',
          rev_over100: 'Over 10B JPY',
          ind_manufacturing: 'Manufacturing',
          ind_it: 'IT / Telecom',
          ind_retail: 'Retail / Wholesale',
          ind_construction: 'Construction / Real Estate',
          ind_healthcare: 'Healthcare / Welfare',
          ind_food: 'Food / Restaurant',
          ind_finance: 'Finance / Insurance',
          ind_education: 'Education',
          ind_logistics: 'Logistics / Transport',
          ind_agriculture: 'Agriculture / Forestry / Fishery',
          ind_energy: 'Energy / Infrastructure',
          ind_staffing: 'Staffing / Recruitment',
          ind_media: 'Advertising / Media',
          ind_consulting: 'Consulting',
          ind_beauty: 'Beauty / Wellness',
          ind_travel: 'Travel / Tourism',
          ind_service: 'Service Industry',
          ind_other: 'Other',
          company_confirm_employees: 'Employees',
          company_confirm_revenue: 'Revenue',
          company_confirm_industry: 'Industry',
          company_confirm_corp_num: 'Corporate Number',
          ac_join_hint: 'This company already exists. Use the "Join Company" tab to join.',
          ob_profile_title: 'Enter your company information',
          ob_profile_desc: 'Required for AI Agent to provide optimal proposals for your company.',
          ob_profile_save: 'Save',
          ob_profile_saved: 'Saved successfully',
          ob_profile_done: 'Company Profile Complete',
          onboarding_title: 'Onboarding',
          ob_github_repo: 'Create GitHub Repository',
          ob_github_repo_desc: 'Create a private repo for the client',
          ob_github_repo_cmd: 'gh repo create {org}/{company}-dashboard --private',
          ob_github_initial_commit: 'Initial Commit (Next.js Boilerplate)',
          ob_github_initial_commit_desc: 'Push Sidebar, GenreCard, Supabase connection',
          ob_github_initial_commit_cmd: 'bash scripts/onboarding.sh --company {slug} --org {org}',
          ob_vercel_project: 'Create Vercel Project',
          ob_vercel_project_desc: 'Link to GitHub repo, auto-deploy on main push',
          ob_vercel_env: 'Set Vercel Environment Variables',
          ob_vercel_env_desc: 'NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, etc.',
          ob_supabase_project: 'Create Client Supabase Project',
          ob_supabase_project_desc: 'New Supabase project for business data',
          ob_supabase_tables: 'Create Common Tables (Run SQL)',
          ob_supabase_tables_desc: 'Execute agent_outputs table SQL in SQL Editor',
          ob_secret_manager_token: 'Store Token in GCP Secret Manager',
          ob_secret_manager_token_desc: 'Save GitHub token in Secret Manager (never store plaintext in DB)',
          ob_secret_manager_token_cmd: 'gcloud secrets create github-token-{slug} --data-file=<token>',
          ob_env_github_repository: 'Set GITHUB_REPOSITORY',
          ob_env_github_repository_desc: 'Update .env.local GITHUB_REPOSITORY to client repo',
          ob_all_done: 'Onboarding complete! AI Agent is ready.',
          infra_github_repo: 'GitHub Repository',
          infra_github_repo_ph: 'org/company-dashboard',
          infra_github_token: 'Secret Manager Secret Name',
          infra_github_token_ph: 'github-token-company-a',
          infra_supabase_url: 'Client Supabase URL',
          infra_supabase_url_ph: 'https://xxxxx.supabase.co',
          infra_vercel_url: 'Vercel Deploy URL',
          infra_vercel_url_ph: 'https://company-dashboard.vercel.app',
          infra_section_title: 'Infrastructure Settings',
          infra_section_desc: 'Connection details configured via CLI script (onboarding.sh). To change, re-run the CLI script.',
          infra_not_set: 'Not configured',
          ob_card_github_title: 'Step 1: GitHub',
          ob_card_github_connect: 'Connect with GitHub',
          ob_card_github_connecting: 'Connecting to GitHub...',
          ob_card_github_provisioning: 'Creating repository...',
          ob_card_github_done: 'Connected',
          ob_card_github_step_repo: 'Repository created',
          ob_card_github_step_commit: 'Initial commit',
          ob_card_supabase_title: 'Step 2: Supabase',
          ob_card_supabase_connect: 'Connect',
          ob_card_supabase_pat_help: 'Generate a token from the link below and paste it above.',
          ob_card_supabase_pat_link: 'Generate token on Supabase',
          ob_card_supabase_provisioning: 'Creating project (may take a minute)...',
          ob_card_supabase_done: 'Connected',
          ob_card_supabase_step_project: 'Project created',
          ob_card_supabase_step_tables: 'Tables initialized',
          ob_card_supabase_tables_retry: 'Project created, but table initialization failed.',
          ob_card_supabase_retry: 'Retry table initialization',
          ob_card_supabase_retrying: 'Initializing tables...',
          ob_card_vercel_title: 'Step 3: Vercel',
          ob_card_vercel_connect: 'Connect',
          ob_card_vercel_token_help: 'Generate a token from the link below and paste it above.',
          ob_card_vercel_token_link: 'Generate token on Vercel',
          ob_card_vercel_provisioning: 'Creating project...',
          ob_card_vercel_done: 'Connected',
          ob_card_vercel_step_project: 'Project created',
          ob_card_vercel_step_env: 'Environment variables set',
          ob_card_vercel_requires_github: 'Complete GitHub connection first',
          ob_card_supabase_anon_key: 'Supabase Anon Key (optional)',
          ob_provision_failed: 'Error: ',
          bpo_title: 'AI Employee',
          bpo_task_input: 'Task Input',
          bpo_select_saas: '-- Select SaaS --',
          bpo_task_placeholder: 'e.g. Create unpaid invoices for this month in freee',
          bpo_submit: 'Execute',
          bpo_dryrun_label: 'Dry run (no actual SaaS operations)',
          bpo_task_list: 'Task List',
          bpo_filter_planning: 'Planning',
          bpo_filter_awaiting: 'Awaiting',
          bpo_filter_executing: 'Executing',
          bpo_filter_completed: 'Completed',
          bpo_filter_failed: 'Failed',
          bpo_no_tasks: 'No tasks yet.',
          bpo_task_detail: 'Task Detail',
          bpo_select_task: 'Select a task from the list.',
          bpo_status_planning: 'Planning',
          bpo_status_awaiting: 'Awaiting Approval',
          bpo_status_executing: 'Executing',
          bpo_status_completed: 'Completed',
          bpo_status_failed: 'Failed',
          bpo_status_rejected: 'Rejected',
          bpo_plan_title: 'Execution Plan',
          bpo_failure_reason: 'Error Reason',
          bpo_failure_detail: 'Details',
          bpo_approve: 'Approve & Execute',
          bpo_reject: 'Reject',
          bpo_approving: 'Starting execution...',
          bpo_result_title: 'Results',
          bpo_success_count: 'Success',
          bpo_failure_count: 'Failed',
          bpo_total_ops: 'Total Operations',
          bpo_errors_title: 'Error Details',
          bpo_task_creating: 'Creating task...',
          bpo_task_created: 'Task created. Generating plan...',
          bpo_task_create_failed: 'Failed to create task.',
          bpo_no_connection: 'Please select a SaaS connection.',
          bpo_no_description: 'Please enter a task description.',
          bpo_summary_total: 'Total',
          bpo_summary_awaiting: 'Awaiting',
          bpo_summary_success_rate: 'Success Rate',
          bpo_summary_running: 'Running',
          bpo_report_title: 'Result Report',
          bpo_created_at: 'Created',
          bpo_saas: 'SaaS',
        }
      };

      let currentLang = localStorage.getItem('dashboard_lang') || 'ja';

      function t(key) {
        return (I18N[currentLang] || I18N.ja)[key] || (I18N.ja)[key] || key;
      }

      function applyI18n() {
        document.title = t('page_title');
        document.documentElement.lang = currentLang;
        document.querySelectorAll('[data-i18n]').forEach(el => {
          el.textContent = t(el.dataset.i18n);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          el.placeholder = t(el.dataset.i18nPlaceholder);
        });
        document.querySelectorAll('select option[data-i18n]').forEach(opt => {
          opt.textContent = t(opt.dataset.i18n);
        });
      }

      function initLangSelectors() {
        ['lang-select', 'login-lang-select', 'setup-lang-select'].forEach(id => {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = '<option value="ja"' + (currentLang === 'ja' ? ' selected' : '') + '>日本語</option>' +
                          '<option value="en"' + (currentLang === 'en' ? ' selected' : '') + '>English</option>';
          sel.addEventListener('change', () => {
            currentLang = sel.value;
            localStorage.setItem('dashboard_lang', currentLang);
            ['lang-select', 'login-lang-select', 'setup-lang-select'].forEach(oid => {
              const other = document.getElementById(oid);
              if (other && other !== sel) other.value = currentLang;
            });
            applyI18n();
            updateToggleLabel(toggleEl.checked);
            renderRuns();
            if (!selectedRunId) {
              detailEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('select_run')) + '</span>';
            }
            renderSettingsCompanyInfo();
            loadMembers();
            renderInviteSection();
          });
        });
      }

      // ===== Auth State =====
      let supabaseClient = null;
      let accessToken = null;
      let requireAuth = false;

      // ===== DOM Elements =====
      const loginScreen = document.getElementById('login-screen');
      const mainApp = document.getElementById('main-app');
      const authBar = document.getElementById('auth-bar');
      const authEmailEl = document.getElementById('auth-email');
      const loginBtn = document.getElementById('login-btn');
      const loginMagicBtn = document.getElementById('login-magic-btn');
      const loginEmailInput = document.getElementById('login-email');
      const loginPasswordInput = document.getElementById('login-password-input');
      const loginMsgEl = document.getElementById('login-msg');
      const logoutBtn = document.getElementById('logout-btn');

      const suggestionEl = document.getElementById('suggestion');
      const suggestionMetaEl = document.getElementById('suggestion-meta');
      const runsEl = document.getElementById('runs');
      const detailEl = document.getElementById('detail');
      const toggleEl = document.getElementById('auto-execute-toggle');
      const toggleLabelEl = document.getElementById('auto-execute-label');

      function statusMap() {
        return {
          'started':    { label: t('status_processing'),    badge: 'badge-started' },
          'spec_done':  { label: t('status_spec_review'),   badge: 'badge-spec_review' },
          'spec_review':{ label: t('status_spec_review'),   badge: 'badge-spec_review' },
          'coding':     { label: t('status_implementing'),  badge: 'badge-coding' },
          'review_ok':  { label: t('status_implementing'),  badge: 'badge-review_ok' },
          'review_ng':  { label: t('status_implementing'),  badge: 'badge-review_ng' },
          'published':  { label: t('status_published'),     badge: 'badge-published' },
          'failed':     { label: t('status_failed'),        badge: 'badge-failed' },
          'timeout':    { label: t('status_failed'),        badge: 'badge-timeout' },
        };
      }

      let allRuns = [];
      let currentFilter = 'all';
      let selectedRunId = null;
      let refreshInterval = null;

      function escapeHtml(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      // ===== Vercel deploy status =====
      var _vcDeployState = null; // null=未確認, 'BUILDING', 'READY', 'ERROR', etc.
      var _vcDeployPollTimer = null;

      // 状態に応じた HTML を返す
      function vcDeployStatusHtml() {
        if (_vcDeployState === 'READY') {
          return '<span style="color:#2e7d32">&#10003; ' + escapeHtml(t('int_vercel_deploy_ready')) + '</span>';
        } else if (_vcDeployState === 'ERROR' || _vcDeployState === 'CANCELED') {
          return '<span style="color:#c62828">&#10007; ' + escapeHtml(t('int_vercel_deploy_error')) + '</span>';
        }
        return '<span style="color:#e65100">&#9203; ' + escapeHtml(t('int_vercel_deploy_hint')) + '</span>';
      }

      // 全 deploy-status 要素を更新
      function _updateAllVcDeployEls() {
        var html = vcDeployStatusHtml();
        document.querySelectorAll('.vc-deploy-status').forEach(function(el) { el.innerHTML = html; });
      }

      // API でデプロイ状態を1回チェック
      async function _checkVcDeployOnce() {
        try {
          var res = await apiFetch('/api/integrations/vercel/deploy-status');
          if (!res.ok) return;
          var data = await res.json();
          _vcDeployState = data.state || 'UNKNOWN';
          _updateAllVcDeployEls();
          return data;
        } catch (e) { return null; }
      }

      // ポーリング開始（即時チェック + 15秒間隔、最大5分）
      function pollVercelDeployStatus() {
        // 既にポーリング中なら何もしない
        if (_vcDeployPollTimer) return;
        var attempts = 0;
        var maxAttempts = 20;
        // 即時チェック
        _checkVcDeployOnce().then(function(data) {
          if (data && (data.ready || data.state === 'ERROR' || data.state === 'CANCELED')) return;
          // まだビルド中なら定期ポーリング開始
          _vcDeployPollTimer = setInterval(async function() {
            attempts++;
            if (attempts > maxAttempts) { clearInterval(_vcDeployPollTimer); _vcDeployPollTimer = null; return; }
            var d = await _checkVcDeployOnce();
            if (d && (d.ready || d.state === 'ERROR' || d.state === 'CANCELED')) {
              clearInterval(_vcDeployPollTimer);
              _vcDeployPollTimer = null;
            }
          }, 15000);
        });
      }

      // ===== apiFetch =====
      function apiFetch(url, options) {
        options = options || {};
        options.headers = options.headers || {};
        if (accessToken) {
          options.headers['Authorization'] = 'Bearer ' + accessToken;
        }
        if (!accessToken) {
          const cid = localStorage.getItem('dashboard_company_id');
          if (cid) {
            options.headers['X-Company-ID'] = cid;
          }
        }
        return fetch(url, options);
      }

      // ===== Sidebar Navigation =====
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      const hamburgerBtn = document.getElementById('hamburger');
      const sidebarCloseBtn = document.getElementById('sidebar-close');

      function switchPanel(panelId) {
        // Migrate old panel IDs
        if (panelId === 'panel-onboarding' || panelId === 'panel-integrations') panelId = 'panel-setup';
        document.querySelectorAll('.content-panel').forEach(p => { p.classList.remove('active'); p.style.display = ''; });
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        const panel = document.getElementById(panelId);
        if (panel) panel.classList.add('active');
        const navItem = document.querySelector('.sidebar-item[data-panel="' + panelId + '"]');
        if (navItem) navItem.classList.add('active');
        closeSidebar();
        localStorage.setItem('dashboard_active_panel', panelId);
      }

      function openSidebar() { sidebar.classList.add('open'); sidebarOverlay.classList.add('active'); }
      function closeSidebar() { sidebar.classList.remove('open'); sidebarOverlay.classList.remove('active'); }

      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', () => switchPanel(item.dataset.panel));
      });
      hamburgerBtn.addEventListener('click', openSidebar);
      sidebarCloseBtn.addEventListener('click', closeSidebar);
      sidebarOverlay.addEventListener('click', closeSidebar);

      // ===== Auth Initialization =====
      async function initAuth() {
        // Handle invite token from URL
        await handleInviteToken();

        try {
          const res = await fetch('/api/auth/config');
          const config = await res.json();
          requireAuth = config.require_auth;

          if (!requireAuth) {
            showApp();
            return;
          }

          if (!config.supabase_url || !config.supabase_anon_key) {
            loginMsgEl.textContent = t('login_config_missing');
            loginMsgEl.className = 'login-msg error';
            loginScreen.style.display = '';
            return;
          }

          supabaseClient = supabase.createClient(config.supabase_url, config.supabase_anon_key);

          supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session) {
              accessToken = session.access_token;
              showApp(session.user.email);
            } else {
              accessToken = null;
              showLogin();
            }
          });

          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session) {
            accessToken = session.access_token;
            showApp(session.user.email);
          } else {
            showLogin();
          }
        } catch (e) {
          loginMsgEl.textContent = t('login_init_failed');
          loginMsgEl.className = 'login-msg error';
          loginScreen.style.display = '';
        }
      }

      function showLogin() {
        loginScreen.style.display = '';
        mainApp.style.display = 'none';
        if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
      }

      const companySetup = document.getElementById('company-setup');

      async function showApp(email) {
        loginScreen.style.display = 'none';
        companySetup.style.display = 'none';

        if (requireAuth && email) {
          try {
            const res = await apiFetch('/api/company/me');
            const data = await res.json();
            if (!data.company) {
              showCompanySetup(email);
              return;
            }
          } catch (e) {}
        } else if (!requireAuth) {
          const cid = localStorage.getItem('dashboard_company_id');
          if (!cid) {
            showCompanySetup('');
            return;
          }
          try {
            const res = await apiFetch('/api/company/me');
            const data = await res.json();
            if (!data.company) {
              localStorage.removeItem('dashboard_company_id');
              showCompanySetup('');
              return;
            }
          } catch (e) {}
        }

        mainApp.style.display = 'flex';
        if (requireAuth && email) {
          authBar.style.display = '';
          authEmailEl.textContent = email;
        }

        // Restore last active panel
        const savedPanel = localStorage.getItem('dashboard_active_panel');
        if (savedPanel) switchPanel(savedPanel);

        // Restore toggle states
        restoreToggleStates();

        // Handle GitHub OAuth callback — loadOnboarding より先にフラグを立てる
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('github_connected') === 'true') {
          window.history.replaceState({}, '', window.location.pathname);
          githubProvisioningInProgress = true;
          switchPanel('panel-setup');
        }

        loadSettings();
        loadOnboarding();
        loadSuggestion();
        loadRuns();
        loadIntegrations();
        loadBpoTasks();
        loadBpoConnections();
        loadSaasConnections();
        renderSettingsCompanyInfo();
        loadMembers();
        renderInviteSection();
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(function() { loadRuns(); loadBpoTasks(); }, 30000);

        // GitHub OAuth callback: loadOnboarding の描画完了後にプロビジョニング開始
        if (githubProvisioningInProgress) {
          setTimeout(() => provisionGitHub(), 300);
        }
      }

      function showCompanySetup(email) {
        loginScreen.style.display = 'none';
        mainApp.style.display = 'none';
        companySetup.style.display = '';
        applyI18n();
      }

      // ===== Invite Token Consumption =====
      async function handleInviteToken() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('invite');
        if (!token) return;
        try {
          const res = await fetch('/api/company/join-by-invite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token }),
          });
          if (res.ok) {
            const data = await res.json();
            if (data.company && data.company.id) {
              localStorage.setItem('dashboard_company_id', data.company.id);
            }
            window.history.replaceState({}, '', '/dashboard');
          }
        } catch (e) {}
      }

      // ===== Login (Password) =====
      loginBtn.addEventListener('click', async () => {
        const email = loginEmailInput.value.trim();
        const password = loginPasswordInput.value;
        if (!email) {
          loginMsgEl.textContent = t('login_email_required');
          loginMsgEl.className = 'login-msg error';
          return;
        }
        if (!password) {
          loginMsgEl.textContent = t('login_password_required');
          loginMsgEl.className = 'login-msg error';
          return;
        }
        loginBtn.disabled = true;
        loginMagicBtn.disabled = true;
        loginMsgEl.textContent = t('login_authenticating');
        loginMsgEl.className = 'login-msg';
        try {
          const { error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
          });
          if (error) {
            loginMsgEl.textContent = error.message;
            loginMsgEl.className = 'login-msg error';
          }
        } catch (e) {
          loginMsgEl.textContent = t('login_error');
          loginMsgEl.className = 'login-msg error';
        }
        loginBtn.disabled = false;
        loginMagicBtn.disabled = false;
      });

      // ===== Login (Magic Link) =====
      loginMagicBtn.addEventListener('click', async () => {
        const email = loginEmailInput.value.trim();
        if (!email) {
          loginMsgEl.textContent = t('login_email_required');
          loginMsgEl.className = 'login-msg error';
          return;
        }
        loginMagicBtn.disabled = true;
        loginBtn.disabled = true;
        loginMsgEl.textContent = t('login_sending');
        loginMsgEl.className = 'login-msg';
        try {
          const { error } = await supabaseClient.auth.signInWithOtp({
            email: email,
            options: { emailRedirectTo: window.location.origin + '/dashboard' }
          });
          if (error) {
            loginMsgEl.textContent = error.message;
            loginMsgEl.className = 'login-msg error';
          } else {
            loginMsgEl.textContent = t('login_sent');
            loginMsgEl.className = 'login-msg success';
          }
        } catch (e) {
          loginMsgEl.textContent = t('login_error');
          loginMsgEl.className = 'login-msg error';
        }
        loginMagicBtn.disabled = false;
        loginBtn.disabled = false;
      });

      // ===== Logout =====
      function doLogout() {
        if (supabaseClient) {
          supabaseClient.auth.signOut();
        }
        accessToken = null;
        localStorage.removeItem('dashboard_company_id');
        localStorage.removeItem('dashboard_active_panel');
        if (requireAuth) {
          showLogin();
        } else {
          showCompanySetup('');
        }
      }

      logoutBtn.addEventListener('click', doLogout);

      // Settings panel logout button
      document.getElementById('settings-logout-btn').addEventListener('click', doLogout);

      // ===== Set Password =====
      document.getElementById('set-password-btn').addEventListener('click', async () => {
        const pw = document.getElementById('set-password-input').value;
        const pwConfirm = document.getElementById('set-password-confirm').value;
        const msgEl = document.getElementById('set-password-msg');
        if (!pw) { msgEl.textContent = t('password_required'); msgEl.className = 'login-msg error'; return; }
        if (!isStrongPassword(pw)) { msgEl.textContent = t('set_password_weak'); msgEl.className = 'login-msg error'; return; }
        if (pw !== pwConfirm) { msgEl.textContent = t('set_password_mismatch'); msgEl.className = 'login-msg error'; return; }
        document.getElementById('set-password-btn').disabled = true;
        msgEl.textContent = t('set_password_saving');
        msgEl.className = 'login-msg';
        try {
          const { error } = await supabaseClient.auth.updateUser({ password: pw });
          if (error) {
            msgEl.textContent = error.message;
            msgEl.className = 'login-msg error';
          } else {
            msgEl.textContent = t('set_password_success');
            msgEl.className = 'login-msg success';
            document.getElementById('set-password-input').value = '';
            document.getElementById('set-password-confirm').value = '';
          }
        } catch (e) {
          msgEl.textContent = t('login_error');
          msgEl.className = 'login-msg error';
        }
        document.getElementById('set-password-btn').disabled = false;
      });

      // ===== Settings =====
      function loadSettings() {
        apiFetch('/api/settings')
          .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
          .then(data => {
            toggleEl.checked = data.auto_execute;
            updateToggleLabel(data.auto_execute);
          })
          .catch(() => { toggleLabelEl.textContent = t('settings_error'); });
      }

      function updateToggleLabel(isOn) {
        toggleLabelEl.textContent = isOn ? t('auto_exec_on') : t('auto_exec_off');
      }

      toggleEl.addEventListener('change', () => {
        apiFetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ auto_execute: toggleEl.checked })
        })
        .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
        .then(d => updateToggleLabel(d.auto_execute))
        .catch(() => { toggleLabelEl.textContent = t('settings_save_error'); });
      });

      // ===== Settings: Company Info =====
      function renderSettingsCompanyInfo() {
        const container = document.getElementById('settings-company-info');
        if (!container) return;
        Promise.all([
          apiFetch('/api/company/me').then(r => r.ok ? r.json() : { company: null }),
          apiFetch('/api/company/profile').then(r => r.ok ? r.json() : {}),
        ]).then(([meData, profileData]) => {
          const c = meData.company;
          if (!c) {
            container.innerHTML = '<span class="empty-msg">' + escapeHtml(t('no_company')) + '</span>';
            return;
          }
          const rows = [
            [t('company_confirm_name'), c.name || '-', ''],
            [t('company_confirm_id'), c.slug || '-', 'mono'],
            [t('company_confirm_corp_num'), c.corporate_number || '-', 'mono'],
            [t('employee_count_label'), profileData.employee_count || '-', ''],
            [t('annual_revenue_label'), profileData.annual_revenue || '-', ''],
            [t('industry_label'), profileData.industry || '-', ''],
            [t('founded_date_label'), profileData.founded_date || '-', ''],
          ];
          let html = '<div class="company-info-card">';
          rows.forEach(([label, val, cls]) => {
            html += '<div class="company-info-row"><label>' + escapeHtml(label) + '</label>';
            html += '<span class="ci-val' + (cls ? ' ' + cls : '') + '">' + escapeHtml(val) + '</span></div>';
          });
          html += '</div>';
          container.innerHTML = html;
        }).catch(() => {
          container.innerHTML = '<span class="error">' + escapeHtml(t('load_failed')) + '</span>';
        });
      }

      // ===== Settings: Members =====
      function loadMembers() {
        const listEl = document.getElementById('member-list');
        if (!listEl) return;
        const section = document.getElementById('members-section');
        if (section) section.style.display = '';

        apiFetch('/api/company/members')
          .then(r => r.ok ? r.json() : { members: [] })
          .then(data => {
            const members = data.members || [];
            if (members.length === 0) {
              listEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('no_members')) + '</span>';
              return;
            }
            listEl.innerHTML = members.map(m => {
              const uid = m.user_id || '';
              const display = m.email || (uid.length > 12 ? uid.slice(0, 8) + '...' : uid);
              return '<div class="member-row">' +
                '<span class="member-id" title="' + escapeHtml(m.email || uid) + '">' + escapeHtml(display) + '</span>' +
                '<span class="member-role">' + escapeHtml(m.role || 'member') + '</span>' +
                (m.role !== 'owner' ? '<button class="member-remove" data-uid="' + escapeHtml(uid) + '">' + escapeHtml(t('member_remove')) + '</button>' : '') +
              '</div>';
            }).join('');

            listEl.querySelectorAll('.member-remove').forEach(btn => {
              btn.addEventListener('click', () => {
                if (!confirm(t('member_remove_confirm'))) return;
                apiFetch('/api/company/members/' + encodeURIComponent(btn.dataset.uid), { method: 'DELETE' })
                  .then(r => { if (r.ok) loadMembers(); });
              });
            });
          });
      }

      // ===== Settings: Invite =====
      function renderInviteSection() {
        const container = document.getElementById('invite-section');
        if (!container) return;

        container.innerHTML = '<div class="invite-box">' +
          '<button id="generate-invite-btn">' + escapeHtml(t('invite_generate')) + '</button>' +
          '<div class="invite-msg" id="invite-msg"></div>' +
        '</div>';

        document.getElementById('generate-invite-btn').addEventListener('click', () => {
          const btn = document.getElementById('generate-invite-btn');
          btn.disabled = true;
          apiFetch('/api/company/invite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: 'member' }),
          })
          .then(r => r.ok ? r.json() : null)
          .then(data => {
            const msgEl = document.getElementById('invite-msg');
            if (data && data.token) {
              const inviteUrl = window.location.origin + '/dashboard?invite=' + data.token;
              msgEl.innerHTML = '<div class="invite-url">' + escapeHtml(inviteUrl) + '</div>' +
                '<div style="font-size:0.8rem;color:#888;">' + escapeHtml(t('invite_expires')) + '</div>';
            }
            btn.disabled = false;
          })
          .catch(() => { btn.disabled = false; });
        });
      }

      // ===== Suggestion =====
      function loadSuggestion() {
        apiFetch('/api/next-system-suggestion')
          .then(r => r.ok ? r.json() : null)
          .then(data => {
            if (data && data.content) {
              suggestionEl.textContent = data.content;
              suggestionMetaEl.textContent = data.updated_at ? t('updated') + ': ' + data.updated_at : '';
            } else {
              suggestionEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('no_proposal')) + '</span>';
              suggestionMetaEl.textContent = '';
            }
          })
          .catch(() => {
            suggestionEl.innerHTML = '<span class="error">' + escapeHtml(t('load_failed')) + '</span>';
          });
      }

      // ===== Status Filters =====
      function matchesFilter(status, filter) {
        if (filter === 'all') return true;
        if (filter === 'spec_review') return status === 'spec_review' || status === 'spec_done';
        if (filter === 'coding') return status === 'coding' || status === 'review_ok' || status === 'review_ng' || status === 'started';
        if (filter === 'failed') return status === 'failed' || status === 'timeout';
        return status === filter;
      }

      document.getElementById('status-filters').addEventListener('click', (e) => {
        if (!e.target.classList.contains('status-filter')) return;
        document.querySelectorAll('.status-filter').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        renderRuns();
      });

      // ===== Runs =====
      function loadRuns() {
        apiFetch('/api/runs')
          .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
          .then(data => {
            allRuns = data.runs || [];
            renderRuns();
          })
          .catch(() => { runsEl.innerHTML = '<li class="error">' + escapeHtml(t('runs_load_failed')) + '</li>'; });
      }

      function renderRuns() {
        const filtered = allRuns.filter(r => matchesFilter(r.status, currentFilter));
        if (filtered.length === 0) {
          runsEl.innerHTML = '<li class="empty-msg">' + escapeHtml(t('no_runs')) + '</li>';
          return;
        }
        const sm = statusMap();
        runsEl.innerHTML = filtered.map(r => {
          const info = sm[r.status] || { label: r.status, badge: 'badge-started' };
          const purpose = (r.spec_purpose || r.requirement_summary || '').slice(0, 80);
          const date = r.created_at ? new Date(r.created_at).toLocaleString(currentLang === 'ja' ? 'ja' : 'en') : '';
          const sel = r.run_id === selectedRunId ? ' selected' : '';
          return '<li class="status-' + (r.status || 'started') + sel + '" data-run-id="' + escapeHtml(r.run_id || '') + '" data-status="' + escapeHtml(r.status || '') + '">' +
            '<span class="badge ' + info.badge + '">' + escapeHtml(info.label) + '</span>' +
            '<div class="run-info">' +
              '<div class="run-title">' + escapeHtml(r.run_id || '-') + '</div>' +
              '<div class="run-desc">' + escapeHtml(purpose) + '</div>' +
            '</div>' +
            '<span class="meta">' + escapeHtml(date) + '</span>' +
          '</li>';
        }).join('');

        runsEl.querySelectorAll('li[data-run-id]').forEach(li => {
          li.addEventListener('click', () => {
            runsEl.querySelectorAll('li').forEach(l => l.classList.remove('selected'));
            li.classList.add('selected');
            selectedRunId = li.dataset.runId;
            loadDetail(li.dataset.runId, li.dataset.status);
          });
        });
      }

      // ===== Detail =====
      function loadDetail(runId, status) {
        if (!runId) {
          detailEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('select_run')) + '</span>';
          return;
        }
        detailEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('loading')) + '</span>';

        Promise.all([
          apiFetch('/api/features?run_id=' + encodeURIComponent(runId)).then(r => r.json()),
          apiFetch('/api/runs/' + encodeURIComponent(runId) + '/spec').then(r => r.ok ? r.json() : { spec_markdown: '' }),
        ]).then(([featData, specData]) => {
          let html = '';

          if (specData.spec_markdown) {
            html += '<h3>' + escapeHtml(t('spec_document')) + '</h3>';
            html += '<div class="spec-preview">' + escapeHtml(specData.spec_markdown) + '</div>';
          }

          if (status === 'spec_review' || status === 'spec_done') {
            html += '<button class="btn-implement" id="btn-implement">' + escapeHtml(t('start_impl')) + '</button>';
          }

          const features = featData.features || [];
          if (features.length > 0) {
            const f = features[0];
            html += '<h3>' + escapeHtml(t('summary')) + '</h3><p>' + escapeHtml(f.summary || '-') + '</p>';
            const files = f.file_list || [];
            if (files.length) {
              html += '<h3>' + escapeHtml(t('generated_files')) + '</h3><ul>' + files.map(fn => '<li><code>' + escapeHtml(fn) + '</code></li>').join('') + '</ul>';
            }
          }

          if (!html) {
            html = '<span class="empty-msg">' + escapeHtml(t('no_detail')) + '</span>';
          }

          detailEl.innerHTML = html;

          const btn = document.getElementById('btn-implement');
          if (btn) {
            btn.addEventListener('click', () => {
              btn.disabled = true;
              btn.textContent = t('implementing');
              apiFetch('/run/' + encodeURIComponent(runId) + '/implement', { method: 'POST' })
                .then(r => {
                  if (!r.ok) return r.json().then(d => { throw new Error(d.detail || 'Error'); });
                  return r.json();
                })
                .then(data => {
                  btn.textContent = 'Done: ' + data.status;
                  if (data.status === 'published') {
                    btn.style.background = '#4caf50';
                  }
                  loadRuns();
                })
                .catch(err => {
                  btn.textContent = 'Failed: ' + err.message;
                  btn.style.background = '#c62828';
                  btn.disabled = false;
                });
            });
          }
        }).catch(() => {
          detailEl.innerHTML = '<span class="error">' + escapeHtml(t('detail_load_failed')) + '</span>';
        });
      }

      // ===== Company Setup =====
      const tabCreate = document.getElementById('tab-create');
      const tabJoin = document.getElementById('tab-join');
      const setupCreate = document.getElementById('setup-create');
      const setupJoin = document.getElementById('setup-join');
      const setupMsg = document.getElementById('setup-msg');

      tabCreate.addEventListener('click', () => {
        tabCreate.classList.add('active');
        tabJoin.classList.remove('active');
        setupCreate.style.display = '';
        setupJoin.style.display = 'none';
        setupMsg.textContent = '';
      });
      tabJoin.addEventListener('click', () => {
        tabJoin.classList.add('active');
        tabCreate.classList.remove('active');
        setupJoin.style.display = '';
        setupCreate.style.display = 'none';
        setupMsg.textContent = '';
      });

      function formatSlug(raw) {
        return raw.toLowerCase().replace(/[\s_]+/g, '-').replace(/[^a-z0-9\-]/g, '').replace(/-{2,}/g, '-').replace(/^-|-$/g, '');
      }

      // ===== Company Name Autocomplete (NTA API) =====
      const selectedAddrEl = document.getElementById('selected-addr');
      const acInput = document.getElementById('create-name');
      const acDropdown = document.getElementById('ac-dropdown');
      let acTimer = null;
      let acResults = [];
      let acIndex = -1;
      let selectedCorporateNumber = '';

      function renderAcDropdown() {
        if (acResults.length === 0) {
          acDropdown.classList.remove('show');
          return;
        }
        acDropdown.innerHTML = acResults.map((c, i) => {
          const addr = [c.prefecture, c.city, c.street].filter(Boolean).join(' ');
          return '<div class="ac-item' + (i === acIndex ? ' active' : '') + '" data-idx="' + i + '">' +
            '<span class="ac-name">' + escapeHtml(c.name) + '</span>' +
            (addr ? '<span class="ac-addr">' + escapeHtml(addr) + '</span>' : '') +
          '</div>';
        }).join('');
        acDropdown.classList.add('show');

        acDropdown.querySelectorAll('.ac-item').forEach(el => {
          el.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const idx = parseInt(el.dataset.idx);
            const c = acResults[idx];
            acInput.value = c.name;
            selectedCorporateNumber = c.corporate_number || '';
            const addr = [c.prefecture, c.city, c.street].filter(Boolean).join(' ');
            selectedAddrEl.textContent = addr;
            acDropdown.classList.remove('show');
            acResults = [];
          });
        });
      }

      acInput.addEventListener('input', () => {
        selectedCorporateNumber = '';
        selectedAddrEl.textContent = '';
        const q = acInput.value.trim();
        if (q.length < 2) {
          acDropdown.classList.remove('show');
          acResults = [];
          return;
        }
        clearTimeout(acTimer);
        acTimer = setTimeout(() => {
          fetch('/api/company/nta-search?name=' + encodeURIComponent(q) + '&count=8')
            .then(r => r.ok ? r.json() : { corporations: [] })
            .then(data => {
              acResults = data.corporations || [];
              acIndex = -1;
              renderAcDropdown();
            })
            .catch(() => { acResults = []; acDropdown.classList.remove('show'); });
        }, 400);
      });

      acInput.addEventListener('keydown', (e) => {
        if (!acDropdown.classList.contains('show') || acResults.length === 0) return;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          acIndex = Math.min(acIndex + 1, acResults.length - 1);
          renderAcDropdown();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          acIndex = Math.max(acIndex - 1, 0);
          renderAcDropdown();
        } else if (e.key === 'Enter' && acIndex >= 0) {
          e.preventDefault();
          const c = acResults[acIndex];
          acInput.value = c.name;
          selectedCorporateNumber = c.corporate_number || '';
          const addr = [c.prefecture, c.city, c.street].filter(Boolean).join(' ');
          selectedAddrEl.textContent = addr;
          acDropdown.classList.remove('show');
          acResults = [];
        } else if (e.key === 'Escape') {
          acDropdown.classList.remove('show');
        }
      });

      acInput.addEventListener('blur', () => {
        setTimeout(() => acDropdown.classList.remove('show'), 200);
      });

      // ===== Password Validation =====
      function isStrongPassword(pw) {
        return pw.length >= 8 && /[a-z]/.test(pw) && /[A-Z]/.test(pw) && /[0-9]/.test(pw);
      }

      // ===== Create Company =====
      document.getElementById('create-btn').addEventListener('click', async () => {
        const name = document.getElementById('create-name').value.trim();
        const password = document.getElementById('create-password').value;
        const passwordConfirm = document.getElementById('create-password-confirm').value;
        if (!name) { setupMsg.textContent = t('company_error'); setupMsg.className = 'setup-msg error'; return; }
        if (!password) { setupMsg.textContent = t('password_required'); setupMsg.className = 'setup-msg error'; return; }
        if (!isStrongPassword(password)) { setupMsg.textContent = t('password_weak'); setupMsg.className = 'setup-msg error'; return; }
        if (password !== passwordConfirm) { setupMsg.textContent = t('password_mismatch'); setupMsg.className = 'setup-msg error'; return; }

        const confirmMsg = t('company_confirm_create') +
          '\n\n' + t('company_confirm_name') + ': ' + name +
          (selectedCorporateNumber ? '\n' + t('company_confirm_corp_num') + ': ' + selectedCorporateNumber : '');
        if (!confirm(confirmMsg)) return;

        const btn = document.getElementById('create-btn');
        btn.disabled = true;
        setupMsg.textContent = '';
        try {
          const payload = { name, password };
          if (selectedCorporateNumber) payload.corporate_number = selectedCorporateNumber;
          const res = await apiFetch('/api/company/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!res.ok) { const d = await res.json(); throw new Error(d.detail || 'Error'); }
          const data = await res.json();
          const company = data.company || {};
          const slug = company.slug || '';
          if (company.id) {
            localStorage.setItem('dashboard_company_id', company.id);
          }
          setupMsg.innerHTML = escapeHtml(t('company_created')) +
            (slug ? '<br><span style="font-family:monospace;font-size:0.9rem;">' + escapeHtml(t('company_confirm_id')) + ': <strong>' + escapeHtml(slug) + '</strong></span>' : '');
          setupMsg.className = 'setup-msg success';
          setTimeout(() => location.reload(), 2000);
        } catch (e) {
          setupMsg.textContent = e.message || t('company_error');
          setupMsg.className = 'setup-msg error';
          btn.disabled = false;
        }
      });

      document.getElementById('join-btn').addEventListener('click', async () => {
        const slug = document.getElementById('join-slug').value.trim().toLowerCase();
        const password = document.getElementById('login-password').value;
        if (!slug) { setupMsg.textContent = t('company_error'); setupMsg.className = 'setup-msg error'; return; }
        if (!password) { setupMsg.textContent = t('password_required'); setupMsg.className = 'setup-msg error'; return; }

        const btn = document.getElementById('join-btn');
        btn.disabled = true;
        setupMsg.textContent = '';
        try {
          const res = await fetch('/api/company/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slug, password }),
          });
          if (res.status === 401) { setupMsg.textContent = t('login_failed'); setupMsg.className = 'setup-msg error'; btn.disabled = false; return; }
          if (!res.ok) { const d = await res.json(); throw new Error(d.detail || 'Error'); }
          const loginData = await res.json();
          if (loginData.company && loginData.company.id) {
            localStorage.setItem('dashboard_company_id', loginData.company.id);
          }
          setupMsg.textContent = t('company_joined');
          setupMsg.className = 'setup-msg success';
          setTimeout(() => location.reload(), 800);
        } catch (e) {
          setupMsg.textContent = e.message || t('company_error');
          setupMsg.className = 'setup-msg error';
          btn.disabled = false;
        }
      });

      // ===== Onboarding =====
      const OB_STEPS = [
        { key: 'company_profile', special: true },
        { key: 'github_repo',         i18n: 'ob_github_repo',         descI18n: 'ob_github_repo_desc',         cmdI18n: 'ob_github_repo_cmd' },
        { key: 'github_initial_commit', i18n: 'ob_github_initial_commit', descI18n: 'ob_github_initial_commit_desc', cmdI18n: 'ob_github_initial_commit_cmd' },
        { key: 'vercel_project',      i18n: 'ob_vercel_project',      descI18n: 'ob_vercel_project_desc' },
        { key: 'vercel_env',          i18n: 'ob_vercel_env',          descI18n: 'ob_vercel_env_desc' },
        { key: 'supabase_project',    i18n: 'ob_supabase_project',    descI18n: 'ob_supabase_project_desc' },
        { key: 'supabase_tables',     i18n: 'ob_supabase_tables',     descI18n: 'ob_supabase_tables_desc' },
        { key: 'secret_manager_token',i18n: 'ob_secret_manager_token',descI18n: 'ob_secret_manager_token_desc', cmdI18n: 'ob_secret_manager_token_cmd' },
        { key: 'env_github_repository',i18n:'ob_env_github_repository',descI18n:'ob_env_github_repository_desc' },
      ];

      let obState = {};
      let companyProfile = { employee_count: '', annual_revenue: '', industry: '', founded_date: '' };
      let infraState = { github_repository: '', github_token_secret_name: '', client_supabase_url: '', vercel_project_url: '' };
      // GitHub プロビジョニング中フラグ（OAuth から戻った直後に true にし、完了/失敗で false に戻す）
      let githubProvisioningInProgress = false;

      function loadOnboarding() {
        Promise.all([
          apiFetch('/api/company/onboarding').then(r => r.ok ? r.json() : null),
          apiFetch('/api/company/profile').then(r => r.ok ? r.json() : null),
          apiFetch('/api/company/infra').then(r => r.ok ? r.json() : null),
        ]).then(([obData, profileData, infraData]) => {
          if (!obData) return;
          obState = obData.steps || {};
          if (profileData) {
            companyProfile = {
              employee_count: profileData.employee_count || '',
              annual_revenue: profileData.annual_revenue || '',
              industry: profileData.industry || '',
              founded_date: profileData.founded_date || '',
            };
          }
          if (infraData) {
            infraState = {
              github_repository: infraData.github_repository || '',
              github_token_secret_name: infraData.github_token_secret_name || '',
              client_supabase_url: infraData.client_supabase_url || '',
              vercel_project_url: infraData.vercel_project_url || '',
            };
          }
          renderOnboarding();
          renderInfraSettings();
        }).catch(() => {});
      }

      function renderProfileStep() {
        const done = obState['company_profile'] || false;
        if (done) {
          return '<div class="ob-profile done"><h3>' + escapeHtml(t('ob_profile_done')) + '</h3>' +
            '<div style="font-size:0.85rem;color:#666;">' +
            escapeHtml(t('employee_count_label')) + ': ' + escapeHtml(companyProfile.employee_count || '-') + ' / ' +
            escapeHtml(t('annual_revenue_label')) + ': ' + escapeHtml(companyProfile.annual_revenue || '-') + ' / ' +
            escapeHtml(t('industry_label')) + ': ' + escapeHtml(companyProfile.industry || '-') + ' / ' +
            escapeHtml(t('founded_date_label')) + ': ' + escapeHtml(companyProfile.founded_date || '-') +
            '</div></div>';
        }

        function opt(val, label, selected) {
          return '<option value="' + escapeHtml(val) + '"' + (selected ? ' selected' : '') + '>' + escapeHtml(label) + '</option>';
        }

        let html = '<div class="ob-profile">';
        html += '<h3>' + escapeHtml(t('ob_profile_title')) + '</h3>';
        html += '<div style="font-size:0.8rem;color:#888;margin-bottom:0.5rem;">' + escapeHtml(t('ob_profile_desc')) + '</div>';

        html += '<div class="profile-row"><label>' + escapeHtml(t('employee_count_label')) + '</label>';
        html += '<select id="ob-employee-count">';
        html += opt('', t('select_placeholder'), !companyProfile.employee_count);
        ['1-10','11-50','51-100','101-300','301-1000','1001+'].forEach(v => {
          html += opt(v, v === '1001+' ? '1,001+' : v.replace('-', '~'), companyProfile.employee_count === v);
        });
        html += '</select></div>';

        html += '<div class="profile-row"><label>' + escapeHtml(t('annual_revenue_label')) + '</label>';
        html += '<select id="ob-annual-revenue">';
        html += opt('', t('select_placeholder'), !companyProfile.annual_revenue);
        var revOpts = [
          { v: '~1億', l: t('rev_under1') },
          { v: '1-10億', l: t('rev_1_10') },
          { v: '10-50億', l: t('rev_10_50') },
          { v: '50-100億', l: t('rev_50_100') },
          { v: '100億+', l: t('rev_over100') },
        ];
        revOpts.forEach(o => { html += opt(o.v, o.l, companyProfile.annual_revenue === o.v); });
        html += '</select></div>';

        html += '<div class="profile-row"><label>' + escapeHtml(t('industry_label')) + '</label>';
        html += '<select id="ob-industry">';
        html += opt('', t('select_placeholder'), !companyProfile.industry);
        var indOpts = [
          { v: '製造業', k: 'ind_manufacturing' }, { v: 'IT・通信', k: 'ind_it' },
          { v: '小売・卸売', k: 'ind_retail' }, { v: '建設・不動産', k: 'ind_construction' },
          { v: '医療・福祉', k: 'ind_healthcare' }, { v: '飲食・外食', k: 'ind_food' },
          { v: '金融・保険', k: 'ind_finance' }, { v: '教育', k: 'ind_education' },
          { v: '物流・運輸', k: 'ind_logistics' }, { v: '農林水産業', k: 'ind_agriculture' },
          { v: 'エネルギー・インフラ', k: 'ind_energy' }, { v: '人材・派遣', k: 'ind_staffing' },
          { v: '広告・メディア', k: 'ind_media' }, { v: 'コンサルティング', k: 'ind_consulting' },
          { v: '美容・エステ', k: 'ind_beauty' }, { v: '旅行・観光', k: 'ind_travel' },
          { v: 'サービス業', k: 'ind_service' }, { v: 'その他', k: 'ind_other' },
        ];
        indOpts.forEach(o => { html += opt(o.v, t(o.k), companyProfile.industry === o.v); });
        html += '</select></div>';

        html += '<div class="profile-row"><label>' + escapeHtml(t('founded_date_label')) + '</label>';
        html += '<input type="date" id="ob-founded-date" value="' + escapeHtml(companyProfile.founded_date || '') + '" style="padding:6px 8px;border:1px solid #ccc;border-radius:4px;font-size:0.9rem;">';
        html += '</div>';

        html += '<button class="profile-save" id="ob-profile-save">' + escapeHtml(t('ob_profile_save')) + '</button>';
        html += '<div class="profile-msg" id="ob-profile-msg"></div>';
        html += '</div>';
        return html;
      }

      // セットアップ入力値の一時保存（renderOnboarding の innerHTML 書き換えで消えるのを防止）
      var _obInputCache = {};
      function _saveObInputs() {
        ['ob-supabase-token', 'ob-supabase-exp-days', 'ob-vercel-token', 'ob-vercel-anon-key'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) _obInputCache[id] = el.value;
        });
      }
      function _restoreObInputs() {
        Object.keys(_obInputCache).forEach(function(id) {
          var el = document.getElementById(id);
          if (el && _obInputCache[id]) el.value = _obInputCache[id];
        });
      }

      function renderOnboarding() {
        _saveObInputs();
        const container = document.getElementById('ob-steps');
        const infraContainer = document.getElementById('ob-infra');
        const doneCount = Object.values(obState).filter(Boolean).length;
        const total = OB_STEPS.length;
        const pct = Math.round((doneCount / total) * 100);
        document.getElementById('ob-progress-fill').style.width = pct + '%';
        document.getElementById('ob-progress-text').textContent = doneCount + ' / ' + total;
        // Update section header badge
        const infraBadge = document.getElementById('infra-section-badge');
        if (infraBadge) {
          infraBadge.textContent = doneCount + ' / ' + total;
          infraBadge.className = 'setup-section-badge' + (doneCount === total ? ' ok' : '');
        }

        if (doneCount === total) {
          container.innerHTML = '<div class="ob-complete">' + escapeHtml(t('ob_all_done')) + '</div>';
          if (infraContainer) infraContainer.innerHTML = '';
          return;
        }

        let html = '';

        // Company profile step
        html += renderProfileStep();

        // GitHub card
        html += renderGitHubCard();

        // Supabase card
        html += renderSupabaseCard();

        // Vercel card
        html += renderVercelCard();

        container.innerHTML = html;
        _restoreObInputs();

        // Infra summary (below cards)
        renderInfraSettings();

        // Attach profile save handler
        const saveBtn = document.getElementById('ob-profile-save');
        if (saveBtn) {
          saveBtn.addEventListener('click', async () => {
            const ec = document.getElementById('ob-employee-count').value;
            const ar = document.getElementById('ob-annual-revenue').value;
            const ind = document.getElementById('ob-industry').value;
            const fd = document.getElementById('ob-founded-date').value;
            if (!ec || !ar || !ind || !fd) return;
            saveBtn.disabled = true;
            try {
              const res = await apiFetch('/api/company/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employee_count: ec, annual_revenue: ar, industry: ind, founded_date: fd }),
              });
              if (res.ok) {
                const d = await res.json();
                companyProfile = { employee_count: d.employee_count || ec, annual_revenue: d.annual_revenue || ar, industry: d.industry || ind, founded_date: d.founded_date || fd };
                obState['company_profile'] = true;
                const msgEl = document.getElementById('ob-profile-msg');
                if (msgEl) { msgEl.textContent = t('ob_profile_saved'); msgEl.style.color = '#4caf50'; }
                setTimeout(() => { renderOnboarding(); renderSettingsCompanyInfo(); }, 600);
              }
            } catch (e) { saveBtn.disabled = false; }
          });
        }

        // Attach GitHub connect handler
        // pre-authorize で既存の GitHub OAuth 認可を revoke してからリダイレクトする
        const ghBtn = document.getElementById('ob-github-connect-btn');
        if (ghBtn) {
          ghBtn.addEventListener('click', async () => {
            ghBtn.disabled = true;
            ghBtn.innerHTML = '<span class="ob-spinner-inline"></span>' + escapeHtml(t('ob_card_github_connecting'));
            const msgEl = document.getElementById('ob-github-msg');
            if (msgEl) {
              msgEl.innerHTML = '<span class="ob-spinner-inline"></span>' + escapeHtml(t('ob_card_github_connecting'));
              msgEl.className = 'ob-card-msg';
            }
            try {
              const res = await apiFetch('/api/oauth/github/pre-authorize', { method: 'POST' });
              if (res.ok) {
                const data = await res.json();
                window.location.href = data.authorize_url;
              } else {
                window.location.href = '/api/oauth/github/authorize';
              }
            } catch (e) {
              window.location.href = '/api/oauth/github/authorize';
            }
          });
        }

        // Attach Supabase connect handler
        const sbBtn = document.getElementById('ob-supabase-connect-btn');
        if (sbBtn) {
          sbBtn.addEventListener('click', () => provisionSupabase());
        }
        // Attach Supabase retry handler
        const sbRetryBtn = document.getElementById('ob-supabase-retry-btn');
        if (sbRetryBtn) {
          sbRetryBtn.addEventListener('click', () => retrySupabaseTables());
        }

        // Attach Vercel connect handler
        const vcBtn = document.getElementById('ob-vercel-connect-btn');
        if (vcBtn) {
          vcBtn.addEventListener('click', () => provisionVercel());
        }
      }

      function renderGitHubCard() {
        const repoOk = obState['github_repo'] || false;
        const commitOk = obState['github_initial_commit'] || false;
        const allDone = repoOk && commitOk;
        const cls = allDone ? 'ob-card connected' : 'ob-card';

        let html = '<div class="' + cls + '">';
        html += '<div class="ob-card-header">';
        html += '<h4>' + escapeHtml(t('ob_card_github_title')) + '</h4>';
        html += '<span class="ob-card-status ' + (allDone ? 'done' : 'pending') + '">' +
                escapeHtml(allDone ? t('ob_card_github_done') : '') + '</span>';
        html += '</div>';

        html += '<div class="ob-card-steps">';
        html += '<span class="' + (repoOk ? 'step-done' : 'step-pending') + '">' +
                (repoOk ? '&#10003; ' : '&#9744; ') + escapeHtml(t('ob_card_github_step_repo')) + '</span>';
        html += ' &nbsp; ';
        html += '<span class="' + (commitOk ? 'step-done' : 'step-pending') + '">' +
                (commitOk ? '&#10003; ' : '&#9744; ') + escapeHtml(t('ob_card_github_step_commit')) + '</span>';
        html += '</div>';

        if (infraState.github_repository) {
          var ghUrl = 'https://github.com/' + infraState.github_repository;
          html += '<div class="ob-card-result"><a href="' + escapeHtml(ghUrl) + '" target="_blank" class="ob-result-link">' +
                  escapeHtml(ghUrl) + ' &#8599;</a></div>';
        }

        if (!allDone && githubProvisioningInProgress) {
          // OAuth から戻ってプロビジョニング中 → ボタンではなくスピナーを表示
          html += '<div style="margin-top:0.5rem;">';
          html += '<button class="ob-card-btn github-btn" id="ob-github-connect-btn" disabled>' +
                  '<span class="ob-spinner-inline"></span>' + escapeHtml(t('ob_card_github_provisioning')) + '</button>';
          html += '</div>';
        } else if (!allDone) {
          html += '<div style="margin-top:0.5rem;">';
          html += '<button class="ob-card-btn github-btn" id="ob-github-connect-btn">' +
                  escapeHtml(t('ob_card_github_connect')) + '</button>';
          html += '</div>';
        }

        html += '<div class="ob-card-msg" id="ob-github-msg"></div>';
        html += '</div>';
        return html;
      }

      function renderSupabaseCard() {
        const projOk = obState['supabase_project'] || false;
        const tablesOk = obState['supabase_tables'] || false;
        const allDone = projOk && tablesOk;
        const cls = allDone ? 'ob-card connected' : 'ob-card';

        let html = '<div class="' + cls + '">';
        html += '<div class="ob-card-header">';
        html += '<h4>' + escapeHtml(t('ob_card_supabase_title')) + '</h4>';
        html += '<span class="ob-card-status ' + (allDone ? 'done' : 'pending') + '">' +
                escapeHtml(allDone ? t('ob_card_supabase_done') : '') + '</span>';
        html += '</div>';

        html += '<div class="ob-card-steps">';
        html += '<span class="' + (projOk ? 'step-done' : 'step-pending') + '">' +
                (projOk ? '&#10003; ' : '&#9744; ') + escapeHtml(t('ob_card_supabase_step_project')) + '</span>';
        html += ' &nbsp; ';
        html += '<span class="' + (tablesOk ? 'step-done' : 'step-pending') + '">' +
                (tablesOk ? '&#10003; ' : '&#9744; ') + escapeHtml(t('ob_card_supabase_step_tables')) + '</span>';
        html += '</div>';

        if (infraState.client_supabase_url) {
          var sbRef = infraState.client_supabase_url.replace('https://', '').replace('.supabase.co', '').replace(/\/$/,'');
          var sbDashUrl = 'https://supabase.com/dashboard/project/' + sbRef;
          html += '<div class="ob-card-result"><a href="' + escapeHtml(sbDashUrl) + '" target="_blank" class="ob-result-link">' +
                  escapeHtml(sbDashUrl) + ' &#8599;</a></div>';
        }

        if (!allDone) {
          if (projOk && !tablesOk) {
            // プロジェクト作成済みだがテーブル初期化が失敗した場合
            html += '<div style="margin-top:0.5rem;font-size:0.85rem;color:#ff9800;">' +
                    escapeHtml(t('ob_card_supabase_tables_retry')) + '</div>';
            html += '<div style="margin-top:0.3rem;">';
            html += '<button class="ob-card-btn supabase-btn" id="ob-supabase-retry-btn">' +
                    escapeHtml(t('ob_card_supabase_retry')) + '</button>';
            html += '</div>';
          } else if (!projOk) {
            html += '<div class="ob-token-input">';
            html += '<input type="text" id="ob-supabase-token" placeholder="sbp_..." autocomplete="one-time-code" value="">';
            html += '<button class="ob-card-btn supabase-btn" id="ob-supabase-connect-btn">' +
                    escapeHtml(t('ob_card_supabase_connect')) + '</button>';
            html += '</div>';
            html += '<div style="display:flex;align-items:center;gap:0.4rem;margin-top:0.3rem;font-size:0.8rem;color:#555">';
            html += '<span>' + escapeHtml(t('int_expires_at')) + ':</span>';
            html += '<select id="ob-supabase-exp-days" style="padding:0.2rem 0.4rem;border:1px solid #ccc;border-radius:4px;font-size:0.8rem">';
            html += '<option value="90">90' + escapeHtml(t('int_expires_days_unit')) + '</option>';
            html += '<option value="30">30' + escapeHtml(t('int_expires_days_unit')) + '</option>';
            html += '<option value="60">60' + escapeHtml(t('int_expires_days_unit')) + '</option>';
            html += '<option value="180">180' + escapeHtml(t('int_expires_days_unit')) + '</option>';
            html += '<option value="365">365' + escapeHtml(t('int_expires_days_unit')) + '</option>';
            html += '<option value="">' + escapeHtml(t('int_expires_none')) + '</option>';
            html += '</select></div>';
            html += '<div class="ob-card-help">' + escapeHtml(t('ob_card_supabase_pat_help')) +
                    ' <a href="https://supabase.com/dashboard/account/tokens" target="_blank">' +
                    escapeHtml(t('ob_card_supabase_pat_link')) + '</a></div>';
          }
        }

        html += '<div class="ob-card-msg" id="ob-supabase-msg"></div>';
        html += '</div>';
        return html;
      }

      function renderVercelCard() {
        const projOk = obState['vercel_project'] || false;
        const envOk = obState['vercel_env'] || false;
        const allDone = projOk && envOk;
        const githubDone = obState['github_repo'] && obState['github_initial_commit'];
        const cls = allDone ? 'ob-card connected' : 'ob-card';

        let html = '<div class="' + cls + '">';
        html += '<div class="ob-card-header">';
        html += '<h4>' + escapeHtml(t('ob_card_vercel_title')) + '</h4>';
        html += '<span class="ob-card-status ' + (allDone ? 'done' : 'pending') + '">' +
                escapeHtml(allDone ? t('ob_card_vercel_done') : '') + '</span>';
        html += '</div>';

        html += '<div class="ob-card-steps">';
        html += '<span class="' + (projOk ? 'step-done' : 'step-pending') + '">' +
                (projOk ? '&#10003; ' : '&#9744; ') + escapeHtml(t('ob_card_vercel_step_project')) + '</span>';
        html += ' &nbsp; ';
        html += '<span class="' + (envOk ? 'step-done' : 'step-pending') + '">' +
                (envOk ? '&#10003; ' : '&#9744; ') + escapeHtml(t('ob_card_vercel_step_env')) + '</span>';
        html += '</div>';

        if (infraState.vercel_project_url) {
          html += '<div class="ob-card-result"><a href="' + escapeHtml(infraState.vercel_project_url) + '" target="_blank" class="ob-result-link">' +
                  escapeHtml(infraState.vercel_project_url) + ' &#8599;</a>' +
                  '<div class="vc-deploy-status" style="font-size:0.75rem;margin-top:0.2rem">' + vcDeployStatusHtml() + '</div></div>';
          pollVercelDeployStatus();
        }

        if (!allDone) {
          if (!githubDone) {
            html += '<div style="margin-top:0.5rem;font-size:0.85rem;color:#ff9800;">' +
                    escapeHtml(t('ob_card_vercel_requires_github')) + '</div>';
          } else {
            html += '<div class="ob-token-input">';
            html += '<input type="text" id="ob-vercel-token" placeholder="Vercel API Token を貼り付け" autocomplete="one-time-code" value="">';
            html += '<button class="ob-card-btn vercel-btn" id="ob-vercel-connect-btn">' +
                    escapeHtml(t('ob_card_vercel_connect')) + '</button>';
            html += '</div>';
            html += '<div style="margin:0.3rem 0;">';
            html += '<input type="text" id="ob-vercel-anon-key" placeholder="' + escapeHtml(t('ob_card_supabase_anon_key')) + '" style="width:100%;padding:0.4rem;border:1px solid #ccc;border-radius:4px;font-size:0.8rem;font-family:monospace;">';
            html += '<div style="font-size:0.75rem;color:#888;margin-top:0.2rem">' + escapeHtml(t('int_vc_anon_key_hint')) + '</div>';
            html += '</div>';
            html += '<div class="ob-card-help">' + escapeHtml(t('ob_card_vercel_token_help')) +
                    ' <a href="https://vercel.com/account/tokens" target="_blank">' +
                    escapeHtml(t('ob_card_vercel_token_link')) + '</a></div>';
            html += '<div class="ob-card-help" style="margin-top:0.3rem">' + escapeHtml(t('int_vc_github_login_hint')) +
                    ' <a href="https://vercel.com/account/login-connections" target="_blank">① Login Connections ↗</a>' +
                    ' <a href="https://github.com/apps/vercel" target="_blank">② Vercel GitHub App ↗</a></div>';
          }
        }

        html += '<div class="ob-card-msg" id="ob-vercel-msg"></div>';
        html += '</div>';
        return html;
      }

      // ===== Provisioning functions =====

      async function provisionGitHub() {
        const msgEl = document.getElementById('ob-github-msg');
        if (msgEl) {
          msgEl.innerHTML = '<span class="ob-spinner-inline"></span>' + escapeHtml(t('ob_card_github_provisioning'));
          msgEl.className = 'ob-card-msg';
        }
        const btn = document.getElementById('ob-github-connect-btn');
        if (btn) btn.disabled = true;
        try {
          const res = await apiFetch('/api/onboarding/provision/github', { method: 'POST' });
          githubProvisioningInProgress = false;
          if (res.ok) {
            const data = await res.json();
            obState['github_repo'] = true;
            obState['github_initial_commit'] = true;
            obState['env_github_repository'] = true;
            infraState.github_repository = data.repo || '';
            renderOnboarding();
          } else {
            const err = await res.json().catch(() => ({}));
            if (msgEl) { msgEl.textContent = t('ob_provision_failed') + (err.detail || ''); msgEl.className = 'ob-card-msg error'; }
            if (btn) btn.disabled = false;
          }
        } catch (e) {
          githubProvisioningInProgress = false;
          if (msgEl) { msgEl.textContent = t('ob_provision_failed') + e.message; msgEl.className = 'ob-card-msg error'; }
          if (btn) btn.disabled = false;
        }
      }

      async function provisionSupabase() {
        const tokenInput = document.getElementById('ob-supabase-token');
        const token = tokenInput ? tokenInput.value.trim() : '';
        if (!token) { tokenInput && tokenInput.focus(); return; }
        const expSelect = document.getElementById('ob-supabase-exp-days');
        const expDays = expSelect ? parseInt(expSelect.value, 10) : 0;
        const expiresAt = expDays > 0 ? new Date(Date.now() + expDays * 86400000).toISOString() : '';
        const msgEl = document.getElementById('ob-supabase-msg');
        if (msgEl) {
          msgEl.innerHTML = '<span class="ob-spinner-inline"></span>' + escapeHtml(t('ob_card_supabase_provisioning'));
          msgEl.className = 'ob-card-msg';
        }
        const btn = document.getElementById('ob-supabase-connect-btn');
        if (btn) btn.disabled = true;
        try {
          const res = await apiFetch('/api/onboarding/provision/supabase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ access_token: token, expires_at: expiresAt }),
          });
          if (res.ok) {
            const data = await res.json();
            obState['supabase_project'] = true;
            if (data.tables_initialized) obState['supabase_tables'] = true;
            infraState.client_supabase_url = data.url || '';
            if (tokenInput) tokenInput.value = '';
            renderOnboarding();
          } else {
            const err = await res.json().catch(() => ({}));
            if (msgEl) { msgEl.textContent = t('ob_provision_failed') + (err.detail || ''); msgEl.className = 'ob-card-msg error'; }
            if (btn) btn.disabled = false;
          }
        } catch (e) {
          if (msgEl) { msgEl.textContent = t('ob_provision_failed') + e.message; msgEl.className = 'ob-card-msg error'; }
          if (btn) btn.disabled = false;
        }
      }

      async function retrySupabaseTables() {
        const msgEl = document.getElementById('ob-supabase-msg');
        if (msgEl) {
          msgEl.innerHTML = '<span class="ob-spinner-inline"></span>' + escapeHtml(t('ob_card_supabase_retrying'));
          msgEl.className = 'ob-card-msg';
        }
        const btn = document.getElementById('ob-supabase-retry-btn');
        if (btn) btn.disabled = true;
        try {
          const res = await apiFetch('/api/onboarding/provision/supabase/retry-tables', { method: 'POST' });
          if (res.ok) {
            const data = await res.json();
            if (data.tables_initialized) obState['supabase_tables'] = true;
            renderOnboarding();
          } else {
            const err = await res.json().catch(() => ({}));
            if (msgEl) { msgEl.textContent = t('ob_provision_failed') + (err.detail || ''); msgEl.className = 'ob-card-msg error'; }
            if (btn) btn.disabled = false;
          }
        } catch (e) {
          if (msgEl) { msgEl.textContent = t('ob_provision_failed') + e.message; msgEl.className = 'ob-card-msg error'; }
          if (btn) btn.disabled = false;
        }
      }

      async function provisionVercel() {
        const tokenInput = document.getElementById('ob-vercel-token');
        const token = tokenInput ? tokenInput.value.trim() : '';
        if (!token) { tokenInput && tokenInput.focus(); return; }
        const anonKeyInput = document.getElementById('ob-vercel-anon-key');
        const anonKey = anonKeyInput ? anonKeyInput.value.trim() : '';
        const msgEl = document.getElementById('ob-vercel-msg');
        if (msgEl) {
          msgEl.innerHTML = '<span class="ob-spinner-inline"></span>' + escapeHtml(t('ob_card_vercel_provisioning'));
          msgEl.className = 'ob-card-msg';
        }
        const btn = document.getElementById('ob-vercel-connect-btn');
        if (btn) btn.disabled = true;
        try {
          const res = await apiFetch('/api/onboarding/provision/vercel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ access_token: token, supabase_anon_key: anonKey }),
          });
          if (res.ok) {
            const data = await res.json();
            obState['vercel_project'] = true;
            obState['vercel_env'] = true;
            infraState.vercel_project_url = data.url || '';
            if (tokenInput) tokenInput.value = '';
            if (anonKeyInput) anonKeyInput.value = '';
            renderOnboarding();
            _vcDeployState = null; // リセットして再チェック
            if (msgEl) { msgEl.className = 'ob-card-msg vc-deploy-status'; msgEl.innerHTML = vcDeployStatusHtml(); }
            pollVercelDeployStatus();
          } else {
            const err = await res.json().catch(() => ({}));
            if (msgEl) { msgEl.textContent = t('ob_provision_failed') + (err.detail || ''); msgEl.className = 'ob-card-msg error'; }
            if (btn) btn.disabled = false;
          }
        } catch (e) {
          if (msgEl) { msgEl.textContent = t('ob_provision_failed') + e.message; msgEl.className = 'ob-card-msg error'; }
          if (btn) btn.disabled = false;
        }
      }

      // ===== Infra Settings (summary view) =====
      function renderInfraSettings() {
        const container = document.getElementById('ob-infra');
        if (!container) return;

        // Only show if at least one infra value is set
        const hasAny = infraState.github_repository || infraState.client_supabase_url || infraState.vercel_project_url;
        if (!hasAny) { container.innerHTML = ''; return; }

        const fields = [
          { key: 'github_repository',         label: 'infra_github_repo' },
          { key: 'github_token_secret_name',  label: 'infra_github_token' },
          { key: 'client_supabase_url',       label: 'infra_supabase_url' },
          { key: 'vercel_project_url',        label: 'infra_vercel_url' },
        ];

        let html = '<div class="ob-infra">';
        html += '<h3>' + escapeHtml(t('infra_section_title')) + '</h3>';

        fields.forEach(f => {
          const val = infraState[f.key] || '';
          if (!val) return;
          const cls = 'infra-val set';
          html += '<div class="infra-row">';
          html += '<label>' + escapeHtml(t(f.label)) + '</label>';
          html += '<div class="' + cls + '">' + escapeHtml(val) + '</div>';
          html += '</div>';
        });

        html += '</div>';
        container.innerHTML = html;
      }

      // ===== Integrations Panel =====
      function loadIntegrations() {
        apiFetch('/api/integrations/status')
          .then(r => r.ok ? r.json() : null)
          .then(data => {
            if (data) renderIntegrations(data);
          })
          .catch(() => {});
      }

      function renderIntegrations(data) {
        const container = document.getElementById('integrations-container');
        if (!container) return;
        const canEdit = (data.company_role === 'admin' || data.company_role === 'owner');
        // Update section badge (infra services)
        const services = data.services || {};
        const infraKeys = ['github', 'supabase', 'vercel'];
        const connectedInfra = infraKeys.filter(k => services[k] && services[k].connected).length;
        const channelsBadge = document.getElementById('channels-section-badge');
        if (channelsBadge) {
          channelsBadge.textContent = connectedInfra + ' / ' + infraKeys.length;
          channelsBadge.className = 'setup-section-badge' + (connectedInfra === infraKeys.length ? ' ok' : '');
        }
        let html = '';
        html += renderIntInfraSection(data.infra, data.services, data.env_status, canEdit);
        html += renderIntChannelsSection(data.services, data.env_status, canEdit, data.channel_configs, data.webhook_urls, data.redirect_uris);
        html += renderIntEnvTable(data.env_status);
        container.innerHTML = html;
        attachIntegrationHandlers(data);
      }

      function intBadge(connected) {
        if (connected) {
          return '<span class="int-badge ok">' + escapeHtml(t('int_connected')) + '</span>';
        }
        return '<span class="int-badge ng">' + escapeHtml(t('int_disconnected')) + '</span>';
      }

      function intExpiresBadge(expiresAt) {
        if (!expiresAt) return '<span style="font-size:0.8rem;color:#999">' + escapeHtml(t('int_expires_none')) + '</span>';
        const now = new Date();
        const exp = new Date(expiresAt);
        const diffMs = exp - now;
        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        const dateStr = exp.toLocaleDateString();
        if (diffDays < 0) {
          return '<span class="int-badge" style="background:#ffebee;color:#c62828">' + escapeHtml(t('int_expires_expired')) + ' (' + dateStr + ')</span>';
        }
        if (diffDays === 0) {
          return '<span class="int-badge" style="background:#fff3e0;color:#e65100">' + escapeHtml(t('int_expires_today')) + '</span>';
        }
        if (diffDays <= 7) {
          return '<span class="int-badge" style="background:#fff3e0;color:#e65100">' + dateStr + ' (' + diffDays + escapeHtml(t('int_expires_days_left')) + ')</span>';
        }
        return '<span style="font-size:0.8rem;color:#2e7d32">' + dateStr + ' (' + diffDays + escapeHtml(t('int_expires_days_left')) + ')</span>';
      }

      function renderInfraTokenExpires(field, expiresAt, inputId) {
        let html = '<div style="margin-top:0.4rem;font-size:0.85rem;display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap">';
        html += '<span>' + escapeHtml(t('int_expires_at')) + ': </span>';
        html += intExpiresBadge(expiresAt);
        // 変更ボタン + 日数セレクト（初期は非表示）
        html += '<button class="int-expires-edit-btn" data-target="' + inputId + '" style="background:none;border:1px solid #ccc;border-radius:4px;padding:0.15rem 0.5rem;font-size:0.75rem;cursor:pointer;color:#1976d2">' + escapeHtml(t('int_expires_edit')) + '</button>';
        html += '<span class="int-expires-form" id="' + inputId + '" style="display:none;align-items:center;gap:0.3rem">';
        html += '<select class="int-expires-input" style="padding:0.2rem 0.4rem;border:1px solid #ccc;border-radius:4px;font-size:0.8rem">';
        html += '<option value="">' + escapeHtml(t('int_expires_none')) + '</option>';
        html += '<option value="30">30' + escapeHtml(t('int_expires_days_unit')) + '</option>';
        html += '<option value="60">60' + escapeHtml(t('int_expires_days_unit')) + '</option>';
        html += '<option value="90">90' + escapeHtml(t('int_expires_days_unit')) + '</option>';
        html += '<option value="180">180' + escapeHtml(t('int_expires_days_unit')) + '</option>';
        html += '<option value="365">365' + escapeHtml(t('int_expires_days_unit')) + '</option>';
        html += '</select>';
        html += '<button class="int-expires-save-btn" data-field="' + field + '" data-form="' + inputId + '" style="background:#1976d2;color:#fff;border:none;border-radius:4px;padding:0.2rem 0.6rem;font-size:0.75rem;cursor:pointer">' + escapeHtml(t('int_expires_save')) + '</button>';
        html += '</span>';
        html += '<span class="int-expires-msg" id="' + inputId + '-msg" style="font-size:0.75rem"></span>';
        html += '</div>';
        return html;
      }

      function renderIntInfraSection(infra, services, envStatus, canEdit) {
        let html = '<div class="int-section">';
        html += '<h3>' + escapeHtml(t('int_infra_title')) + '</h3>';

        // GitHub
        const ghConnected = !!(services.github && services.github.connected);
        const ghRepo = (infra && infra.github_repository) || '';
        html += '<div class="int-card ' + (ghConnected ? 'connected' : 'disconnected') + '">';
        html += '<div class="int-card-header"><span class="int-card-title">' + escapeHtml(t('int_github_title')) + '</span>' + intBadge(ghConnected) + '</div>';
        if (ghRepo) {
          const ghUrl = 'https://github.com/' + ghRepo;
          html += '<div class="int-url"><a href="' + escapeHtml(ghUrl) + '" target="_blank" rel="noopener">' + escapeHtml(ghUrl) + ' ↗</a></div>';
        } else {
          html += '<div class="int-url" style="color:#999">' + escapeHtml(t('int_no_url')) + '</div>';
        }
        html += '<div style="margin-top:0.3rem;font-size:0.8rem;color:#777">GITHUB_CLIENT_ID: ' + (envStatus.GITHUB_CLIENT_ID ? '✓' : '✗') + '</div>';
        if (canEdit && envStatus.GITHUB_CLIENT_ID) {
          html += '<div style="display:flex;gap:0.5rem;margin-top:0.4rem;flex-wrap:wrap">';
          html += '<button class="int-reconnect-github-btn" style="background:#24292e;color:#fff;border:none;border-radius:4px;padding:0.3rem 0.8rem;font-size:0.8rem;cursor:pointer">' + escapeHtml(t(ghConnected ? 'int_reconnect' : 'ob_card_github_connect')) + '</button>';
          if (ghConnected) {
            html += '<button class="int-disconnect-btn" data-service="github" style="background:none;border:1px solid #c62828;border-radius:4px;padding:0.2rem 0.6rem;font-size:0.75rem;cursor:pointer;color:#c62828">' + escapeHtml(t('int_disconnect')) + '</button>';
          }
          html += '</div>';
        }
        html += '</div>';

        // Supabase
        const sbUrl = (infra && infra.client_supabase_url) || '';
        const sbConnected = !!sbUrl;
        const sbTokenExists = !!(infra && infra.supabase_mgmt_token_enc_exists);
        html += '<div class="int-card ' + (sbConnected ? 'connected' : 'disconnected') + '">';
        html += '<div class="int-card-header"><span class="int-card-title">' + escapeHtml(t('int_supabase_title')) + '</span>' + intBadge(sbConnected) + '</div>';
        if (sbUrl) {
          const refMatch = sbUrl.match(/https?:\/\/([^.]+)\.supabase\.co/);
          const dashUrl = refMatch ? 'https://supabase.com/dashboard/project/' + refMatch[1] : sbUrl;
          html += '<div class="int-url"><a href="' + escapeHtml(dashUrl) + '" target="_blank" rel="noopener">' + escapeHtml(dashUrl) + ' ↗</a></div>';
        } else {
          html += '<div class="int-url" style="color:#999">' + escapeHtml(t('int_no_url')) + '</div>';
        }
        // トークン保存状態
        if (sbTokenExists) {
          html += '<div style="margin-top:0.3rem;font-size:0.8rem;color:#2e7d32">&#128274; ' + escapeHtml(t('int_token_saved')) + '</div>';
          html += renderInfraTokenExpires('supabase_mgmt_token_enc', infra.supabase_mgmt_token_expires_at, 'int-sb-exp');
        } else if (sbConnected) {
          html += '<div style="margin-top:0.3rem;font-size:0.8rem;color:#e65100">&#9888; ' + escapeHtml(t('int_token_not_saved')) + '</div>';
        }
        // ボタン行: 再接続 | 接続解除 | トークン再発行（GitHub と同じパターン）
        if (canEdit) {
          html += '<div style="display:flex;gap:0.5rem;margin-top:0.4rem;flex-wrap:wrap">';
          html += '<button class="int-reconnect-sb-btn" style="background:#3ecf8e;color:#fff;border:none;border-radius:4px;padding:0.3rem 0.8rem;font-size:0.8rem;cursor:pointer">' + escapeHtml(t(sbConnected ? 'int_reconnect' : 'int_connect')) + '</button>';
          if (sbConnected) {
            html += '<button class="int-disconnect-btn" data-service="supabase" style="background:none;border:1px solid #c62828;border-radius:4px;padding:0.2rem 0.6rem;font-size:0.75rem;cursor:pointer;color:#c62828">' + escapeHtml(t('int_disconnect')) + '</button>';
          }
          if (sbTokenExists) {
            html += '<button class="int-reissue-btn" data-target="int-sb-reissue" style="background:none;border:1px solid #e65100;border-radius:4px;padding:0.2rem 0.6rem;font-size:0.75rem;cursor:pointer;color:#e65100">' + escapeHtml(t('int_reissue')) + '</button>';
          }
          html += '</div>';
          // 再接続フォーム（非表示）
          html += '<div id="int-sb-reconnect-form" style="display:none;margin-top:0.5rem;padding:0.6rem;background:#f8f9fa;border:1px solid #e0e0e0;border-radius:6px">';
          html += '<div style="font-size:0.8rem;color:#555;margin-bottom:0.4rem">' + t('int_token_save_hint_sb') + '</div>';
          html += '<div class="int-token-row">';
          html += '<input type="text" id="int-sb-reconnect-token" autocomplete="off" value="" placeholder="' + escapeHtml(t('int_token_placeholder_sb')) + '" style="flex:1;padding:0.4rem 0.6rem;border:1px solid #ccc;border-radius:4px;font-size:0.85rem">';
          html += '<button class="int-reconnect-provision-btn" data-service="supabase" style="margin-left:0.5rem;background:#3ecf8e;color:#fff;border:none;border-radius:4px;padding:0.4rem 1rem;font-size:0.85rem;cursor:pointer">' + escapeHtml(t(sbConnected ? 'int_reconnect' : 'int_connect')) + '</button>';
          html += '</div>';
          html += '<div id="int-sb-reconnect-msg" style="font-size:0.8rem;margin-top:0.3rem;min-height:1em"></div>';
          html += '</div>';
          // トークン再発行フォーム（非表示）
          if (sbTokenExists) {
            html += '<div id="int-sb-reissue" style="display:none;margin-top:0.4rem">';
            html += '<div style="font-size:0.8rem;color:#555;margin-bottom:0.3rem">' + t('int_token_save_hint_sb') + '</div>';
            html += '<div class="int-token-row">';
            html += '<input type="text" id="int-sb-token" autocomplete="off" value="" placeholder="' + escapeHtml(t('int_token_placeholder_sb')) + '" style="flex:1;padding:0.4rem 0.6rem;border:1px solid #ccc;border-radius:4px;font-size:0.85rem">';
            html += '<select id="int-sb-token-exp" style="padding:0.4rem 0.4rem;border:1px solid #ccc;border-radius:4px;font-size:0.85rem"><option value="">' + escapeHtml(t('int_expires_none')) + '</option><option value="30">30' + escapeHtml(t('int_expires_days_unit')) + '</option><option value="60">60' + escapeHtml(t('int_expires_days_unit')) + '</option><option value="90">90' + escapeHtml(t('int_expires_days_unit')) + '</option><option value="180">180' + escapeHtml(t('int_expires_days_unit')) + '</option><option value="365">365' + escapeHtml(t('int_expires_days_unit')) + '</option></select>';
            html += '<button class="int-connect-btn int-infra-save" data-field="supabase_mgmt_token_enc" data-input="int-sb-token" data-exp-input="int-sb-token-exp" style="margin-left:0.5rem">' + escapeHtml(t('int_save_token')) + '</button>';
            html += '</div>';
            html += '<div id="int-sb-msg" class="int-infra-msg" style="font-size:0.8rem;margin-top:0.3rem"></div>';
            html += '</div>';
          }
        }
        html += '</div>';

        // Vercel
        const vcUrl = (infra && infra.vercel_project_url) || '';
        const vcConnected = !!vcUrl;
        const vcTokenExists = !!(infra && infra.vercel_token_enc_exists);
        html += '<div class="int-card ' + (vcConnected ? 'connected' : 'disconnected') + '">';
        html += '<div class="int-card-header"><span class="int-card-title">' + escapeHtml(t('int_vercel_title')) + '</span>' + intBadge(vcConnected) + '</div>';
        if (vcUrl) {
          html += '<div class="int-url"><a href="' + escapeHtml(vcUrl) + '" target="_blank" rel="noopener">' + escapeHtml(vcUrl) + ' ↗</a>' +
                  '<div class="vc-deploy-status" style="font-size:0.75rem;margin-top:0.2rem">' + vcDeployStatusHtml() + '</div></div>';
          pollVercelDeployStatus();
        } else {
          html += '<div class="int-url" style="color:#999">' + escapeHtml(t('int_no_url')) + '</div>';
        }
        // トークン保存状態
        if (vcTokenExists) {
          html += '<div style="margin-top:0.3rem;font-size:0.8rem;color:#2e7d32">&#128274; ' + escapeHtml(t('int_token_saved')) + '</div>';
          html += renderInfraTokenExpires('vercel_token_enc', infra.vercel_token_expires_at, 'int-vc-exp');
        } else if (vcConnected) {
          html += '<div style="margin-top:0.3rem;font-size:0.8rem;color:#e65100">&#9888; ' + escapeHtml(t('int_token_not_saved')) + '</div>';
        }
        // ボタン行: 再接続 | 接続解除 | トークン再発行（GitHub と同じパターン）
        if (canEdit) {
          html += '<div style="display:flex;gap:0.5rem;margin-top:0.4rem;flex-wrap:wrap">';
          html += '<button class="int-reconnect-vc-btn" style="background:#000;color:#fff;border:none;border-radius:4px;padding:0.3rem 0.8rem;font-size:0.8rem;cursor:pointer">' + escapeHtml(t(vcConnected ? 'int_reconnect' : 'int_connect')) + '</button>';
          if (vcConnected) {
            html += '<button class="int-disconnect-btn" data-service="vercel" style="background:none;border:1px solid #c62828;border-radius:4px;padding:0.2rem 0.6rem;font-size:0.75rem;cursor:pointer;color:#c62828">' + escapeHtml(t('int_disconnect')) + '</button>';
          }
          if (vcTokenExists) {
            html += '<button class="int-reissue-btn" data-target="int-vc-reissue" style="background:none;border:1px solid #e65100;border-radius:4px;padding:0.2rem 0.6rem;font-size:0.75rem;cursor:pointer;color:#e65100">' + escapeHtml(t('int_reissue')) + '</button>';
          }
          html += '</div>';
          // 再接続フォーム（非表示）
          html += '<div id="int-vc-reconnect-form" style="display:none;margin-top:0.5rem;padding:0.6rem;background:#f8f9fa;border:1px solid #e0e0e0;border-radius:6px">';
          html += '<div style="font-size:0.8rem;color:#555;margin-bottom:0.4rem">' + t('int_token_save_hint_vc') + '</div>';
          html += '<div class="int-token-row">';
          html += '<input type="text" id="int-vc-reconnect-token" autocomplete="off" value="" placeholder="' + escapeHtml(t('int_token_placeholder_vc')) + '" style="flex:1;padding:0.4rem 0.6rem;border:1px solid #ccc;border-radius:4px;font-size:0.85rem">';
          html += '<button class="int-reconnect-provision-btn" data-service="vercel" style="margin-left:0.5rem;background:#000;color:#fff;border:none;border-radius:4px;padding:0.4rem 1rem;font-size:0.85rem;cursor:pointer">' + escapeHtml(t(vcConnected ? 'int_reconnect' : 'int_connect')) + '</button>';
          html += '</div>';
          html += '<div style="margin-top:0.3rem">';
          html += '<input type="text" id="int-vc-reconnect-anon-key" autocomplete="off" value="" placeholder="Supabase Anon Key" style="width:100%;padding:0.4rem 0.6rem;border:1px solid #ccc;border-radius:4px;font-size:0.85rem;font-family:monospace">';
          html += '<div style="font-size:0.75rem;color:#888;margin-top:0.2rem">' + escapeHtml(t('int_vc_anon_key_hint')) + '</div>';
          html += '</div>';
          html += '<div style="font-size:0.75rem;color:#888;margin-top:0.3rem">' + escapeHtml(t('int_vc_github_login_hint')) +
                  ' <a href="https://vercel.com/account/login-connections" target="_blank" style="color:#1976d2">① Login Connections ↗</a>' +
                  ' <a href="https://github.com/apps/vercel" target="_blank" style="color:#1976d2">② Vercel GitHub App ↗</a></div>';
          html += '<div id="int-vc-reconnect-msg" style="font-size:0.8rem;margin-top:0.3rem;min-height:1em"></div>';
          html += '</div>';
          // トークン再発行フォーム（非表示）
          if (vcTokenExists) {
            html += '<div id="int-vc-reissue" style="display:none;margin-top:0.4rem">';
            html += '<div style="font-size:0.8rem;color:#555;margin-bottom:0.3rem">' + t('int_token_save_hint_vc') + '</div>';
            html += '<div class="int-token-row">';
            html += '<input type="text" id="int-vc-token" autocomplete="off" value="" placeholder="' + escapeHtml(t('int_token_placeholder_vc')) + '" style="flex:1;padding:0.4rem 0.6rem;border:1px solid #ccc;border-radius:4px;font-size:0.85rem">';
            html += '<select id="int-vc-token-exp" style="padding:0.4rem 0.4rem;border:1px solid #ccc;border-radius:4px;font-size:0.85rem"><option value="">' + escapeHtml(t('int_expires_none')) + '</option><option value="30">30' + escapeHtml(t('int_expires_days_unit')) + '</option><option value="60">60' + escapeHtml(t('int_expires_days_unit')) + '</option><option value="90">90' + escapeHtml(t('int_expires_days_unit')) + '</option><option value="180">180' + escapeHtml(t('int_expires_days_unit')) + '</option><option value="365">365' + escapeHtml(t('int_expires_days_unit')) + '</option></select>';
            html += '<button class="int-connect-btn int-infra-save" data-field="vercel_token_enc" data-input="int-vc-token" data-exp-input="int-vc-token-exp" style="margin-left:0.5rem">' + escapeHtml(t('int_save_token')) + '</button>';
            html += '</div>';
            html += '<div id="int-vc-msg" class="int-infra-msg" style="font-size:0.8rem;margin-top:0.3rem"></div>';
            html += '</div>';
          }
        }
        html += '</div>';

        html += '</div>';
        return html;
      }

      function renderIntChannelsSection(services, envStatus, canEdit, channelConfigs, webhookUrls, redirectUris) {
        channelConfigs = channelConfigs || {};
        webhookUrls = webhookUrls || {};
        redirectUris = redirectUris || {};
        let html = '<div class="int-section">';
        html += '<h3>' + escapeHtml(t('int_channels_title')) + '</h3>';

        // Notion (OAuth)
        const notionSvc = services.notion || {};
        const notionReady = !!(channelConfigs.notion && channelConfigs.notion.is_ready);
        html += renderOAuthCard('notion', notionSvc, notionReady, [
          t('int_notion_step1'),
          t('int_notion_step2'),
          t('int_notion_step3'),
        ], '/api/oauth/notion/authorize', canEdit, channelConfigs.notion, webhookUrls.notion, redirectUris.notion);

        // Slack (OAuth)
        const slackSvc = services.slack || {};
        const slackReady = !!(channelConfigs.slack && channelConfigs.slack.is_ready);
        html += renderOAuthCard('slack', slackSvc, slackReady, [
          t('int_slack_step1'),
          t('int_slack_step2'),
          t('int_slack_step3'),
          t('int_slack_step4'),
        ], '/api/oauth/slack/authorize', canEdit, channelConfigs.slack, webhookUrls.slack, redirectUris.slack);

        // Google Drive (OAuth)
        const gdriveSvc = services.gdrive || {};
        const gdriveReady = !!(channelConfigs.gdrive && channelConfigs.gdrive.is_ready);
        html += renderOAuthCard('gdrive', gdriveSvc, gdriveReady, [
          t('int_gdrive_step1'),
          t('int_gdrive_step2'),
          t('int_gdrive_step3'),
        ], '/api/oauth/gdrive/authorize', canEdit, channelConfigs.gdrive, webhookUrls.gdrive, redirectUris.gdrive);

        // Chatwork (API Token)
        const cwSvc = services.chatwork || {};
        html += renderChatworkCard(cwSvc, envStatus, canEdit, channelConfigs.chatwork, webhookUrls.chatwork);

        html += '</div>';
        return html;
      }

      function renderOAuthCard(provider, svc, envReady, steps, authorizeUrl, canEdit, chConfig, webhookUrl, redirectUri) {
        const titleKey = 'int_' + provider + '_title';
        const connected = !!svc.connected;
        const hasTenantConfig = !!(chConfig && chConfig.has_config);
        let html = '<div class="int-card ' + (connected ? 'connected' : 'disconnected') + '">';
        html += '<div class="int-card-header"><span class="int-card-title">' + escapeHtml(t(titleKey)) + '</span>' + intBadge(connected) + '</div>';

        // 接続情報
        if (connected && svc.updated_at) {
          html += '<div style="font-size:0.8rem;color:#777;margin-top:0.3rem">' + escapeHtml(t('int_updated_at')) + ': ' + escapeHtml(svc.updated_at) + '</div>';
        }
        if (connected && svc.scopes) {
          html += '<div style="font-size:0.8rem;color:#777">' + escapeHtml(t('int_scopes')) + ': ' + escapeHtml(svc.scopes) + '</div>';
        }
        if (connected && svc.expires_at) {
          html += '<div style="font-size:0.8rem;margin-top:0.2rem">' + escapeHtml(t('int_expires_at')) + ': ' + intExpiresBadge(svc.expires_at) + '</div>';
        }

        // 設定手順（閲覧は全員可）
        html += '<div class="int-steps"><strong>' + escapeHtml(t('int_setup_steps')) + '</strong><ol>';
        steps.forEach(s => { html += '<li>' + s + '</li>'; });
        html += '</ol></div>';

        // アプリ設定（折りたたみ、admin/owner のみ）
        if (canEdit) {
          var cfgFields = (chConfig && chConfig.fields) ? chConfig.fields : [];
          html += '<details class="int-ch-config-details" style="margin-top:0.5rem;border:1px solid #e0e0e0;border-radius:6px;padding:0.5rem">';
          html += '<summary style="cursor:pointer;font-size:0.85rem;font-weight:600">' + escapeHtml(t('int_ch_config_title'));
          if (hasTenantConfig) html += ' <span style="color:#2e7d32;font-weight:normal">&#10003;</span>';
          html += '</summary>';
          html += '<div style="margin-top:0.4rem;font-size:0.8rem;color:#666">' + escapeHtml(t('int_ch_config_hint')) + '</div>';
          html += '<div class="int-ch-config-form" data-channel="' + provider + '" style="margin-top:0.4rem">';
          cfgFields.forEach(function(field) {
            var inputId = 'int-ch-' + provider + '-' + field;
            html += '<div style="margin-top:0.3rem">';
            html += '<label for="' + inputId + '" style="font-size:0.8rem;color:#555">' + escapeHtml(field) + '</label>';
            html += '<input type="text" id="' + inputId + '" data-field="' + field + '" autocomplete="off" placeholder="' + escapeHtml(field) + '" style="display:block;width:100%;box-sizing:border-box;padding:0.3rem 0.5rem;border:1px solid #ccc;border-radius:4px;font-size:0.8rem;margin-top:0.15rem">';
            html += '</div>';
          });
          html += '<div style="display:flex;gap:0.5rem;margin-top:0.5rem">';
          html += '<button class="int-ch-config-save" data-channel="' + provider + '" style="background:#1976d2;color:#fff;border:none;border-radius:4px;padding:0.3rem 0.8rem;font-size:0.8rem;cursor:pointer">' + escapeHtml(t('int_ch_config_save')) + '</button>';
          if (hasTenantConfig) {
            html += '<button class="int-ch-config-delete" data-channel="' + provider + '" style="background:none;border:1px solid #c62828;border-radius:4px;padding:0.2rem 0.6rem;font-size:0.75rem;cursor:pointer;color:#c62828">' + escapeHtml(t('int_ch_config_delete')) + '</button>';
          }
          html += '</div>';
          html += '<div class="int-ch-config-msg" data-channel="' + provider + '" style="font-size:0.8rem;margin-top:0.3rem"></div>';
          html += '</div>';
          html += '</details>';
        }

        // Webhook URL 表示
        if (webhookUrl) {
          html += '<div style="margin-top:0.5rem;font-size:0.8rem">';
          html += '<strong>' + escapeHtml(t('int_ch_webhook_url')) + ':</strong> ';
          html += '<code style="font-size:0.75rem;background:#f5f5f5;padding:0.15rem 0.4rem;border-radius:3px;word-break:break-all">' + escapeHtml(webhookUrl) + '</code> ';
          html += '<button class="int-ch-webhook-copy" data-url="' + escapeHtml(webhookUrl) + '" style="background:none;border:1px solid #1976d2;border-radius:4px;padding:0.1rem 0.4rem;font-size:0.7rem;cursor:pointer;color:#1976d2">' + escapeHtml(t('int_ch_webhook_copy')) + '</button>';
          html += '</div>';
        }

        // リダイレクト URI 表示（OAuth プロバイダーに登録する値）
        if (redirectUri) {
          html += '<div style="margin-top:0.4rem;font-size:0.8rem">';
          html += '<strong>' + escapeHtml(t('int_ch_redirect_uri')) + ':</strong> ';
          html += '<code style="font-size:0.75rem;background:#f5f5f5;padding:0.15rem 0.4rem;border-radius:3px;word-break:break-all">' + escapeHtml(redirectUri) + '</code> ';
          html += '<button class="int-ch-webhook-copy" data-url="' + escapeHtml(redirectUri) + '" style="background:none;border:1px solid #1976d2;border-radius:4px;padding:0.1rem 0.4rem;font-size:0.7rem;cursor:pointer;color:#1976d2">' + escapeHtml(t('int_ch_webhook_copy')) + '</button>';
          html += '</div>';
        }

        // 接続ボタン（admin/owner のみ）— pre-authorize 経由
        if (canEdit) {
          if (!envReady && !hasTenantConfig) {
            html += '<div style="margin-top:0.5rem;font-size:0.85rem;color:#e65100">' + escapeHtml(t('int_env_not_configured')) + '</div>';
          } else {
            var btnStyle = connected ? ' style="opacity:0.6"' : '';
            html += '<button class="int-connect-oauth-btn" data-channel="' + provider + '"' + btnStyle + '>' + escapeHtml(t('int_connect_oauth')) + '</button>';
          }
        }

        html += '</div>';
        return html;
      }

      function renderChatworkCard(svc, envStatus, canEdit, chConfig, webhookUrl) {
        const connected = !!svc.connected;
        const hasTenantConfig = !!(chConfig && chConfig.has_config);
        let html = '<div class="int-card ' + (connected ? 'connected' : 'disconnected') + '">';
        html += '<div class="int-card-header"><span class="int-card-title">' + escapeHtml(t('int_chatwork_title')) + '</span>' + intBadge(connected) + '</div>';

        if (connected && svc.updated_at) {
          html += '<div style="font-size:0.8rem;color:#777;margin-top:0.3rem">' + escapeHtml(t('int_updated_at')) + ': ' + escapeHtml(svc.updated_at) + '</div>';
        }

        // 設定手順（閲覧は全員可）
        html += '<div class="int-steps"><strong>' + escapeHtml(t('int_setup_steps')) + '</strong><ol>';
        html += '<li>' + t('int_chatwork_step1') + '</li>';
        html += '<li>' + t('int_chatwork_step2') + '</li>';
        html += '</ol></div>';

        // アプリ設定（折りたたみ、admin/owner のみ）
        if (canEdit) {
          var cfgFields = ['api_token', 'webhook_token', 'bot_account_id'];
          html += '<details class="int-ch-config-details" style="margin-top:0.5rem;border:1px solid #e0e0e0;border-radius:6px;padding:0.5rem">';
          html += '<summary style="cursor:pointer;font-size:0.85rem;font-weight:600">' + escapeHtml(t('int_ch_config_title'));
          if (hasTenantConfig) html += ' <span style="color:#2e7d32;font-weight:normal">&#10003;</span>';
          html += '</summary>';
          html += '<div style="margin-top:0.4rem;font-size:0.8rem;color:#666">' + escapeHtml(t('int_ch_config_hint')) + '</div>';
          html += '<div class="int-ch-config-form" data-channel="chatwork" style="margin-top:0.4rem">';
          cfgFields.forEach(function(field) {
            var inputId = 'int-ch-chatwork-' + field;
            html += '<div style="margin-top:0.3rem">';
            html += '<label for="' + inputId + '" style="font-size:0.8rem;color:#555">' + escapeHtml(field) + '</label>';
            html += '<input type="text" id="' + inputId + '" data-field="' + field + '" autocomplete="off" placeholder="' + escapeHtml(field) + '" style="display:block;width:100%;box-sizing:border-box;padding:0.3rem 0.5rem;border:1px solid #ccc;border-radius:4px;font-size:0.8rem;margin-top:0.15rem">';
            html += '</div>';
          });
          html += '<div style="display:flex;gap:0.5rem;margin-top:0.5rem">';
          html += '<button class="int-ch-config-save" data-channel="chatwork" style="background:#1976d2;color:#fff;border:none;border-radius:4px;padding:0.3rem 0.8rem;font-size:0.8rem;cursor:pointer">' + escapeHtml(t('int_ch_config_save')) + '</button>';
          if (hasTenantConfig) {
            html += '<button class="int-ch-config-delete" data-channel="chatwork" style="background:none;border:1px solid #c62828;border-radius:4px;padding:0.2rem 0.6rem;font-size:0.75rem;cursor:pointer;color:#c62828">' + escapeHtml(t('int_ch_config_delete')) + '</button>';
          }
          html += '</div>';
          html += '<div class="int-ch-config-msg" data-channel="chatwork" style="font-size:0.8rem;margin-top:0.3rem"></div>';
          html += '</div>';
          html += '</details>';
        }

        // Webhook URL 表示
        if (webhookUrl) {
          html += '<div style="margin-top:0.5rem;font-size:0.8rem">';
          html += '<strong>' + escapeHtml(t('int_ch_webhook_url')) + ':</strong> ';
          html += '<code style="font-size:0.75rem;background:#f5f5f5;padding:0.15rem 0.4rem;border-radius:3px;word-break:break-all">' + escapeHtml(webhookUrl) + '</code> ';
          html += '<button class="int-ch-webhook-copy" data-url="' + escapeHtml(webhookUrl) + '" style="background:none;border:1px solid #1976d2;border-radius:4px;padding:0.1rem 0.4rem;font-size:0.7rem;cursor:pointer;color:#1976d2">' + escapeHtml(t('int_ch_webhook_copy')) + '</button>';
          html += '</div>';
        }

        // 旧トークン入力欄（後方互換、admin/owner のみ）
        if (canEdit && !hasTenantConfig) {
          html += '<div class="int-token-row" style="margin-top:0.5rem">';
          html += '<input type="text" id="int-chatwork-token" autocomplete="off" value="" placeholder="' + escapeHtml(t('int_chatwork_placeholder')) + '" style="flex:1;padding:0.4rem 0.6rem;border:1px solid #ccc;border-radius:4px;font-size:0.85rem">';
          html += '<button id="int-chatwork-save" class="int-connect-btn" style="margin-left:0.5rem">' + escapeHtml(t('int_save_token')) + '</button>';
          html += '</div>';
          html += '<div id="int-chatwork-msg" style="font-size:0.8rem;margin-top:0.3rem"></div>';
        }

        html += '</div>';
        return html;
      }

      function renderIntEnvTable(envStatus) {
        let html = '<div class="int-section">';
        html += '<h3>' + escapeHtml(t('int_env_title')) + '</h3>';
        html += '<table class="int-env-table">';

        const envKeys = [
          'GITHUB_CLIENT_ID',
        ];

        envKeys.forEach(key => {
          const isSet = !!envStatus[key];
          const dotClass = isSet ? 'set' : 'unset';
          const label = isSet ? t('int_env_set') : t('int_env_unset');
          html += '<tr>';
          html += '<td style="font-family:monospace;font-size:0.8rem">' + escapeHtml(key) + '</td>';
          html += '<td><span class="int-env-dot ' + dotClass + '"></span> ' + escapeHtml(label) + '</td>';
          html += '</tr>';
        });

        html += '</table></div>';
        return html;
      }

      function attachIntegrationHandlers(data) {
        // OAuth 接続ボタン
        document.querySelectorAll('.int-connect-btn[data-oauth-url]').forEach(btn => {
          btn.addEventListener('click', () => {
            window.location.href = btn.getAttribute('data-oauth-url');
          });
        });

        // Chatwork トークン保存
        const saveBtn = document.getElementById('int-chatwork-save');
        const tokenInput = document.getElementById('int-chatwork-token');
        const msgEl = document.getElementById('int-chatwork-msg');
        if (saveBtn && tokenInput) {
          saveBtn.addEventListener('click', async () => {
            const val = tokenInput.value.trim();
            if (!val) return;
            saveBtn.disabled = true;
            msgEl.textContent = '';
            try {
              const res = await apiFetch('/api/integrations/chatwork/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: val }),
              });
              if (res.ok) {
                msgEl.textContent = t('int_chatwork_saved');
                msgEl.style.color = '#2e7d32';
                tokenInput.value = '';
                loadIntegrations();
              } else {
                const err = await res.json().catch(() => ({}));
                msgEl.textContent = err.detail || 'Error';
                msgEl.style.color = '#c62828';
              }
            } catch (e) {
              msgEl.textContent = e.message;
              msgEl.style.color = '#c62828';
            } finally {
              saveBtn.disabled = false;
            }
          });
        }

        // インフラトークン保存（Supabase / Vercel）
        document.querySelectorAll('.int-infra-save').forEach(btn => {
          btn.addEventListener('click', async () => {
            const field = btn.getAttribute('data-field');
            const inputId = btn.getAttribute('data-input');
            const expInputId = btn.getAttribute('data-exp-input');
            const input = document.getElementById(inputId);
            if (!input) return;
            const val = input.value.trim();
            if (!val) return;
            const expInput = expInputId ? document.getElementById(expInputId) : null;
            const expDays = expInput ? parseInt(expInput.value, 10) : 0;
            const expiresAt = expDays > 0 ? new Date(Date.now() + expDays * 86400000).toISOString() : '';
            const msgEl = btn.closest('.int-token-row').nextElementSibling;
            btn.disabled = true;
            if (msgEl) msgEl.textContent = '';
            try {
              const res = await apiFetch('/api/integrations/infra-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ field: field, token: val, expires_at: expiresAt }),
              });
              if (res.ok) {
                if (msgEl) { msgEl.textContent = t('int_infra_token_saved'); msgEl.style.color = '#2e7d32'; }
                input.value = '';
                loadIntegrations();
              } else {
                const err = await res.json().catch(() => ({}));
                if (msgEl) { msgEl.textContent = err.detail || 'Error'; msgEl.style.color = '#c62828'; }
              }
            } catch (e) {
              if (msgEl) { msgEl.textContent = e.message; msgEl.style.color = '#c62828'; }
            } finally {
              btn.disabled = false;
            }
          });
        });

        // インフラ切断ボタン
        document.querySelectorAll('.int-disconnect-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const service = btn.getAttribute('data-service');
            const label = service.charAt(0).toUpperCase() + service.slice(1);
            if (!confirm(label + t('int_disconnect_confirm'))) return;
            btn.disabled = true;
            try {
              const res = await apiFetch('/api/integrations/disconnect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ service: service }),
              });
              if (res.ok) {
                loadIntegrations();
                loadOnboarding();
              } else {
                const err = await res.json().catch(() => ({}));
                alert(err.detail || 'Error');
              }
            } catch (e) {
              alert(e.message);
            } finally {
              btn.disabled = false;
            }
          });
        });

        // GitHub 再接続ボタン（連携設定パネル）
        document.querySelectorAll('.int-reconnect-github-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            btn.disabled = true;
            btn.textContent = '...';
            try {
              const res = await apiFetch('/api/oauth/github/pre-authorize', { method: 'POST' });
              if (res.ok) {
                const data = await res.json();
                window.location.href = data.authorize_url;
              } else {
                window.location.href = '/api/oauth/github/authorize';
              }
            } catch (e) {
              window.location.href = '/api/oauth/github/authorize';
            }
          });
        });

        // Supabase 再接続ボタン → フォームをトグル
        document.querySelectorAll('.int-reconnect-sb-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const form = document.getElementById('int-sb-reconnect-form');
            if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
          });
        });

        // Vercel 再接続ボタン → フォームをトグル
        document.querySelectorAll('.int-reconnect-vc-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const form = document.getElementById('int-vc-reconnect-form');
            if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
          });
        });

        // 再接続プロビジョニング実行（Supabase / Vercel 共通）
        document.querySelectorAll('.int-reconnect-provision-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const service = btn.getAttribute('data-service');
            const isSupabase = service === 'supabase';
            const tokenInputId = isSupabase ? 'int-sb-reconnect-token' : 'int-vc-reconnect-token';
            const msgElId = isSupabase ? 'int-sb-reconnect-msg' : 'int-vc-reconnect-msg';
            const spinnerKey = isSupabase ? 'int_reconnect_provisioning_sb' : 'int_reconnect_provisioning_vc';

            const tokenInput = document.getElementById(tokenInputId);
            const token = tokenInput ? tokenInput.value.trim() : '';
            if (!token) { if (tokenInput) tokenInput.focus(); return; }

            const msgEl = document.getElementById(msgElId);
            btn.disabled = true;

            if (msgEl) {
              msgEl.innerHTML = '<span class="ob-spinner-inline"></span>' + escapeHtml(t(spinnerKey));
              msgEl.style.color = '#1976d2';
            }

            try {
              var bodyObj = { access_token: token };
              if (!isSupabase) {
                var anonKeyInput = document.getElementById('int-vc-reconnect-anon-key');
                bodyObj.supabase_anon_key = anonKeyInput ? anonKeyInput.value.trim() : '';
              }

              const res = await apiFetch('/api/integrations/reconnect/' + service, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyObj),
              });

              if (res.ok) {
                const isVercel = service === 'vercel';
                if (msgEl) { msgEl.textContent = t('int_reconnect_success'); msgEl.style.color = '#2e7d32'; }
                if (tokenInput) tokenInput.value = '';
                if (isVercel) { _vcDeployState = null; }
                loadIntegrations();
                loadOnboarding();
              } else {
                const err = await res.json().catch(() => ({}));
                if (msgEl) { msgEl.textContent = t('int_reconnect_failed') + (err.detail || ''); msgEl.style.color = '#c62828'; }
              }
            } catch (e) {
              if (msgEl) { msgEl.textContent = t('int_reconnect_failed') + e.message; msgEl.style.color = '#c62828'; }
            } finally {
              btn.disabled = false;
            }
          });
        });

        // 再発行ボタン → 隠し入力欄をトグル
        document.querySelectorAll('.int-reissue-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (target) target.style.display = target.style.display === 'none' ? 'block' : 'none';
          });
        });

        // 有効期限「変更」ボタン → 日付入力を表示
        document.querySelectorAll('.int-expires-edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const formId = btn.getAttribute('data-target');
            const form = document.getElementById(formId);
            if (form) form.style.display = form.style.display === 'none' ? 'inline-flex' : 'none';
          });
        });

        // 有効期限「保存」ボタン
        document.querySelectorAll('.int-expires-save-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const field = btn.getAttribute('data-field');
            const formId = btn.getAttribute('data-form');
            const form = document.getElementById(formId);
            const selectEl = form ? form.querySelector('.int-expires-input') : null;
            const msgEl = document.getElementById(formId + '-msg');
            if (!selectEl) return;
            const days = parseInt(selectEl.value, 10);
            const expiresAt = days > 0 ? new Date(Date.now() + days * 86400000).toISOString() : '';
            btn.disabled = true;
            if (msgEl) msgEl.textContent = '';
            try {
              const res = await apiFetch('/api/integrations/infra-token/expires', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ field: field, expires_at: expiresAt }),
              });
              if (res.ok) {
                if (msgEl) { msgEl.textContent = t('int_expires_saved'); msgEl.style.color = '#2e7d32'; }
                loadIntegrations();
              } else {
                const err = await res.json().catch(() => ({}));
                if (msgEl) { msgEl.textContent = err.detail || 'Error'; msgEl.style.color = '#c62828'; }
              }
            } catch (e) {
              if (msgEl) { msgEl.textContent = e.message; msgEl.style.color = '#c62828'; }
            } finally {
              btn.disabled = false;
            }
          });
        });

        // チャネル設定保存ボタン
        document.querySelectorAll('.int-ch-config-save').forEach(btn => {
          btn.addEventListener('click', async () => {
            const channel = btn.getAttribute('data-channel');
            const form = btn.closest('.int-ch-config-form');
            if (!form) return;
            const configData = {};
            form.querySelectorAll('input[data-field]').forEach(input => {
              const val = input.value.trim();
              if (val) configData[input.getAttribute('data-field')] = val;
            });
            if (Object.keys(configData).length === 0) return;
            btn.disabled = true;
            const msgEl = form.querySelector('.int-ch-config-msg');
            if (msgEl) msgEl.textContent = '';
            try {
              const res = await apiFetch('/api/integrations/channel-config/' + channel, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(configData),
              });
              if (res.ok) {
                if (msgEl) { msgEl.textContent = t('int_ch_config_saved'); msgEl.style.color = '#2e7d32'; }
                loadIntegrations();
              } else {
                const err = await res.json().catch(() => ({}));
                if (msgEl) { msgEl.textContent = err.detail || 'Error'; msgEl.style.color = '#c62828'; }
              }
            } catch (e) {
              if (msgEl) { msgEl.textContent = e.message; msgEl.style.color = '#c62828'; }
            } finally {
              btn.disabled = false;
            }
          });
        });

        // チャネル設定削除ボタン
        document.querySelectorAll('.int-ch-config-delete').forEach(btn => {
          btn.addEventListener('click', async () => {
            const channel = btn.getAttribute('data-channel');
            btn.disabled = true;
            const form = btn.closest('.int-ch-config-form');
            const msgEl = form ? form.querySelector('.int-ch-config-msg') : null;
            if (msgEl) msgEl.textContent = '';
            try {
              const res = await apiFetch('/api/integrations/channel-config/' + channel, { method: 'DELETE' });
              if (res.ok) {
                if (msgEl) { msgEl.textContent = t('int_ch_config_deleted'); msgEl.style.color = '#2e7d32'; }
                loadIntegrations();
              } else {
                const err = await res.json().catch(() => ({}));
                if (msgEl) { msgEl.textContent = err.detail || 'Error'; msgEl.style.color = '#c62828'; }
              }
            } catch (e) {
              if (msgEl) { msgEl.textContent = e.message; msgEl.style.color = '#c62828'; }
            } finally {
              btn.disabled = false;
            }
          });
        });

        // OAuth pre-authorize ボタン（チャネル別）
        document.querySelectorAll('.int-connect-oauth-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const channel = btn.getAttribute('data-channel');
            btn.disabled = true;
            btn.textContent = '...';
            try {
              const res = await apiFetch('/api/oauth/' + channel + '/pre-authorize', { method: 'POST' });
              if (res.ok) {
                const data = await res.json();
                window.location.href = data.authorize_url;
              } else {
                const err = await res.json().catch(() => ({}));
                alert(err.detail || t('int_env_not_configured'));
                btn.disabled = false;
                btn.textContent = t('int_connect_oauth');
              }
            } catch (e) {
              alert(t('int_env_not_configured'));
              btn.disabled = false;
              btn.textContent = t('int_connect_oauth');
            }
          });
        });

        // Webhook URL コピーボタン
        document.querySelectorAll('.int-ch-webhook-copy').forEach(btn => {
          btn.addEventListener('click', () => {
            const url = btn.getAttribute('data-url');
            if (navigator.clipboard) {
              navigator.clipboard.writeText(url).then(() => {
                const orig = btn.textContent;
                btn.textContent = t('int_ch_webhook_copied');
                btn.style.color = '#2e7d32';
                btn.style.borderColor = '#2e7d32';
                setTimeout(() => { btn.textContent = orig; btn.style.color = '#1976d2'; btn.style.borderColor = '#1976d2'; }, 2000);
              });
            }
          });
        });
      }

      // ===== BPO AI Employee =====
      let allBpoTasks = [];
      let bpoCurrentFilter = 'all';
      let selectedBpoTaskId = null;
      let bpoConnections = [];
      let bpoPollTimer = null;

      const bpoTasksEl = document.getElementById('bpo-tasks');
      const bpoDetailEl = document.getElementById('bpo-detail');
      const bpoSubmitBtn = document.getElementById('bpo-submit-btn');
      const bpoTaskInput = document.getElementById('bpo-task-input');
      const bpoSaasSelect = document.getElementById('bpo-saas-select');
      const bpoDryrunEl = document.getElementById('bpo-dryrun');
      const bpoSummaryEl = document.getElementById('bpo-dashboard-summary');

      function bpoStatusMap() {
        return {
          'planning':           { label: t('bpo_status_planning'),  badge: 'bpo-badge-planning' },
          'awaiting_approval':  { label: t('bpo_status_awaiting'),  badge: 'bpo-badge-awaiting_approval' },
          'executing':          { label: t('bpo_status_executing'), badge: 'bpo-badge-executing' },
          'completed':          { label: t('bpo_status_completed'), badge: 'bpo-badge-completed' },
          'failed':             { label: t('bpo_status_failed'),    badge: 'bpo-badge-failed' },
          'rejected':           { label: t('bpo_status_rejected'),  badge: 'bpo-badge-rejected' },
        };
      }

      async function loadBpoConnections() {
        try {
          var res = await apiFetch('/api/saas/connections');
          if (res.ok) {
            var connData = await res.json();
            bpoConnections = connData.connections || [];
            bpoSaasSelect.innerHTML = '<option value="">' + escapeHtml(t('bpo_select_saas')) + '</option>';
            (bpoConnections || []).forEach(function(conn) {
              if (conn.status === 'active') {
                var opt = document.createElement('option');
                opt.value = conn.id;
                opt.textContent = conn.saas_name + (conn.genre ? ' (' + conn.genre + ')' : '');
                opt.dataset.saasName = conn.saas_name;
                bpoSaasSelect.appendChild(opt);
              }
            });
            // localStorage から保存済みの選択を復元
            var savedConn = localStorage.getItem('bpo_selected_connection');
            if (savedConn && bpoSaasSelect.querySelector('option[value="' + savedConn + '"]')) {
              bpoSaasSelect.value = savedConn;
            }
          }
        } catch (e) {}
      }

      async function loadBpoTasks() {
        try {
          var res = await apiFetch('/api/bpo/tasks');
          if (res.ok) {
            var data = await res.json();
            allBpoTasks = data.tasks || [];
            renderBpoTasks();
            loadBpoDashboardSummary();

            // 計画中 or 実行中のタスクがあれば 5 秒ポーリング
            var hasPending = allBpoTasks.some(function(t) {
              return t.status === 'planning' || t.status === 'executing';
            });
            if (hasPending && !bpoPollTimer) {
              bpoPollTimer = setInterval(function() { loadBpoTasks(); }, 5000);
            } else if (!hasPending && bpoPollTimer) {
              clearInterval(bpoPollTimer);
              bpoPollTimer = null;
              // 選択中タスクの詳細も更新
              if (selectedBpoTaskId) loadBpoTaskDetail(selectedBpoTaskId);
            }
          }
        } catch (e) {
          bpoTasksEl.innerHTML = '<li class="empty-msg">' + escapeHtml(t('load_failed')) + '</li>';
        }
      }

      function renderBpoTasks() {
        var sm = bpoStatusMap();
        var filtered = allBpoTasks.filter(function(task) {
          if (bpoCurrentFilter === 'all') return true;
          return task.status === bpoCurrentFilter;
        });
        if (filtered.length === 0) {
          bpoTasksEl.innerHTML = '<li class="empty-msg">' + escapeHtml(t('bpo_no_tasks')) + '</li>';
          return;
        }
        bpoTasksEl.innerHTML = filtered.map(function(task) {
          var info = sm[task.status] || { label: task.status, badge: 'bpo-badge-planning' };
          var sel = (task.task_id === selectedBpoTaskId) ? ' selected' : '';
          var desc = (task.task_description || '').substring(0, 80);
          var dateStr = task.created_at ? new Date(task.created_at).toLocaleString() : '';
          return '<li class="bpo-' + escapeHtml(task.status) + sel + '" data-task-id="' + escapeHtml(task.task_id) + '">' +
            '<span class="bpo-badge ' + info.badge + '">' + escapeHtml(info.label) + '</span>' +
            '<div class="bpo-task-info">' +
              '<div class="bpo-task-title">' + escapeHtml(task.saas_name || '') + '</div>' +
              '<div class="bpo-task-desc">' + escapeHtml(desc) + '</div>' +
            '</div>' +
            '<span class="meta">' + escapeHtml(dateStr) + '</span>' +
            '</li>';
        }).join('');

        bpoTasksEl.querySelectorAll('li[data-task-id]').forEach(function(li) {
          li.addEventListener('click', function() {
            selectedBpoTaskId = li.dataset.taskId;
            renderBpoTasks();
            loadBpoTaskDetail(selectedBpoTaskId);
          });
        });
      }

      async function loadBpoTaskDetail(taskId) {
        bpoDetailEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('loading')) + '</span>';
        try {
          var res = await apiFetch('/api/bpo/tasks/' + taskId);
          if (!res.ok) {
            bpoDetailEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('detail_load_failed')) + '</span>';
            return;
          }
          var task = await res.json();
          var html = '';

          // Basic info
          html += '<div style="margin-bottom:0.75rem;">';
          html += '<strong>' + escapeHtml(t('bpo_saas')) + ':</strong> ' + escapeHtml(task.saas_name || '-');
          html += ' &nbsp; <strong>' + escapeHtml(t('bpo_created_at')) + ':</strong> ' + escapeHtml(task.created_at ? new Date(task.created_at).toLocaleString() : '-');
          html += '</div>';
          html += '<div style="margin-bottom:0.75rem;font-size:0.95rem;">' + escapeHtml(task.task_description || '') + '</div>';

          // Plan
          if (task.plan_markdown) {
            html += '<h4>' + escapeHtml(t('bpo_plan_title')) + '</h4>';
            html += '<div class="bpo-plan-preview">' + escapeHtml(task.plan_markdown) + '</div>';
          }

          // Failure reason
          if (task.status === 'failed' && task.failure_reason) {
            html += '<div style="margin:0.75rem 0;padding:0.75rem;background:#fce4ec;border-radius:6px;border-left:4px solid #c62828;">';
            html += '<strong style="color:#c62828;">' + escapeHtml(t('bpo_failure_reason') || 'エラー原因') + '</strong>';
            if (task.failure_category) {
              html += ' <span style="font-size:0.8rem;color:#888;">(' + escapeHtml(task.failure_category) + ')</span>';
            }
            html += '<div style="margin-top:0.4rem;font-size:0.9rem;white-space:pre-wrap;">' + escapeHtml(task.failure_reason) + '</div>';
            if (task.failure_detail) {
              html += '<details style="margin-top:0.4rem;"><summary style="font-size:0.8rem;cursor:pointer;color:#666;">' + escapeHtml(t('bpo_failure_detail') || '詳細') + '</summary>';
              html += '<pre style="margin:0.3rem 0 0;font-size:0.8rem;white-space:pre-wrap;color:#555;">' + escapeHtml(task.failure_detail) + '</pre></details>';
            }
            html += '</div>';
          }

          // Approve / Reject buttons
          if (task.status === 'awaiting_approval') {
            html += '<div class="bpo-actions">';
            html += '<button class="bpo-btn-approve" id="bpo-approve-btn">' + escapeHtml(t('bpo_approve')) + '</button>';
            html += '<button class="bpo-btn-reject" id="bpo-reject-btn">' + escapeHtml(t('bpo_reject')) + '</button>';
            html += '</div>';
          }

          // Result summary
          if (task.result_summary && (task.status === 'completed' || task.status === 'failed')) {
            var rs = task.result_summary;
            html += '<h4>' + escapeHtml(t('bpo_result_title')) + '</h4>';
            html += '<div class="bpo-result-summary">';
            html += '<div class="bpo-summary-stat">';
            html += '<span class="success">' + escapeHtml(t('bpo_success_count')) + ': ' + (rs.success_count || 0) + '</span>';
            html += '<span class="failure">' + escapeHtml(t('bpo_failure_count')) + ': ' + (rs.failure_count || 0) + '</span>';
            html += '<span>' + escapeHtml(t('bpo_total_ops')) + ': ' + (rs.total_operations || 0) + '</span>';
            html += '</div>';
            if (rs.errors && rs.errors.length > 0) {
              html += '<div style="margin-top:0.5rem;"><strong>' + escapeHtml(t('bpo_errors_title')) + ':</strong>';
              html += '<ul style="margin:0.25rem 0 0 1rem;">';
              rs.errors.forEach(function(err) {
                html += '<li style="font-size:0.85rem;color:#c62828;">' + escapeHtml(err) + '</li>';
              });
              html += '</ul></div>';
            }
            html += '</div>';
          }

          // Report
          if (task.report_markdown) {
            html += '<h4>' + escapeHtml(t('bpo_report_title')) + '</h4>';
            html += '<div class="bpo-plan-preview">' + escapeHtml(task.report_markdown) + '</div>';
          }

          bpoDetailEl.innerHTML = html;

          // Attach approve/reject handlers
          var approveBtn = document.getElementById('bpo-approve-btn');
          var rejectBtn = document.getElementById('bpo-reject-btn');
          if (approveBtn) {
            approveBtn.addEventListener('click', async function() {
              approveBtn.disabled = true;
              approveBtn.textContent = t('bpo_approving');
              if (rejectBtn) rejectBtn.disabled = true;
              try {
                var r = await apiFetch('/api/bpo/tasks/' + taskId + '/approve', { method: 'POST' });
                if (r.ok) {
                  loadBpoTasks();
                  setTimeout(function() { loadBpoTaskDetail(taskId); }, 1000);
                }
              } catch (e) {}
            });
          }
          if (rejectBtn) {
            rejectBtn.addEventListener('click', async function() {
              rejectBtn.disabled = true;
              if (approveBtn) approveBtn.disabled = true;
              try {
                var r = await apiFetch('/api/bpo/tasks/' + taskId + '/reject', { method: 'POST' });
                if (r.ok) {
                  loadBpoTasks();
                  loadBpoTaskDetail(taskId);
                }
              } catch (e) {}
            });
          }

        } catch (e) {
          bpoDetailEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('detail_load_failed')) + '</span>';
        }
      }

      async function loadBpoDashboardSummary() {
        try {
          var res = await apiFetch('/api/bpo/dashboard-summary');
          if (res.ok) {
            var data = await res.json();
            bpoSummaryEl.innerHTML =
              '<div class="bpo-summary-card"><div class="num">' + (data.total || 0) + '</div><div class="label">' + escapeHtml(t('bpo_summary_total')) + '</div></div>' +
              '<div class="bpo-summary-card"><div class="num" style="color:#ff9800;">' + (data.awaiting_approval || 0) + '</div><div class="label">' + escapeHtml(t('bpo_summary_awaiting')) + '</div></div>' +
              '<div class="bpo-summary-card"><div class="num" style="color:#2196f3;">' + (data.executing || 0) + '</div><div class="label">' + escapeHtml(t('bpo_summary_running')) + '</div></div>' +
              '<div class="bpo-summary-card"><div class="num" style="color:#4caf50;">' + (data.success_rate != null ? data.success_rate + '%' : '-') + '</div><div class="label">' + escapeHtml(t('bpo_summary_success_rate')) + '</div></div>';
          }
        } catch (e) {}
      }

      // BPO status filter
      document.querySelectorAll('#bpo-status-filters button').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('#bpo-status-filters button').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          bpoCurrentFilter = btn.dataset.filter;
          renderBpoTasks();
        });
      });

      // BPO フォーム入力値の自動保存
      bpoSaasSelect.addEventListener('change', function() {
        localStorage.setItem('bpo_selected_connection', bpoSaasSelect.value);
      });
      bpoTaskInput.addEventListener('input', function() {
        localStorage.setItem('bpo_task_description', bpoTaskInput.value);
      });
      bpoDryrunEl.addEventListener('change', function() {
        localStorage.setItem('bpo_dryrun', bpoDryrunEl.checked ? '1' : '');
      });
      // 保存済み入力値の復元
      (function restoreBpoForm() {
        var savedDesc = localStorage.getItem('bpo_task_description');
        if (savedDesc) bpoTaskInput.value = savedDesc;
        var savedDry = localStorage.getItem('bpo_dryrun');
        if (savedDry === '1') bpoDryrunEl.checked = true;
      })();

      // BPO task submit
      bpoSubmitBtn.addEventListener('click', async function() {
        var connectionId = bpoSaasSelect.value;
        var description = bpoTaskInput.value.trim();
        var dryRun = bpoDryrunEl.checked;

        if (!connectionId) {
          alert(t('bpo_no_connection'));
          return;
        }
        if (!description) {
          alert(t('bpo_no_description'));
          return;
        }

        bpoSubmitBtn.disabled = true;
        bpoSubmitBtn.textContent = t('bpo_task_creating');

        try {
          var res = await apiFetch('/api/bpo/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              connection_id: connectionId,
              task_description: description,
              dry_run: dryRun
            })
          });
          if (res.ok) {
            bpoTaskInput.value = '';
            bpoDryrunEl.checked = false;
            localStorage.removeItem('bpo_task_description');
            localStorage.removeItem('bpo_dryrun');
            loadBpoTasks();
          } else {
            var err = await res.json().catch(function() { return {}; });
            alert(t('bpo_task_create_failed') + (err.detail ? '\n' + err.detail : ''));
          }
        } catch (e) {
          alert(t('bpo_task_create_failed'));
        } finally {
          bpoSubmitBtn.disabled = false;
          bpoSubmitBtn.textContent = t('bpo_submit');
        }
      });

      // ===== SaaS Connections (Setup Panel) =====
      var saasContainerEl = document.getElementById('saas-connections-container');
      var INSTANCE_URL_SAAS = ['kintone', 'smarthr'];
      var GENRE_LABELS = {
        accounting: '会計', sfa: '営業管理', communication: 'コミュニケーション',
        productivity: '生産性', admin: '管理', hr: '人事',
      };

      async function loadSaasConnections() {
        try {
          var [supportedRes, connRes] = await Promise.all([
            apiFetch('/api/saas/supported'),
            apiFetch('/api/saas/connections')
          ]);
          var supportedData = supportedRes.ok ? await supportedRes.json() : { saas_list: [] };
          var connData = connRes.ok ? await connRes.json() : {};
          var connections = connData.connections || [];
          var supported = supportedData.saas_list || [];

          // 保存済み設定を並列取得
          var configPromises = supported.map(function(s) {
            return apiFetch('/api/integrations/channel-config/' + s.saas_name)
              .then(function(r) { return r.ok ? r.json() : null; })
              .catch(function() { return null; });
          });
          var configs = await Promise.all(configPromises);
          var savedConfigs = {};
          supported.forEach(function(s, i) {
            if (configs[i] && configs[i].has_config) savedConfigs[s.saas_name] = configs[i].fields;
          });

          renderSaasCards(supported, connections, savedConfigs);
        } catch (e) {
          saasContainerEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('load_failed')) + '</span>';
        }
      }

      // SaaS 入力値の一時保存（renderSaasCards の innerHTML 書き換えで消えるのを防止）
      function _saveSaasInputs() {
        var saved = {};
        document.querySelectorAll('.saas-config-form').forEach(function(form) {
          var saas = form.dataset.saas;
          if (!saas) return;
          var cid = form.querySelector('.saas-client-id');
          var csec = form.querySelector('.saas-client-secret');
          var inst = form.querySelector('.saas-instance-url');
          if (cid && cid.value) saved[saas] = saved[saas] || {};
          if (cid && cid.value) saved[saas].client_id = cid.value;
          if (csec && csec.value) saved[saas] = saved[saas] || {};
          if (csec && csec.value) saved[saas].client_secret = csec.value;
          if (inst && inst.value) saved[saas] = saved[saas] || {};
          if (inst && inst.value) saved[saas].instance_url = inst.value;
        });
        return saved;
      }
      function _restoreSaasInputs(saved) {
        Object.keys(saved).forEach(function(saas) {
          var form = saasContainerEl.querySelector('.saas-config-form[data-saas="' + saas + '"]');
          if (!form) return;
          var d = saved[saas];
          if (d.client_id) { var el = form.querySelector('.saas-client-id'); if (el) el.value = d.client_id; }
          if (d.client_secret) { var el = form.querySelector('.saas-client-secret'); if (el) el.value = d.client_secret; }
          if (d.instance_url) { var el = form.querySelector('.saas-instance-url'); if (el) el.value = d.instance_url; }
        });
      }

      function renderSaasCards(supported, connections, savedConfigs) {
        // Update section badge
        var connCount = (connections || []).filter(function(c) { return c.status === 'active'; }).length;
        var saasBadge = document.getElementById('saas-section-badge');
        if (saasBadge) {
          saasBadge.textContent = connCount + ' / ' + supported.length;
          saasBadge.className = 'setup-section-badge' + (connCount === supported.length && supported.length > 0 ? ' ok' : '');
        }
        if (!supported.length) {
          saasContainerEl.innerHTML = '<span class="empty-msg">' + escapeHtml(t('saas_no_supported')) + '</span>';
          return;
        }
        var connMap = {};
        (connections || []).forEach(function(c) {
          // active な接続を優先（重複レコード対策）
          if (!connMap[c.saas_name] || c.status === 'active') connMap[c.saas_name] = c;
        });
        var toggleStates = _loadToggleStates();

        var html = '';
        supported.forEach(function(s) {
          var conn = connMap[s.saas_name];
          var isConnected = conn && conn.status === 'active';
          var cardClass = isConnected ? 'saas-card connected' : 'saas-card disconnected';
          var genreLabel = GENRE_LABELS[s.genre] || s.genre || '';

          html += '<div class="' + cardClass + '" data-saas="' + escapeHtml(s.saas_name) + '">';
          html += '<div class="saas-card-header">';
          html += '<span class="saas-card-title">' + escapeHtml(s.display_name) + '<span class="saas-card-genre">' + escapeHtml(genreLabel) + '</span></span>';
          if (isConnected) {
            html += '<span class="int-badge ok">' + escapeHtml(t('saas_connected')) + '</span>';
          } else {
            html += '<span class="int-badge ng">' + escapeHtml(t('saas_disconnected')) + '</span>';
          }
          html += '</div>';

          if (isConnected) {
            html += '<div style="font-size:0.85rem;color:#555;">' + escapeHtml(s.description || '') + '</div>';
            html += '<button class="saas-btn disconnect" data-saas="' + escapeHtml(s.saas_name) + '" data-conn-id="' + escapeHtml(conn.id) + '">' + escapeHtml(t('saas_disconnect')) + '</button>';
          } else {
            html += '<div style="font-size:0.85rem;color:#888;margin-bottom:0.5rem;">' + escapeHtml(s.description || '') + '</div>';
            // Setup guide (collapsible) — 保存済みトグル状態を初期描画に反映
            var guideKey = 'saas_guide_' + s.saas_name;
            var guideTitleKey = guideKey + '_title';
            var guideText = t(guideKey);
            if (guideText && guideText !== guideKey) {
              var guideId = 'saas-guide-' + s.saas_name;
              var isGuideOpen = toggleStates[guideId] || false;
              html += '<button class="saas-guide-toggle' + (isGuideOpen ? ' open' : '') + '" onclick="toggleSaasGuide(\'' + guideId + '\', this)">';
              html += '<span class="chevron">&#9660;</span> ' + escapeHtml(t('saas_setup_guide'));
              html += '</button>';
              html += '<div class="saas-guide-body' + (isGuideOpen ? ' open' : '') + '" id="' + guideId + '">';
              html += '<div class="saas-guide-content">';
              html += '<strong>' + escapeHtml(t(guideTitleKey)) + '</strong>';
              html += guideText;
              html += '</div></div>';
            }
            // 保存済み設定の取得
            var sc = (savedConfigs || {})[s.saas_name];
            var hasConfig = sc && Object.keys(sc).length > 0;
            html += '<div class="saas-config-form" data-saas="' + escapeHtml(s.saas_name) + '">';
            html += '<label>Client ID</label>';
            html += '<input type="text" class="saas-client-id" placeholder="' + (hasConfig && sc.client_id ? escapeHtml(sc.client_id) : 'Client ID') + '" autocomplete="one-time-code">';
            html += '<label>Client Secret</label>';
            html += '<input type="password" class="saas-client-secret" placeholder="' + (hasConfig && sc.client_secret ? escapeHtml(sc.client_secret) : 'Client Secret') + '" autocomplete="one-time-code">';
            if (INSTANCE_URL_SAAS.indexOf(s.saas_name) >= 0) {
              html += '<label>' + escapeHtml(t('saas_instance_url')) + '</label>';
              html += '<input type="text" class="saas-instance-url" placeholder="' + (hasConfig && sc.instance_url ? escapeHtml(sc.instance_url) : escapeHtml(t('saas_instance_url_hint'))) + '">';
            }
            html += '<div style="margin-top:0.5rem;">';
            html += '<button class="saas-btn save" data-saas="' + escapeHtml(s.saas_name) + '">' + escapeHtml(t('saas_config_save')) + '</button>';
            html += '<button class="saas-btn connect" data-saas="' + escapeHtml(s.saas_name) + '"' + (hasConfig ? '' : ' style="display:none;"') + '>' + escapeHtml(t('saas_connect_oauth')) + '</button>';
            html += '</div>';
            html += '<div class="saas-card-msg" data-saas="' + escapeHtml(s.saas_name) + '"></div>';
            html += '</div>';
          }
          html += '</div>';
        });
        var _savedSaasInputs = _saveSaasInputs();
        saasContainerEl.innerHTML = html;
        _restoreSaasInputs(_savedSaasInputs);
        // ガイドのトグル状態を復元（ユーザーが明示的に開いたものだけ開く）
        restoreToggleStates();
        attachSaasHandlers();
      }

      function attachSaasHandlers() {
        // Save config
        document.querySelectorAll('.saas-config-form .saas-btn.save').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            var saas = btn.dataset.saas;
            var form = btn.closest('.saas-config-form');
            var clientId = form.querySelector('.saas-client-id').value.trim();
            var clientSecret = form.querySelector('.saas-client-secret').value.trim();
            var msgEl = saasContainerEl.querySelector('.saas-card-msg[data-saas="' + saas + '"]');
            if (!clientId || !clientSecret) { if (msgEl) { msgEl.textContent = t('saas_not_configured'); msgEl.style.color = '#c62828'; } return; }
            btn.disabled = true;
            var body = { client_id: clientId, client_secret: clientSecret };
            var instInput = form.querySelector('.saas-instance-url');
            if (instInput && instInput.value.trim()) body.instance_url = instInput.value.trim();
            try {
              var res = await apiFetch('/api/integrations/channel-config/' + saas, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
              });
              if (res.ok) {
                if (msgEl) { msgEl.textContent = t('saas_config_saved'); msgEl.style.color = '#2e7d32'; }
                var connectBtn = form.querySelector('.saas-btn.connect');
                if (connectBtn) connectBtn.style.display = '';
              } else {
                if (msgEl) { msgEl.textContent = 'Error'; msgEl.style.color = '#c62828'; }
              }
            } catch (e) {
              if (msgEl) { msgEl.textContent = e.message; msgEl.style.color = '#c62828'; }
            } finally { btn.disabled = false; }
          });
        });

        // OAuth connect
        document.querySelectorAll('.saas-config-form .saas-btn.connect').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            var saas = btn.dataset.saas;
            var form = btn.closest('.saas-config-form');
            var msgEl = saasContainerEl.querySelector('.saas-card-msg[data-saas="' + saas + '"]');
            btn.disabled = true;
            btn.textContent = t('saas_connecting');
            try {
              // 1. Create connection record
              var instInput = form.querySelector('.saas-instance-url');
              var connBody = { saas_name: saas };
              if (instInput && instInput.value.trim()) connBody.instance_url = instInput.value.trim();
              await apiFetch('/api/saas/connections', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(connBody)
              });
              // 2. Start OAuth
              var oauthRes = await apiFetch('/api/oauth/saas/' + saas + '/pre-authorize', { method: 'POST' });
              if (oauthRes.ok) {
                var oauthData = await oauthRes.json();
                window.location.href = oauthData.authorize_url;
              } else {
                var err = await oauthRes.json().catch(function() { return {}; });
                if (msgEl) { msgEl.textContent = err.detail || 'OAuth error'; msgEl.style.color = '#c62828'; }
                btn.disabled = false;
                btn.textContent = t('saas_connect_oauth');
              }
            } catch (e) {
              if (msgEl) { msgEl.textContent = e.message; msgEl.style.color = '#c62828'; }
              btn.disabled = false;
              btn.textContent = t('saas_connect_oauth');
            }
          });
        });

        // Disconnect
        document.querySelectorAll('.saas-btn.disconnect').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            var connId = btn.dataset.connId;
            var saas = btn.dataset.saas;
            if (!confirm(saas + ' ' + t('saas_disconnect') + '?')) return;
            btn.disabled = true;
            try {
              await apiFetch('/api/saas/connections/' + connId, { method: 'DELETE' });
              loadSaasConnections();
              loadBpoConnections();
            } catch (e) {}
          });
        });
      }

      // ===== Init =====
      initLangSelectors();
      applyI18n();
      initAuth();
    })();
  </script>
</body>
</html>
