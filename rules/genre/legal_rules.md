# 法務（Legal）専門ルール

## ドメイン概要

法務エージェントは、契約書の作成・管理・承認フロー、稟議、コンプライアンスチェックを管理するシステムである。契約期限の管理、電子署名連携、リーガルリスクの可視化を実現する。

---

## 必須エンティティ

| エンティティ | 説明 | 必須フィールド例 |
|---|---|---|
| **Contract（契約）** | 契約書 | title, counterparty, contract_type, start_date, end_date, status, pdf_url |
| **Approval（稟議）** | 承認フロー | contract_id, requester, approvers(JSONB), current_step, status |
| **ApprovalStep（承認ステップ）** | 各承認者の判断 | approval_id, approver_id, action(承認/却下/差戻し), comment, decided_at |
| **Clause（条項）** | 契約条項 | contract_id, clause_number, title, content, risk_level |
| **Reminder（期限リマインダー）** | 更新・解約期限通知 | contract_id, remind_date, type(更新/解約/その他), notified |

---

## ビジネスルール（Spec Agent / Coder Agent 共通）

### 契約管理

1. **契約ステータス**: 草案 → 承認中 → 締結済 → 有効 → 期限切れ / 解約
2. **自動更新判定**: end_date の 60日前にリマインダーを生成。自動更新条項がある場合は明示表示
3. **契約種別**: NDA / 業務委託 / 売買 / ライセンス / 雇用 等をマスタ管理
4. **バージョン管理**: 契約書の修正は版管理（v1, v2, v3...）。過去版は閲覧のみ可

### 承認フロー（稟議）

1. **多段階承認**: 契約金額に応じた承認ルートを設定
   - 100万未満: 部長承認のみ
   - 100万以上500万未満: 部長 → 本部長
   - 500万以上: 部長 → 本部長 → 代表取締役
2. **ステータス遷移**: 申請 → (各承認者が順に判断) → 最終承認 / 却下 / 差戻し
3. **差戻し**: 任意のステップから申請者に戻す。修正後は最初のステップから再承認

### リーガルリスク

- 各条項にリスクレベル（高/中/低）を設定可能
- 高リスク条項が含まれる契約にはアラートバッジを表示
- NDA 未締結の取引先との契約開始時に警告

---

## 受入条件テンプレート

- [ ] 契約書を新規作成し、PDF をアップロードできる
- [ ] 承認フロー（稟議）を起票し、多段階承認が順に進む
- [ ] 承認者が却下した場合、申請者に差戻しされる
- [ ] 契約期限の 60日前にリマインダーが表示される
- [ ] 契約一覧を種別・ステータスでフィルタリングできる
- [ ] 契約書の版管理で過去バージョンを閲覧できる

---

## Coder 向け実装指針

- 承認フローは `legal_approvals` + `legal_approval_steps` の2テーブル構成
- 承認ルート（金額条件→承認者リスト）は `legal_approval_routes` マスタで管理
- PDF ファイルは Supabase Storage に保存し、URL を `pdf_url` に記録
- 期限リマインダーは cron ジョブまたは Edge Function で日次チェック
- 契約検索は全文検索（タイトル + 取引先名 + 条項内容）対応
