# CRM（顧客管理）専門ルール

## ドメイン概要

CRM（Customer Relationship Management）は、受注後の顧客との継続的な関係管理を中心に、顧客情報の一元管理・対応履歴の蓄積・顧客分析を行うシステムである。

---

## 必須エンティティ

| エンティティ | 説明 | 必須フィールド例 |
|---|---|---|
| **Customer（顧客）** | 顧客企業/個人 | name, email, phone, segment, status, assigned_to |
| **Contact（担当者）** | 顧客側の担当者 | customer_id, name, role, email, phone |
| **Interaction（対応履歴）** | 顧客との接点記録 | customer_id, type(電話/メール/訪問/チャット), summary, interaction_date |
| **Ticket（問い合わせ）** | サポートチケット | customer_id, subject, description, priority, status |
| **Segment（セグメント）** | 顧客分類 | name, conditions(JSONB), description |

---

## ビジネスルール（Spec Agent / Coder Agent 共通）

### 顧客ライフサイクル

1. **ステータス遷移**: 見込み → 新規 → アクティブ → 休眠 → 解約
2. **休眠判定**: 最終 Interaction から 90日経過で自動的に「休眠」候補としてアラート
3. **解約防止**: 休眠顧客へのフォローアップリマインダーを自動生成

### 顧客セグメンテーション

- **ランク分類**: A（年間取引額 1,000万以上）/ B（500万以上）/ C（100万以上）/ D（それ以下）
- ランクは取引実績から自動算出し、手動オーバーライドも可能
- セグメントに基づいたフォローアップ頻度の推奨（A: 月1, B: 隔月, C: 四半期, D: 半年）

### 対応履歴

- 全ての顧客接点（電話・メール・訪問・チャット）を時系列で記録
- 対応履歴にはタグ付け可能（クレーム、契約更新、アップセル等）
- 顧客詳細画面でタイムライン表示

### LTV（顧客生涯価値）

- LTV = 平均月次取引額 × 平均契約継続月数
- ダッシュボードにセグメント別 LTV を表示

---

## 受入条件テンプレート

- [ ] 顧客を新規登録し、担当者を紐づけられる
- [ ] 対応履歴を時系列で記録・閲覧できる
- [ ] 顧客一覧をセグメント（A/B/C/D）でフィルタリングできる
- [ ] 休眠顧客（90日未接触）がアラート表示される
- [ ] 問い合わせチケットを起票し、ステータス管理（新規→対応中→解決済）できる
- [ ] 顧客詳細画面にタイムライン（対応履歴+チケット）が表示される

---

## Coder 向け実装指針

- 顧客検索は全文検索（Supabase の `to_tsvector`）を活用
- タイムラインは `crm_interactions` と `crm_tickets` を UNION して日付順で取得
- セグメントのランク自動算出は DB 関数または Server Action で実装
- 顧客一覧はページネーション必須（デフォルト 20件/ページ）
