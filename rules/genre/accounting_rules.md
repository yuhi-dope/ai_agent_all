# 会計（Accounting）専門ルール

## ドメイン概要

会計エージェントは、請求書発行・仕訳記帳・経費精算・財務レポート（PL/BS/CF）を管理するシステムである。中小企業の経理業務をAIで自動化し、freee・マネーフォワード等の外部連携も想定する。

---

## 必須エンティティ

| エンティティ | 説明 | 必須フィールド例 |
|---|---|---|
| **Account（勘定科目）** | 勘定科目マスタ | code, name, type(資産/負債/純資産/収益/費用), parent_id |
| **Journal（仕訳）** | 仕訳伝票 | journal_date, description, status(下書き/確定/取消) |
| **JournalLine（仕訳明細）** | 仕訳の借方/貸方 | journal_id, account_id, debit_amount, credit_amount |
| **Invoice（請求書）** | 発行請求書 | customer_name, issue_date, due_date, items, total, status |
| **Expense（経費）** | 経費精算 | applicant, category, amount, receipt_url, status(申請/承認/却下) |

---

## ビジネスルール（Spec Agent / Coder Agent 共通）

### 複式簿記の原則（最重要）

1. **貸借一致**: 仕訳の借方合計 = 貸方合計は **絶対条件**。一致しない仕訳は保存不可
2. **仕訳明細**: 1仕訳に対し最低2行（借方1行 + 貸方1行）が必要
3. **勘定科目体系**: 資産(1xx) / 負債(2xx) / 純資産(3xx) / 収益(4xx) / 費用(5xx) のコード体系
4. **確定後の変更不可**: 確定済み仕訳の修正は「取消仕訳（赤伝）」+ 新規仕訳で行う

### 請求書

- ステータス: 下書き → 発行済 → 入金済 / 督促中 / 取消
- 明細行（line_items）: 品目・数量・単価・税率・小計
- 消費税計算: 税率 10% / 8%（軽減税率）を明細行単位で指定
- 発行番号は自動採番（年度 + 連番: e.g., INV-2026-0001）
- PDF 出力対応構造

### 経費精算

- 承認フロー: 申請者 → 上長承認 → 経理確認
- 領収書画像の添付必須（receipt_url）
- カテゴリ別集計（交通費、交際費、消耗品費等）

### 財務レポート

- **PL（損益計算書）**: 収益勘定と費用勘定の期間合計
- **BS（貸借対照表）**: 資産・負債・純資産の残高
- 月次・四半期・年次で出力可能

---

## 受入条件テンプレート

- [ ] 仕訳を作成し、借方・貸方の金額が一致しないと保存できない
- [ ] 勘定科目マスタから科目を選択して仕訳明細を登録できる
- [ ] 確定済み仕訳は直接編集できない（取消仕訳が必要）
- [ ] 請求書を作成し、消費税（10%/8%）が自動計算される
- [ ] 経費を申請し、上長が承認/却下できる
- [ ] PL・BS レポートが月次で出力される

---

## Coder 向け実装指針

- 金額は `BIGINT`（整数・円単位）で保存。浮動小数点は使わない
- 仕訳保存時に DB トリガーまたは Server Action で貸借一致チェックを実装
- 勘定科目は階層構造（parent_id による木構造）。再帰クエリまたは materialized path で集計
- 請求番号の採番は `SELECT MAX + 1` ではなく `SEQUENCE` を使用してレースコンディション回避
- 消費税端数処理: 明細行ごとに切り捨て（`FLOOR`）
